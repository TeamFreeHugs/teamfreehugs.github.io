<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Inbox Reader</title>
<link rel="stylesheet" type="text/css" href="styles.css"></link>

<script>
	function getCode() {
		console.log(window.location.hash);
		var url = window.location.hash;
		var hash = url.substring(url.indexOf("#") + 1);
		return hash;
	}

	function readTextFile(file) {
		var rawFile = new XMLHttpRequest();
		rawFile.open("GET", file, false);
		rawFile.onreadystatechange = function() {
			if (rawFile.readyState === 4) {
				if (rawFile.status === 200 || rawFile.status == 0) {
					return rawFile.responseText;
				}
			}
		}
		rawFile.send(null);
		return rawFile.responseText;
	}

	function addItems(items) {
		var myNode = document.getElementById("body");
		while (myNode.firstChild) {
			myNode.removeChild(myNode.firstChild);
		}
		for (var item = 0; item < items.length; ++item) {
			var ele = items[item];
			var site = ele.site;
			var siteName = site.name;
			var siteImg = site.favicon_url;
			var title = ele.title;
			//Construct element now :)
			var element = document.createElement('div'), p = document
					.createElement('p'), link = document.createElement('a'), img = document
					.createElement('img');
			p.innerHTML = ele.item_type.replace('_', ' ');
			link.href = "#";
			link.onclick = "window.open(" + ele.link + ")";
			link.innerHTML = title;
			img.src = siteImg;
			element.appendChild(img);
			element.appendChild(p);
			element.appendChild(link);
			element.appendChild(document.createElement('hr'));
			var inbox = document.getElementById('inboxItems');
			inbox.appendChild(element);
		}
	}

	function prepareContent() {
		var header = document.getElementById('loadText');
		header.innerHTML = "Javascript detected, loading...";
		var code = getCode().substring(13);
		if (code === "") {
			window.location = 'https://stackexchange.com/oauth/dialog?client_id=5176&scope=read_inbox,no_expiry&redirect_uri=http://teamfreehugs.github.io/stackexchange/inboxreader';
		} else {
			header.innerHTML = "Your code is: <pre>" + code
					+ "</pre> Please wait for me to load your inbox!";
			var inboxContentURL = 'https://api.stackexchange.com/2.2/inbox?access_token='
					+ code + "&key=Wb06jBCijTyKIkKf8YzuSg((";
			var inboxJSON = readTextFile(inboxContentURL);
			var json = JSON.parse(inboxJSON);
			var items = json.items;
			var old = document.getElementById('loadText');
			console.log(old == null);
			old.parentElement.removeChild(old);
			window.setInterval(function() {
				addItems(items);
				var myNode = document.getElementById("body");
				while (myNode.firstChild) {
					myNode.removeChild(myNode.firstChild);
				}
			}, 300000);
		}
	}
</script>
</head>
<body onload="prepareContent();">
	<div id="inboxItems" class="round bottom"
		style="width: 1000px; height: 400px; margin: 0 auto;">
		<p id="loadText">Loading, please wait for content to load...</p>
	</div>
</body>
</html>