<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>StackExchange Question Packer</title>
<script src="http://teamfreehugs.github.io/js/markdown.js"></script>
<script src="http://teamfreehugs.github.io/js/URI.js"></script>
<link rel="stylesheet"
	href="http://teamfreehugs.github.io/styles/questionpacker.css"></link>
</head>
<body onload="go()">
	<script>
		function getCode(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex
					.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1]
					.replace(/\+/g, " "));
		}

		function readTextFile(file) {
			var rawFile = new XMLHttpRequest();
			rawFile.open("GET", file, false);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4) {
					if (rawFile.status === 200 || rawFile.status == 0) {
						return rawFile.responseText;
					}
				}
			}
			rawFile.send(null);
			return rawFile.responseText;
		}

		function go() {
			if (getCode('question') == "") {
				var text = document.createElement('h2');
				text.innerHTML = "Sorry, there is no question specified";
				var text2 = document.createElement('p');
				text2.innerHTML = "Please specify one by using '<code>question=</code> in the URL";
				text.id = "load";
				document.body.appendChild(text);
				document.body.appendChild(text2);
			} else if (getCode('site') == "") {
				var text = document.createElement('h2');
				text.innerHTML = "Sorry, there is no site specified";
				var text2 = document.createElement('p');
				text2.innerHTML = "Please specify one by using '<code>site=</code> in the URL";
				text.id = "load";
				document.body.appendChild(text);
				document.body.appendChild(text2);
			} else {
				var text = document.createElement('h2');
				text.innerHTML = "Loading...";
				text.id = "load";
				document.body.appendChild(text);
				var questionLink = getCode('question');
				var linkToAPI = 'https://api.stackexchange.com/2.2/questions/'
						+ questionLink + '?site=' + getCode('site');
				console.log(linkToAPI);
				var result = JSON.parse(readTextFile(linkToAPI));
				if (result.items.length === 0) {
					document.getElementById('load').innerHTML = "Sorry, that's an invalid question";
				} else {
					var question = result.items[0];
					var site = new URI(question.link).authority.substring(0,
							new URI(question.link).authority.length - 4);
					var image = 'http://cdn.sstatic.net/' + site
							+ '/img/favicon.ico';
					console.log(site);
					var contentDiv = document.getElementById('content');
					text.parentElement.removeChild(text);
					var title = document.createElement('a');
					var titleWrap = document.createElement('h3');
					title.innerHTML = question.title;
					title.href = question.link;
					title.target = "_blank";
					title.className = "niceText";
					titleWrap.appendChild(title);
					contentDiv.appendChild(titleWrap);
					var askerDiv = document.createElement('div');
					if (question.owner.user_type == "registered") {
						askerDiv.className = "userDivRegistered";
					} else {
						askerDiv.className = "userDivUnregistered";
					}
					var askerImgDiv = document.createElement('div');
					var askerImg = document.createElement('img');
					
					var askerNameDiv = document.createElement('div');
					var askerName = document.createElement('span');
					
					var askerRepDiv = document.createElement('div');
					var askerRep = document.createElement('span');
					
					askerImg.src = question.owner.profile_image;
					askerImg.className = "userImage";
					askerImgDiv.appendChild(askerImg);
					askerImgDiv.className = "inline";
					
					askerName.innerHTML = question.owner.display_name;
					askerRep.innerHTML = question.owner.reputation;
					askerNameDiv.className = "inline";
					//askerRepDiv.className = "inline";
					askerDiv.appendChild(askerImgDiv);
					askerNameDiv.appendChild(askerName);
					askerRepDiv.appendChild(askerRep);
					askerDiv.appendChild(askerNameDiv);
					askerDiv.appendChild(askerRepDiv);
					contentDiv.appendChild(askerDiv);
				}
			}
		}
	</script>
	<div id="content"></div>
</body>
</html>