<!DOCTYPE html>
<html>
<head>
<meta charset="ISO-8859-1">
<title>StackExchange Question Packer</title>
<script src="http://teamfreehugs.github.io/js/markdown.js"></script>
<script src="http://teamfreehugs.github.io/js/URI.js"></script>
<link rel="stylesheet"
	href="http://teamfreehugs.github.io/styles/questionpacker.css"></link>
</head>
<body onload="go()">
	<script>
		function getCode(name) {
			name = name.replace(/[\[]/, "\\[").replace(/[\]]/, "\\]");
			var regex = new RegExp("[\\?&]" + name + "=([^&#]*)"), results = regex
					.exec(location.search);
			return results === null ? "" : decodeURIComponent(results[1]
					.replace(/\+/g, " "));
		}

		function readTextFile(file) {
			var rawFile = new XMLHttpRequest();
			rawFile.open("GET", file, false);
			rawFile.onreadystatechange = function() {
				if (rawFile.readyState === 4) {
					if (rawFile.status === 200 || rawFile.status == 0) {
						return rawFile.responseText;
					}
				}
			}
			rawFile.send(null);
			return rawFile.responseText;
		}

		function imageExists(image_url) {

			var http = new XMLHttpRequest();

			http.open('HEAD', image_url, false);
			http.send();

			return http.status != 404;

		}

		function generateAvatar(owner) {
			var askerDiv = document.createElement('div');
			if (owner.user_type == "registered") {
				askerDiv.className = "userDivRegistered";
			} else {
				askerDiv.className = "userDivUnregistered";
			}
			var askerImg = document.createElement('img');

			var askerNameDiv = document.createElement('div');
			var askerName = document.createElement('a');

			var askerRepDiv = document.createElement('div');
			var askerRep = document.createElement('span');

			var askerInfoDiv = document.createElement('div');

			askerInfoDiv.className = "inline";

			if (owner.profile_image != undefined) {
				askerImg.src = owner.profile_image;
			} else {
				askerImg.src = "http://imgur.com/UoyazgJ.png";
			}
			askerImg.className = "userImage";

			askerName.innerHTML = owner.display_name;
			if (owner.link != undefined) {
				askerName.href = owner.link;
				askerName.className = "niceText";
			}
			askerName.target = "_blank";
			askerNameDiv.appendChild(askerName);
			askerNameDiv.className = "inline userInfo";

			if (owner.reputation != undefined) {
				askerRep.innerHTML = owner.reputation;
			} else {
				askerRep.innerHTML = "0";
			}
			askerRep.className = "niceText";
			askerRepDiv.appendChild(askerRep);
			askerRepDiv.className = "inline userInfo";

			askerDiv.appendChild(askerImg);

			askerInfoDiv.appendChild(askerNameDiv);
			askerInfoDiv.appendChild(document.createElement('br'));
			askerInfoDiv.appendChild(askerRepDiv);
			askerInfoDiv.className = "inline avatarText";

			askerDiv.appendChild(askerInfoDiv);
			return askerDiv;
		}

		function go() {
			if (getCode('question') == "") {
				var text = document.createElement('h2');
				text.innerHTML = "Sorry, there is no question specified";
				var text2 = document.createElement('p');
				text2.innerHTML = "Please specify one by using <code>question=</code> in the URL";
				text.id = "load";
				document.body.appendChild(text);
				document.body.appendChild(text2);
			} else if (getCode('site') == "") {
				var text = document.createElement('h2');
				text.innerHTML = "Sorry, there is no site specified";
				var text2 = document.createElement('p');
				text2.innerHTML = "Please specify one by using <code>site=</code> in the URL";
				text.id = "load";
				document.body.appendChild(text);
				document.body.appendChild(text2);
			} else {
				var text = document.createElement('h2');
				text.innerHTML = "Loading...";
				text.id = "load";
				document.body.appendChild(text);
				var questionLink = getCode('question');
				var linkToAPI = 'https://api.stackexchange.com/2.2/questions/'
						+ questionLink + '?site=' + getCode('site')
						+ '&filter=!9YdnSJ*_S';
				console.log(linkToAPI);
				var result = JSON.parse(readTextFile(linkToAPI));
				if (result.items.length === 0) {
					document.getElementById('load').innerHTML = "Sorry, that's an invalid question";
				} else {
					var question = result.items[0];
					var site = new URI(question.link).authority.substring(0,
							new URI(question.link).authority.length - 4);
					var image = 'http://cdn.sstatic.net/' + site
							+ '/img/favicon.ico';
					console.log(site);
					var contentDiv = document.getElementById('content');
					{
						//Title
						text.parentElement.removeChild(text);
						var title = document.createElement('a');
						var titleWrap = document.createElement('h3');
						title.innerHTML = question.title;
						title.href = question.link;
						title.target = "_blank";
						title.className = "niceText";
						titleWrap.appendChild(title);
						contentDiv.appendChild(titleWrap);
						contentDiv.appendChild(document.createElement('hr'));
					}
					{
						//Question
						var body = question.body;
						var questionBody = document.createElement('div');
						questionBody.innerHTML = body;
						questionBody.className = "postContent";

						var scoreSpan = document.createElement('span');
						var details = document.createElement('div');

						var score = question.score;

						scoreSpan.innerHTML = 'Score: ' + score;
						scoreSpan.className = "postDetails niceText";
						details.appendChild(scoreSpan);
						contentDiv.appendChild(details);
						contentDiv.appendChild(document.createElement('hr'));
						contentDiv.appendChild(questionBody);
					}
					{
						//Avatar
						var questionAvatar = generateAvatar(question.owner);
						contentDiv.appendChild(questionAvatar);
					}
					{
						//Generate answers
						var linkToAPI = 'https://api.stackexchange.com/2.2/questions/'
								+ questionLink
								+ '/answers?site='
								+ getCode('site') + '&filter=!b0OfNR*h33*3.3';
						var result = JSON.parse(readTextFile(linkToAPI));
						var answers = result.items;
						var answerCount = document.createElement('h4');
						answerCount.innerHTML = 'There are ' + answers.length
								+ ' answers';
						answerCount.className = "postDetails niceText";

						contentDiv.appendChild(document.createElement('hr'));

						contentDiv.appendChild(answerCount);

						for (var i = 0; i < answers.length; ++i) {
							var answer = answers[i];
							var avatar = generateAvatar(answer.owner);
							contentDiv
									.appendChild(document.createElement('hr'));

							var answerDiv = document.createElement('div');
							var details = document.createElement('div');
							var content = document.createElement('div');

							var links = document.createElement('div');
							var link = document.createElement('a');

							var scoreSpan = document.createElement('span');
							var acceptedSpan = document.createElement('span');

							var accepted = answer.is_accepted;
							var score = answer.score;
							var body = answer.body;

							console.log(accepted);
							
							content.innerHTML = body;
							content.className = "postContent";

							link.innerHTML = "link";
							link.href = answer.link;
							link.target = "_blank";
							link.className = "niceText";
							links.appendChild(link);

							scoreSpan.innerHTML = 'Score: ' + score;
							scoreSpan.className = "postDetails niceText";
							details.appendChild(scoreSpan);

							if (accepted) {
								acceptedSpan.innerHTML = " | Accepted";
								var acceptedIcon = document
										.createElement('img');
								acceptedIcon.src = "";
								details.appendChild(acceptdSpan);
							}

							answerDiv.appendChild(details);
							answerDiv.appendChild(content);
							answerDiv.appendChild(links);
							answerDiv.appendChild(avatar);
							contentDiv.appendChild(answerDiv);
						}
					}

					var preCodes = document.getElementsByTagName('pre');
					for (var i = 0; i < preCodes.length; ++i) {
						var entry = preCodes[i];
						var innerHTML = entry.innerHTML.substring(6,
								entry.innerHTML.length - 7);
						entry.innerHTML = innerHTML;
						entry.className = "prettyprint code";
						entry.style = "width: 700px;";
					}
					load();
					console.log('Done!');
					contentDiv.className = "content";
				}
			}
		}
	</script>
	<div id="content"></div>
</body>
</html>