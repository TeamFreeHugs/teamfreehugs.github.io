function handleQuoteMessage(e){var t=$.trim(e),s=t.match(/^&gt;\s+(.*)$/);if(s){var n=$("<div/>").addClass("quote").html(s[1]);return $("<p/>").append(n).html()}if(/^<div[^>]*?>&gt;/i.test(t)){var i=$(t);if(i.hasClass("partial")||i.hasClass("full")){i[0].normalize();for(var a=i[0].childNodes,o=!0,r=!1,l=!1,d=0;d<a.length;d++){var c=a[d];if(3===c.nodeType&&/\S/.test(c.nodeValue)){var u=/^\s*>\s/.test(c.nodeValue);o||(r|=u,l|=!u),o=!1,u&&(c.nodeValue=c.nodeValue.replace(/^\s*>\s+/,""))}}if(!l||!r)return i.addClass("quote")[0].outerHTML}}return e}function popUp(e,t,s,n){n||$(".popup").remove();var i={},a=e-$(window).scrollLeft(),o=t-$(window).scrollTop();a<$(window).width()/2?i.left=a:i.right=$(window).width()-a,o<$(window).height()/2?i.top=o:i.bottom=$(window).height()-o;var r=div("popup").css(i).hide(),l=$("<div class='btn-close'>X</div>");return l.click(function(){$(this).closest(".popup").fadeOut(200,function(){$(this).remove()})}).prependTo(r),r.appendTo(s||$("body")).fadeIn(200),r.close=function(){r.fadeOut(200,function(){r.remove()})},r}function popupDismisser(){$(document).click(function(e){0==$(e.target).closest(".popup").length&&0==$(e.target).closest(".ac_results").length&&$(".popup:not(.mini-help)").fadeOut(200,function(){$(this).remove()})}),$(document).bind($.browser.opera?"keypress":"keydown",function(e){27==e.which&&$(".popup:not(.mini-help)").fadeOut(200,function(){$(this).remove()})})}function fkey(e){return e||(e={}),e.fkey||(e.fkey=$("input[name='fkey']").attr("value")),e}function repNumber(e){if(1e4>e)return e;if(1e5>e){var t=Math.floor(Math.round(e/100)/10),s=Math.round((e-1e3*t)/100);return t+(s>0?"."+s:"")+"k"}return Math.round(e/1e3)+"k"}function htmlEncode(e){return document.createElement("div").appendChild(document.createTextNode(e)).parentNode.innerHTML}function selectStackSite(e,t,s,n,i,a){var o=popUp(e.pageX,e.pageY,i,a).css({"width":"auto","position":"absolute"}),r=$("<p/>").text("Loading available sites...");o.append(r);var l=s?{}:{"sort":"site"},d=function(e){if(e&&e.length){r.text("select a site:");var t=$('<input type="text"/>').appendTo(o);t.autocomplete(e,{"minChars":0,"width":310,"matchContains":"word","autoFill":!1,"formatItem":function(e){return'<img src="'+e.SiteIcon+'"/> '+htmlEncode(e.SiteCaption)},"formatMatch":function(e){return htmlEncode(e.SiteCaption+" "+e.Host)},"formatResult":function(e){return e.Host}}).result(function(e,t){t&&(o.close(),n(t.Host,t.SiteCaption,t.SiteIcon))}).focus()}else r.text("(no sites found)")};t?$.post("/users/sites/"+t,l,d):$.get("/rooms/sites",d)}function PERMALINK(e){return"/transcript/message/"+e+"#"+e}function div(e){return $("<div/>").addClass(e)}function span(e){return $("<span/>").addClass(e)}function confirmFlag(e){return confirm("Do you want to flag this message as spam, inappropriate, or offensive?"+(e?" Since you're a moderator, this flag is binding.":""))}function messageActionById(e,t,s,n,i){s||(s={}),$.ajax({"type":"POST","url":"/messages/"+e+"/"+t,"data":fkey(s),"success":function(e){n?n(e):"ok"!=e&&i&&i(e||GENERIC_ERROR)},"dataType":"json","error":function(e,t){var s="error"==t?409==e.status?e.responseText:GENERIC_ERROR:t;n?n(s):i&&i(s)}})}function Notifier(e,t){function s(t,s){"string"!=typeof t&&(t=t.text()),(void 0==s||s)&&e.broadcast({"command":"dismiss notification","notification":t});var n=$(".notification").not(".closing");n.find("p.notification-message").not(".dismissed").each(function(){$(this).text()==t&&$(this).addClass("dismissed").slideUp(function(){$(this).remove()})}),n.find("p.notification-message").not(".dismissed").length||n.slideUp(function(){$(this).remove()})}function n(n,i){var a=$(".notification").not(".closing"),o=!0;if(0==a.length){o=!1,a=div("notification").hide().appendTo("body");var r=$("<div/>").addClass("notify-close-info").text(t?"Ok":"click here to remove the notification bar").appendTo(a).click(function(){if(t){a.find("p.notification-message:last").remove();var s=a.find("p.notification-message").length;0===s?a.remove():$(this).text("Ok"+(s>1?" ("+s+")":""))}else a.find("p.notification-message").not(".dismissed").each(function(){e.broadcast({"command":"dismiss notification","notification":$(this).text()})}),a.addClass("closing").slideUp(function(){$(this).remove()})});t&&(r.addClass("button"),a.css("top",$(window).scrollTop()+$(window).height()/20))}else if(lastmsg=a.find("p.notification-message:"+(t?"first":"last")),lastmsg.html()==$("<span />").html(n).html())return lastmsg;var l=$("<p/>").addClass("notification-message").html(n).hide();if(t?l.prependTo(a):l.insertBefore(a.find(".notify-close-info")),i&&i.length>0&&l.addClass(i),o){if(l.slideDown(),t){var d=a.find("p.notification-message").length;a.find(".notify-close-info").text("Ok"+(d>1?" ("+d+")":""))}}else l.show(),a.slideDown();return l.find("a").click(function(){s($(this).closest(".notification-message"))}),l}function i(e){e.close(),l=Generator(l).filter(function(t){return t!==e}).toArray()}function a(){Generator(l).forEach(function(e){e.close()}),l=[]}function o(e,t){l.push(e),e.onclick=function(){window.focus()},t&&setTimeout(function(){i(e)},t)}e||(e={"broadcast":function(){}});var r=null;if(window.Notification&&"permission"in Notification){var l=[];r=function(e){if(e&&e.text){if("granted"!==window.Notification.permission)return!1;e.icon&&e.icon.length||(e.icon=$('link[rel="apple-touch-icon"]').attr("href")),e.icon&&e.icon.length||(e.icon=$('link[rel="shortcut icon"]').attr("href"));var t=new Notification(e.title,{"body":e.text,"icon":e.icon});return t?(o(t,e.timeout),!0):!1}return"granted"===window.Notification.permission?(e&&e.callback&&e.callback(),!0):e&&e.callback?(window.Notification.requestPermission(e.callback),!1):!1},r.removeAll=a}return{"notify":n,"dismissSingleNotification":s,"desktop":r}}function initSearchBox(){var e=$("#searchbox"),t="search";e.focus(function(){$(this).val()==t&&$(this).val(""),e.removeClass("watermark")}),e.blur(function(){""==$(this).val()&&($(this).val(t),e.addClass("watermark"))});var s=e.val();(""===s||s===t)&&(e.val(t),e.addClass("watermark")),e.closest("form").on("submit",function(){setTimeout(function(){e.val(t).addClass("watermark").blur()},0)})}function BindFlagListPopup(e,t,s,n,i){function a(e){return function(){e.find(".ajax-loader").remove(),e.closest("li").find("button:contains('delete')").replaceWith("<span>message deleted</span>")}}function o(e,t){return function(){confirm("Delete this message?")&&($("<img class='ajax-loader' src='"+IMAGE("progress-dots.gif")+"' />").appendTo(t),messageActionById(e,"delete",null,a(t),n))}}function r(e,n){n.find("img.ajax-loader").remove(),n.find("h3").text(-1!=t.indexOf("moderator")?"Moderator flags":"New spam/offensive flags").append(" <a href='"+s+"'>show all</a>");var a=$("<ul />").appendTo(n);if(!e.messages||!e.messages.length)return $("<div>There are no flags to display.</div>").appendTo(n),i&&i(),void 0;for(var r=0;r<e.messages.length;r++){var l=e.messages[r],d=!l.is_mod,c=d?"as spam/offensive":"for moderator attention",u=$("<li class='flagged-message' />").data("message_id",l.message_id).appendTo(a);$("<h4>This message was flagged "+c+" by "+l.flag_count+" user"+(l.flag_count>1?"s":"")+":</h4>").appendTo(u),$("<div class='content'/>").appendTo(u).html(l.content);var h;if(h=l.deleted?" message is deleted &ndash; <a class='room-name' href='/messages/"+l.message_id+"/history'>history</a>":"<a class='room-name' href='"+PERMALINK(l.message_id)+"'>see in context</a>",$("<div style='text-align:right'> posted by <a href='/users/"+l.user_id+"'></a> "+(l.time?ToRelativeTimeMini(l.time):"")+" &ndash; "+h+"</div>").appendTo(u).find("a:first").text(l.username).end().find("a.room-name").removeClass("room-name").text(l.room_name),d){var m=$("<div />");if(m.append("<button class='button reflag' title='agree that this message is spam or offensive'>valid</button> "),m.append("<button class='button counterflag' title='this message is neither spam nor offensive'>invalid</button> "),m.append("<button class='button mehflag' title='no strong opinion'>not sure</button> "),m.appendTo(u),l.modflags&&l.modflags.length)for(var f=$("<p>(&#9830; only) flagged by</p>").appendTo(u),p=0;p<l.modflags.length;p++){var g=l.modflags[p];f.append(0==p?": ":", ").append($("<a href='/users/"+g.user_id+"'></a>").text(g.username))}}else{var v=$("<ul />").appendTo(u);l.deleted||$("<button class='button' title='delete this message'>delete</button>").click(o(l.message_id,v)).appendTo(u.find("div:last").append("<span> &ndash; </span>"));for(var p=0;p<l.modflags.length;p++){var g=l.modflags[p],y=$("<span> &ndash; <a href='/users/"+g.user_id+"'></a></span>");y.find("a").text(g.username);var _=$('<span title="dismiss this moderator flag" class="quick-unmod btn-delete"> </span>'),w=$("<span class='mod-text' />");g.html?w.html(g.html):w.text(g.text);var b;b=g.user_id>0?$("<span><input type='checkbox' name='noise'/> this flag is noise</span>").find("input").css({"marginLeft":10,"verticalAlign":"bottom"}).end().attr("title","If this box is checked, dismissing the flag will show a notification to the flagger that moderator flags are reserved for serious issues."):$([]),v.append($("<li />").append(_,w,y,b).data("flag_id",g.flag_id))}}}}$(e).click(function(e){e.stopPropagation(),e.preventDefault();var s=popUp(e.pageX,e.pageY).css({"width":"auto","maxWidth":600,"minWidth":300}).addClass("flags-popup").append("<h3>Loading flags <img class='ajax-loader' src='"+IMAGE("progress-dots.gif")+"' /></h3>");$.getJSON(t,function(e){r(e,s)})})}function noDiac(e){e.match(/^[ÆÆœÇÉ…ÉÉ’É¥É¯É°É¹ÉºÉ»Ê‡ÊŒÊÊŽÊžÊ®Ê¯Ê´ÊµÊ»Ì’á´‚á´ˆá´‰á´”á´šá´Ÿáµ„áµ†áµŒáµŽáµšáµ·á¶›á¶£á¶­á¶ºâ…Ž]+$/)&&(e=e.split("").reverse().join(""));for(var t in diacSubstitutions)e=e.replace(new RegExp("["+t+"]","g"),diacSubstitutions[t]);return e}function urlFriendly(e){return e=noDiac(e.toLowerCase()),e=e.replace(/[\s,.\/\\_-]+/g,"-"),e=e.replace(/[^0-9a-z-]/g,""),e=e.replace(/^-/,"").replace(/--+/g,"-").substring(0,80).replace(/-$/,"")}function InterClientCommunicator(){function e(e){return function(t,s){e({"sender":s.sender,"time":s.time,"content":t,"senderIsSenior":i.id.localeCompare(s.sender)>0})}}function t(e){i.broadcast(e)}function s(t){i.onReceive(e(t))}function n(){try{var e=localStorage["chat:icc"];if(!e)return;var t={"reset":1},s=JSON.parse(localStorage["chat:icc"]);if(1===s.length&&"0000000000000"===s[0].sender)return;for(var n=0;n<s.length;n++){var i=s[n];"poll"===i.content.command&&i.content.data&&Generator(i.content.data).map("0").forEach(function(e){/^[rh]\d+$/.test(e)&&(t[e]={})})}localStorage["chat:icc"]=JSON.stringify([{"sender":"0000000000000","time":(new Date).getTime(),"content":{"command":"poll","data":t,"since":1,"until":999999999999}}])}catch(a){}}var i=Messenger("chat:icc2");return n(),{"broadcast":t,"receive":s,"id":i.id}}function FeedTicker(){function e(){s=null,i.find(".ticker-item").slice(a).slideUp(function(){$(this).remove()}),n.slideDown(),i.find(".ticker-item").slice(0,a).slideDown()}function t(t){$(t).hide().prependTo(i),s&&window.clearTimeout(s),s=window.setTimeout(e,1e3)}var s,n=$("#feed-ticker"),i=$("#ticker-items"),a=8;return $("#dismiss-ticker").click(function(){i.find(".ticker-item").addClass("dismissed"),n.slideUp(function(){$(this).find(".ticker-item.dismissed").remove()})}),{"add":t}}function Container(){var e=$([]);return{"put":function(t){e=e.add(t)},"withAll":function(t){e.each(t)},"withAllButTakeYourTime":function(t){var s=e.length;e.each(function(e,n){window.setTimeout(function(){t.call(n)},100*(s-e))})},"pull":function(t){e=e.not(t)},"spill":function(){e=$([])}}}function DelayedReaction(e,t,s){s=s||{};var n,i,a,o=s.always,r=function(){n=null;var t=a;a=null,e.apply(null,i),t&&t.resolve()};return{"trigger":function(){return i=arguments,o&&o.apply(null,i),n?s.sliding&&(clearTimeout(n),n=setTimeout(r,t)):n=setTimeout(r,t),a=a||$.Deferred(),a.promise()},"cancel":function(){if(n&&(clearTimeout(n),n=null),a){var e=a;a=null,e.reject()}}}}function GoodGetter(e,t){function s(){i&&(i.reject(),i=null,n=null)}var n,i,a={},o={},r=DelayedReaction(function(t){var s="c_"+t;o[s]=i,i=null,$.get(t).done(function(t){a[s]=t,setTimeout(function(){delete a[s]},e);var i=o[s];delete o[s],n===s?(i.resolve(t),n=null):i.reject()}).fail(function(){var e=o[s];delete o[s],e.reject()})},t,{"sliding":!0}),l=function(e){var t="c_"+e;return t in a?$.Deferred().resolve(a[t]).promise():i&&t===n?i.promise():t in o?o[t].promise():(s(),n=t,i=$.Deferred(),r.trigger(e),i.promise())};return l.cancel=s,l}function userContainer(e){var t=$("<div/>").addClass("user-container user-"+e);return e&&CHAT.RoomUsers.updateUserContainer(t.data("user",e)),t}function legalImgurSizeAtLeast(e){for(var t=legalImgurSizes.length,s=0;t>s;s++)if(legalImgurSizes[s]>=e)return legalImgurSizes[s];return legalImgurSizes[t-1]}function gravatarUrl(e,t,s){if("!"==t.charAt(0)){var n=t.substr(1);if(imgurProfileImage.test(n)){var i=/\?/.test(n)?"&":"?";n+=i+"g&s="+legalImgurSizeAtLeast(s)}return n}return"//www.gravatar.com/avatar/"+t+"?s="+s.toString()+"&d=identicon&r=PG"}function lineBreakBeforeHyphen(e){return $("<span />").text(e).html().replace(/([^\s-])-([^\s-])/g,"$1&#8203;&#8209;$2")}function lineBreakAfterHyphen(e){return $("<span />").text(e).html().replace(/([^\s-])-([^\s-])/g,"$1&#8208;$2")}function normalizeUserName(e){return noDiac(e.toLowerCase()).replace(/\s/g,"")}function Sidebar(e,t,s,n,i,a,o,r,l){function d(){$("#my-rooms > li").each(function(){var e=$(this).find(".room-info > .last-message > .time").html(),t=secondsSince(e),s=Math.min(6,Math.max(0,Math.floor(Math.log(t/15)||0))),n=$(this).prop("className").split(" "),i=["activity-"+s];for(var a in n){var o=n[a];""!=o&&"activity-"!=o.substr(0,9)&&i.push(o)}$(this).prop("className",i.join(" ")),$.browser.msie&&$(this).find("> a").css("color",$(this).css("color"))})}function c(){var e=$("#my-rooms .room-info");e.each(function(){var e=$(this).find(".last-message");""==e.find(".text").text()?e.hide():e.show()})}function u(e){if(e.preventDefault(),$(this).hasClass("quickleave")){var t=$(this).closest("li").find("a").not(".reply-count").eq(0);if(!confirm("Do you want to leave "+(t.attr("title").substr("switch to ".length)||t.text())+"?"))return}var s=$(this).closest("li").attr("id").replace("room-","");$.post("/chats/leave/"+s,fkey({"quiet":!0})),M(s)}function h(){var e=!1;if("leaveall"==this.id){if(!confirm("This will remove you from all rooms; continue?"))return!1;e=!0}return $.post($(this).attr("href"),fkey({"quiet":!0}),function(){e&&W.broadcast({"command":"leave all"}),window.location="/"}),!1}function m(){$(".sidebar-widget:has(ul.collapsible)").find(".more").click(function(){$(this).closest(".sidebar-widget").find("ul.collapsible").toggleClass("expanded").updateCollapsible(),window.setTimeout(S,700)})}function f(){if(confirm("This will permanently delete this file; are you sure?")){var e=$(this).attr("id").replace("file-",""),t=$(this).closest("li");$.post("/files/delete/"+Y+"/"+e,fkey(),function(){t.slideUp(function(){t.remove()})})}}function p(e,s,n,i){if(!s||confirm(s)){{var a=$(e).closest("li");a.attr("id").replace("summary_","")}t(a.attr("id").replace("summary_",""),n,null,function(e){"ok"!=e?(G(e||GENERIC_ERROR),i&&i()):s&&s.length>0&&a.slideUp(function(){$(this).remove()})},G)}}function g(){p(this,"Delete this post?","delete")}function v(){p(this,"Remove this flags against this post?","unflag")}function y(){if(confirmFlag(a&&a())){var e=$(this),t=function(){e.toggleClass("user-flag")};p(this,null,"flag",t),t()}}function _(){p(this,"Remove the pins against this post?","unowner-star")}function w(){p(this,"Remove the stars against this post?","unstar")}function b(){p(this,null,"owner-star")}function C(){var e=$(this),t=function(){e.toggleClass("user-star")};p(this,null,"star",t),t()}function k(e){function t(e,t,s,n){var i=[];if(t){var a={"id":e,"text":t,"user":s,"time":n};i.push(a)}for(var o in r){var l=r[o];l.id!=e&&i.push(l)}r=i.sort(function(e,t){return t.id-e.id}).slice(0,Z)}function s(){return r.length>0?r[0]:{"id":null,"text":"","user":"","time":null}}function n(){delete Q[e]}function i(e){l[e]=!0}function a(e){e?delete l[e]:l={}}function o(){var e=0;for(id in l)e++;return e}if(e=parseInt(e),e in Q)return Q[e];var r=[],l={},d={"add":t,"getLast":s,"leave":n,"addMention":i,"dismissMention":a,"getMentionCount":o};return Q[e]=d,d}function T(e){var t=k(e).getMentionCount(),s=$("#room-"+e);if(0==s.length)return!1;var n=s.find(".reply-count");return 0==t?(n.remove(),!0):(0==n.length&&(n=$("<a/>").attr("href",s.find("a:first").attr("href")).attr("target","_self").attr("title","someone mentioned you in that room").addClass("reply-count").prependTo(s)),n.text(t),!0)}function S(){z&&clearTimeout(z),z=setTimeout(function(){z=null,x()},500)}function x(e,t){void 0==e&&(e=10);var s=$("#sidebar").height()-$("#input-area").height()-8,n=s-$("#sidebar-content").height();if(void 0!=t){if(t&&10>n)return x(0,!1);if(!t&&n>10)return}void 0==t&&(t=n>0);var i=!1;$("#sidebar .collapsible").not(".fixed-max").each(function(){var e=$(this).data("show_max")||5;!t&&e>1?($(this).data("show_max",e-1),i=!0):t&&10>e&&($(this).data("show_max",e+1),i=!0),i&&$(this).updateCollapsible(!0)}),e>0&&i&&x(e-1,t)}function j(e){if(-1==e.search(/[<>&]/))return e;var t=$("<div>"+e+"</div>").eq(0);return t.find("p,div,h1,h2,h3,h4,h5").each(function(){$("<span> </span>").insertAfter(this)}),t.find("br,hr,img").replaceWith("<span> </span>"),t.text()}function E(e,t,s,n,i,a){var o=$("#room-"+e),r=!1;if(0==o.length||o.hasClass("leaving")){o.remove(),o=$("<li/>").attr("id","room-"+e).hide(),t=t||"(unknown)";var l;l=t.length>40?$("<a target='_self' href='/rooms/"+e+"/"+urlFriendly(t)+"' />").text(t.substring(0,37)).append("<span>&hellip;</span>"):$("<a target='_self' href='/rooms/"+e+"/"+urlFriendly(t)+"' />").text(t),l.attr("title","switch to "+t).appendTo(o),$("<span class='quickleave'/>").insertAfter(l).attr("title","leave that room"),o.append(div("room-info").append(div("last-message").append(span("user-name"),": ",span("text"),div("time data")))),r=!0,et&&o.appendTo("#my-rooms")}if(arguments.length>2){var u=k(e);u.add(a,n,s,i);var h=u.getLast();o.find(".room-info > .last-message > .user-name").text(h.user),o.find(".room-info > .last-message > .text").text(j(h.text||"")),o.find(".room-info > .last-message > .time").text(h.time)}et?tt.push(o):o.prependTo("#my-rooms").slideDown(),d(),r&&($("#room-ad").slideUp(function(){$("#room-ad").remove()}),S()),et||$("#my-rooms").updateCollapsible(),c()}function P(){var e=$("#my-rooms > li:first .time.data");return e.length?parseInt(e.text()):1}function M(e){k(e).leave(),$("#room-"+e).addClass("leaving").slideUp(function(){$(this).remove(),c(),$("#my-rooms").updateCollapsible(),S()})}function I(e,t){return k(e).addMention(t),T(e)}function R(e,t){k(e).dismissMention(t),T(e)}function A(){$("#starred-posts ul li").each(function(){var e=parseInt($(this).attr("data-time"))+SERVER_TIME_OFFSET;isNaN(e)||$(".relativetime",this).text(ToRelativeTimeMini(e,!0))})}function O(){st&&(window.clearInterval(st),st=null),K=0,$("#starred-posts ul").load("/chats/stars/"+Y+"?count="+K,function(){$("#starred-posts ul").updateCollapsible(!0),S(),st=window.setInterval(A,12e4)})}function U(){q($("#flag-count").text(0))}function q(e){$.browser.msie?e.css("visibility","hidden"):e.fadeOut()}function D(e){function t(e){e.css("visibility","visible"),$.browser.msie||e.fadeIn()}var s=$("#flag-count");if(s.length>0){var n="/admin/counters";e&&(n+="?id="+e),$.get(n,function(e){s.find("a").text(e.flags),e.flags?t(s):q(s),s=$("#modflag-count"),s.find("a").text(e.modflags),e.modflags?t(s):q(s)})}}function N(){J=0,$("#room-files ul").load("/chats/files/"+Y+"?count="+J,function(){$("#room-files ul").updateCollapsible(!0),S()})}function L(){$.getJSON("/rooms/thumbs/"+Y,H)}function H(e){e&&(e.name&&$("#roomname").text(e.name),e.description&&$("#roomdesc").html(e.description),e.isFavorite?$("#toggle-favorite").addClass("favorite-room"):$("#toggle-favorite").removeClass("favorite-room"),$("#room-tags").remove(),e.tags&&$("<div id='room-tags'>").html(e.tags).insertAfter("#roomdesc"),document.title=document.title.replace(/^(\(\d*\*?\) )?(.*)( \| [^|]*)$/,"$1"+e.name.replace(/\$/g,"$$$$")+"$3"))}function F(){$("#toggle-favorite").toggleClass("favorite-room"),$.post("/rooms/favorite",fkey({"roomId":Y}),H)}function B(e){e.stopPropagation();var t,n=$(this).closest("li"),i=popUp(e.pageX,e.pageY,n),a=[],o=$("<div/>").appendTo(i),r=n.attr("id").replace("summary_","");o.html('<a href="'+PERMALINK(r)+'">permalink</a> | <a href="/messages/'+r+'/history">history</a><br/>'),n.find(".sidebar-vote.user-star").length>0?(t="unstar",a.push("starred")):t="star";var l=!1,d=s();(d||!l)&&$("<span/>").addClass("star").html("<span class='sprite sprite-icon-star'/> "+t+" as interesting").click(C).click(i.close).attr("title","click to "+t).appendTo(i);var c=!1;if(n.find(".sidebar-vote.user-flag").length>0&&(c=!0,a.push("flagged")),a.length>0&&o.html(o.html()+"You have "+a.join(" and ")+" this message.<br/>"),c||!d&&l||(i.append("<br/>"),$("<span/>").addClass("flag").html("<span class='sprite sprite-icon-flag'/> flag as spam/offensive").click(y).click(i.close).attr("title","click to "+t).appendTo(i)),i.append($("<br/><br/>")),d){if($(this).hasClass("quick-unstar")){var u="pin this item",h=b;$(this).siblings(".sidebar-vote.stars.owner-star").length>0&&(u="unpin this item",h=_),i.append($("<span/>").addClass("owner-star").text(u).prepend('<span class="img"></span>').click(h).click(i.close).attr("title",u)),i.append(" | "),i.append($("<span/>").addClass("star").html("cancel stars ").click(w).click(i.close).attr("title","cancel stars"))}$(this).hasClass("quick-unflag")&&(i.append($("<span/>").addClass("delete").html("delete").click(g).click(i.close).attr("title","click to delete")),i.append(" | "),i.append($("<span/>").addClass("flag").html("cancel flags").click(v).click(i.close).attr("title","cancel flags")))}}function V(t){if(t.shiftKey||t.ctrlKey||t.altKey)return!0;var n=$("#about-room").attr("href").replace("/rooms/info/",""),i=e.id,r=$("#roomname").text();t.preventDefault(),t.stopPropagation();var d=popUp(t.pageX,t.pageY).addClass("room-popup");$("<h2/>").text(r).appendTo(d);var c,u,h,m=$("<div/>").css({"width":192,"height":25}).appendTo(d);h=$("<div/>").appendTo(d),s&&s()&&($("<h5/>").text("Room owner").appendTo(d),c=$("<div/>").appendTo(d),a&&a()&&($("<h5/>").text("Moderator").appendTo(d),u=$("<div/>").appendTo(d)));var f=function(e,t,s){var n=$("<a/>").text(e).attr("href",t);return s&&n.attr("target","_self"),$("<div/>").append(n)};if(f("full transcript","/transcript/"+i).appendTo(h),l&&f("create new bookmark","#").click(function(e){e.preventDefault(),X.Dialog()}).appendTo(h),infoOrOwner=function(e,t,s){s=s||t,f(c?s:t,e).appendTo(c)},c&&(infoOrOwner("/rooms/info/"+n+"?tab=schedule","scheduled events","schedule events"),infoOrOwner("/rooms/info/"+n+"?tab=access","user access","control access"),infoOrOwner("/rooms/info/"+n+"?tab=feeds","room feeds","manage feeds")),u&&(f("timeout","#").click(function(e){e.preventDefault();promptUser(e,"<h2>Timeout</h2><p>This should only be used to help control an off-topic discussion.</p><p>You should also explain why the room is in timeout.</p><p>Enter the time in seconds:</p>","60",function(e){e&&e.length>0&&$.post("/rooms/timeout/"+n,fkey({"duration":e}))});return!1}).appendTo(u),f((e.frozen?"un":"")+"freeze this room","#").click(function(t){t.preventDefault();var s=e.frozen?"Do you want to unfreeze this room, allowing new messages to be posted?":"Do you want to freeze this room, preventing regular users from talking?";window.confirm(s)&&($.post("/rooms/setfrozen/"+i,fkey({"freeze":!e.frozen})),d.close())}).appendTo(u),f((e.deleted?"un":"")+"delete this room","#").click(function(t){t.preventDefault();var s=e.deleted?"Do you want to undelete this room, making it visible again to regular users?":"Do you want to delete this room and remove all users from it, including yourself?";window.confirm(s)&&($.post("/rooms/setdeleted/"+i,fkey({"delete":!e.deleted})),d.close())}).appendTo(u)),null!=o){var p=u?"move/delete messages":"move messages";f(p,"#").click(function(){return d.close(),o(),!1}).appendTo(u||c)}var g=$("<img/>").attr("src",IMAGE("ajax-loader.gif")).appendTo(m),v="/rooms/thumbs/"+i;$.getJSON(v,{"showUsage":!0,"host":e.host},function(e){g.remove(),e.usage?m.html(e.usage):m.slideUp()})}var z,G=i.notify,W=i.icc,Y=e.id,K=10,J=10,X=ConversationSelector(e.id,r,G,$("#chat")),Q={},Z=5,et=!1,tt=[];$("#my-rooms").on("mouseenter",function(){et=!0}).on("mouseleave",function(){if(et=!1,tt.length){for(var e=0;e<tt.length;e++){var t=tt[e];t.parent().is("#my-rooms")&&t.prependTo("#my-rooms")}tt=[],$("#my-rooms").updateCollapsible()}});var st;d(),c(),initSearchBox(),$("#starred-posts .quick-unstar").live("click",B),$("#starred-posts .sidebar-vote").live("click",C),$("#my-rooms span.quickleave").live("click",u),$("#leave, #leaveall").click(h),$("#room-files .quick-delete").live("click",f),$("#my-rooms").data("autohide",!0).updateCollapsible(),$("#my-rooms,#starred-posts ul").data("autohide",!0),$("#toggle-favorite").click(F),$("#room-menu").click(V),$("#present-users").data("show_max",32),$("#rejoin-favs").click(function(){$.post("/chats/join/favorite",fkey({"quiet":!0,"immediate":!0}),function(){$("#rejoin-favs").fadeOut(function(){$("#rejoin-favs").remove()})})}),m(),window.setInterval(function(){d()},1e4),$(window).resize(S);var nt={"relayout":S,"leaveOtherRoom":M,"otherRoomActivity":E,"otherRoomMention":I,"updateStars":O,"updateFiles":N,"updateRoomMeta":L,"updateAdminCounters":D,"dismissOtherRoomMention":R,"lastOtherRoomMessageTime":P,"noFlags":U};return nt}function CrossTab(e){function t(e){var t=$("#jplayer");t.length>0&&t.jPlayer&&t.jPlayer({"ready":function(){t.jPlayer("setMedia",{"mp3":e.file,"oga":e.file.replace(/\.mp3$/,".ogg")}),r=t},"swfPath":e.swfPath,"solution":"html, flash","supplied":"mp3,oga","volume":e.vol/100})}function s(e){l=e}function n(t){d.broadcast({"command":"announce","roomId":e,"focus":document.hasFocus&&document.hasFocus(),"initial":t}),h=now()}function i(e,t,s){function n(e){e.length&&e[0]||i()}function i(){var t=a.shift();t&&d.request({"command":"doit","action":e,"param":s},n,500,t.sender)}var a=Generator(u).map("1").sortBy(function(e){var s=e.roomId===t?0:1,n=e.lastfocus?.5/e.lastfocus:.6;return s+n}).toArray();i()}function a(e){i("sound",e)}function o(e,t){i("toast",e,t)}var r,l,d=Messenger("chat:crosstab",!0),c={"sound":function(){return r?(r.jPlayer("play"),!0):!1},"toast":function(e){return l?l(e):!1}},u={},h=0;return $(window).on("unload",function(){d.broadcast({"command":"gone"})}),$(window).on("focus",function(){n()}),n(!0),setInterval(function(){now()-h>30&&n()},6e4),d.onReceive(function(e,t,s){if("announce"===e.command){var i=e.focus?now():(u[t.sender]||{"focus":0}).focus;u[t.sender]={"lastfocus":i,"roomId":e.roomId,"seen":now(),"sender":t.sender},e.initial&&n()}else if("gone"===e.command)delete u[t.sender];else if("doit"===e.command){if(Date.now()-t.time>300)return s(!1);var a=c[e.action];return a?s(a(e.param)):s(!1)}}),{"initSound":t,"playSound":a,"initDesktopNotificatons":s,"desktopNotification":o}}function SoundManager(e){function t(){var e=s();e>1&&e--,$("#sound").prop("className","sprite sprite-sound-"+e)}function s(){var e=$.cookie("sl");return null==e?1:e}function n(e){$.cookie("sl",e,{"path":"/","expires":90})}function i(t,n){t>s()||e.playSound(n)}function a(e){e.stopPropagation();var i=popUp(e.pageX,e.pageY),a=function(e){n($(this).attr("id").replace("sound-level-","")),i.close(),t(),e.preventDefault()};$("<h2/>").html("Sound notifications").appendTo(i);for(var o=$("<ul/>").addClass("no-bullets").appendTo(i),r=["none","when mentioned","visible room","all my rooms"],l=s(),d=0;d<r.length;d++){var c=d==l?" (current setting)":"";$("<li/>").append($("<a/>").attr("href","#").text(r[d]+c).attr("id","sound-level-"+d).click(a).appendTo(i)).appendTo(o)}e.preventDefault()}function o(e,t){d&&2!=e||c>e&&(c=e,t&&(u=t))}function r(){i(c,u),u=null,c=99}function l(e){d=e}var d,c=99,u=null;return t(),$("#sound").click(a),{"queue":o,"play":r,"setIcc":l}}function StartChat(e,t,s,n,i,a,o){function r(e){var t=$("#input").val();return t===e?$("#input"):$("#input").val(e).trigger("change")}function l(){return window.getComputedStyle?parseFloat(getComputedStyle(document.body,null).height):$("body").height()}function d(){function e(){l.css("visibility","visible"),$.browser.msie||l.fadeIn()}function t(){$.browser.msie?l.css("visibility","hidden"):l.fadeOut()}function n(){var s=d.length;s?(l.text(s).attr("title","You have been mentioned"+(2==s?" twice":s>2?" "+s+" times":"")+". Click to show."),e()):t(),b()}function i(e){uniquePush(e),n()}function a(){return d.length}function o(e){Yt.broadcast({"command":"clear mention","roomid":s.id,"messageid":e})}function r(e){d.length&&!e&&$.post("/messages/ack",fkey({"id":d.join(",")})),d=[],e||o(),n()}var l=$("#reply-count"),d=[];return uniquePush=function(e){$.inArray(e,d)<0&&d.push(e)},l.click(function(){var e=d.shift();if(e){var t=$("#message-"+e);t.length?N(t,void 0,{"offset":-100,"onAfter":m}):window.open(PERMALINK(e)),$.post("/messages/ack",fkey({"id":e}))}d.length?o(e):o(),n()}),$.browser.msie||l.hide().css("visibility","visible"),{"add":i,"len":a,"clear":r}}function c(){var e="chat:draft:"+s.id,t=$("#input");if(0==t.length)return!0;var n=t.val(),i=!n.length;try{n.length?window.localStorage.setItem(e,n):window.localStorage.removeItem(e),i=!0}catch(a){}return i}function u(){try{var e=window.localStorage.getItem("chat:draft:"+s.id);if(!e)return;var t=!/^:\d+ $/.test(e);r(e).caret(t?0:e.length,e.length)}catch(n){}}function h(){var e=document.body,t=e.scrollTop,s=e.scrollLeft;return 0===t?"xy":(e.scrollLeft=0,h=e.scrollTop!==t?function(){return"y"}:function(){return"xy"},e.scrollLeft=s,e.scrollTop=t,h())}function m(){vs=ks()<=(i?15:5)}function f(e){var t=hiddenUsers;hiddenUsers={},e&&$(e).each(function(e,t){showHideForUser(t,!0,!0)});for(key in t)t[key]&&!hiddenUsers[key]&&showHideForUser(key,!1,!0)}function p(t){return t=$.trim(t.replace(/^:\d+ /,"")),"!http"==t.substr(0,5).toLowerCase()||js.test(t)||Es.test(t)||e.additionalOneBox&&e.additionalOneBox.test(t)}function g(e){var t=F(v(markdownMini(e),!1));return p(e)&&(t+=' <img src="'+IMAGE("progress-dots.gif")+'" class="progressbar" />'),t}function v(e,t){if(!e)return"<span class='deleted'>(removed)</span>";if("<pre"==e.substring(0,4))return e;t&&(e=e.replace(/@((?:[^\s!?();:,\/+&<]|&#\d{2,};){3,})/gi,function(e,t){function s(t,s){if(t.test(o)){var a=o.replace(t,"");if(a.length>=3&&0===r.indexOf(a))return s=s||t,n=e.replace(s,function(e){return i=e,""}),!0}return!1}var n,i,a=t.replace(/&#(\d+);/g,function(e,t){return String.fromCharCode(parseInt(t))}),o=normalizeUserName(a),r=normalizeUserName(CHAT.RoomUsers.current().name);return CHAT.IsAdditionalMention&&CHAT.IsAdditionalMention(o)?(n=e.match(/^@\w+/)[0],i=e.substring(n.length)):o.length>=3&&0==r.indexOf(o)?(n=e,i=""):0==r.indexOf(o.substring(0,3))&&(s(/\.$/)||s(/'$/,/(&#39;|')$/)||s(/'s$/,/(&#39;|')s$/)||s(/'\.$/,/(&#39;|')\.$/)||s(/'s\.$/,/(&#39;|')s\.$/)),n?"<span class='mention'>"+n+"</span>"+i:e})),e=handleQuoteMessage(e);var s=e.match(/^:(\d+)\s/);if(s){var n=$("#message-"+s[1]),i=n.closest(".monologue").data("user"),a=CHAT.RoomUsers.getIfAvailable(i);a&&(e="@"+a.name.replace(/\s/g,"")+" "+e.substring(s[0].length))}return e}function y(){var e=$("#chat div.message").eq(0).messageId(),t=$("#getmore-mine").html();$("#getmore-mine").html("finding your last message&hellip;"),$.post("/chats/"+s.id+"/lastMessage",{"beforeId":e,"highlights":a?!0:void 0},function(e){e.msgid?e.gap<=300?_(function(){N($("#message-"+e.msgid)),$("#getmore-mine").html(t)},e.gap+5,"#getmore-mine"):(Jt('Your last message is too far back; please use the <a href="'+PERMALINK(e.msgid)+'">transcript</a> instead'),$("#getmore-mine").html(t)):$("#getmore-mine").fadeOut().slideUp()})}function _(e,t,n){"which"in e&&(e=null),t=t||cs,ds+=t;{var i=ds-$("#chat div.message").length,o=$("#chat div.message").eq(0);
$("#getmore")}if(0==o.length)return $("#getmore").fadeOut().slideUp(),void 0;var r=o.messageId(),l=$(window).scrollTop()-o.offset().top,d="/chats/"+s.id+"/events?before="+r+"&mode=Messages";$(n||"#getmore").html("loading&hellip;"),d+="&msgCount="+i,a&&(d+="&highlights=true");var c=(new Date).getTime();$.post(d,fkey(),function(t){var s=(new Date).getTime();t.events&&0!=t.events.length||$("#getmore,#getmore-mine").fadeOut().slideUp(),$("#chat div.timestamp").eq(0).remove(),ft(t).prependTo("#chat"),$.preload(".message img.user-image",{"placeholder":bs,"notFound":Cs}),$("#getmore").html("load older messages"),I(),ns(o,{"offset":l}),e&&e(),debugMessage("server: "+(t.ms?t.ms+"ms":"n/a")+"; client: "+((new Date).getTime()-s)+"ms; request (inc server): "+(s-c)+"ms")})}function w(e,t,s){if(t){var n=e.data("source");if(n)return s(n),void 0}var i=s,a=$(e).messageId(),o="/message/"+a;t&&(o+="?plain=true",i=function(t){e.data("source",t),s(t)}),$.get(o,i)}function b(){var e=document.title.replace(/^\(\d*\*?\) /,"");(ps>0||Qt.len())&&(e="("+(ps>0?ps:"")+(Qt.len()?"*":"")+") "+e),window.setTimeout(function(){$(document).attr("title",e)},TITLE_UPDATE_DELAY)}function C(e){if(!CHAT.RoomUsers.current().is_moderator){k();var t=120-secondsSince(e.info("time"));10>=t?(Us.secondsLeft(t),Ts=setTimeout(function(){Us.secondsLeft(-1),Ts=null},1e3*t)):Ts=setTimeout(function(){Us.secondsLeft(10),Ts=setTimeout(function(){Us.secondsLeft(-1),Ts=null},1e4)},1e3*(t-10))}}function k(){Ts&&clearTimeout(Ts),Ts=null,Us.secondsLeft(null)}function T(){$("#chat div.message").removeClass("editing"),S($(this).closest(".message"))}function S(e){e.addClass("editing");var t=$("<img/>").attr("alt","please wait").attr("src",IMAGE("ajax-loader.gif")).css({"position":"absolute","margin":3,"padding":5,"backgroundColor":"white"}).hide().insertBefore("#input");window.setTimeout(function(){t.show()},200),$.browser.msie?$("#cancel-editing-button").show():$("#cancel-editing-button").stop().fadeIn(),ns(e,500,{"offset":-200,"onAfter":m}),w(e,!0,function(s){t.remove(),$("#input").addClass("editing"),r(s).focus().caret(s.length,s.length),Us.clear(),wt(),C(e)})}function x(){$("#chat div.editing").removeClass("editing"),$("#input").removeClass("editing").prev("img").remove(),$("#cancel-editing-button").fadeOut(),r(""),k()}function j(){return $("#chat").find("div.editing").eq(0)}function E(){return div("clear-both").html("&nbsp;").css("height",0)}function P(e,s){var n=userContainer(e||0);n.addClass("monologue"),e==t&&n.addClass("mine");var i=$("<div/>").addClass("messages");return e&&e.toString().length>0?n.append(CHAT.RoomUsers.monologueSignature(e)):s&&0!=s.length&&n.append(CHAT.RoomUsers.monologueSignature(0)).find(".username").each(function(){$(this).text(s)}),n.append(i),n.append(E()),n}function M(e,t){var s=e.find("div.message").length;if(0==s){var n=e.prev(".system-message-container"),i=e.next(".system-message-container");if(i.length||n.length){var a=(i.length?i:e).next(".monologue");a.length&&(a.find(".timestamp").remove(),a.addClass("needs-elapsed"),a.putInto(containers.timeTreatmentNeedy)),i.remove(),n.remove()}return e.remove(),void 0}var o=e.find("div.messages").height(),r=e.find("a.signature > .username").potentialHeight(),l=t?0:400;37>o-r?(e.find(".avatar-32,.signature > .username,.flair").slideUp(l),e.find(".tiny-signature").slideDown(l)):50>o-r?(e.find(".avatar-32,.signature > .username").slideDown(l),e.find(".tiny-signature,.flair").slideUp(l)):(e.find(".avatar-32,.signature > .username,.flair").slideDown(l),e.find(".tiny-signature").slideUp(l)),e.trigger("monologue-updated")}function I(){if(vs){var e=$("#chat div.message").slice(0,-ds),t=e.length>us;t&&($("#getmore").show(),e.closest(".monologue").putInto(containers.needyMonologues),e.remove(),$(".monologue").eq(0).putInto(containers.needyMonologues))}containers.needyMonologues.withAll(function(){M($(this))}),containers.needyMonologues.spill(),t&&Q($("#chat > div.monologue").eq(0)),et()}function R(e,t){var s=e.closest(".monologue"),n=e.nextAll(".message");if(0!=n.length){var i=P(s.data("user"),t);n.appendTo(i.find("div.messages")),i.insertAfter(s),i.trigger("monologue-updated")}}function A(e,t,s,n,i){var a=$("#message-"+t);if(a.length>0)return a.closest(".monologue");if(!i){var o=$("#chat div.message").not(".pending").filter(function(){return $(this).messageId()<t});if(o.length>0){var r=o.last().closest(".monologue"),l=o.last().info("time"),d=r.next().hasClass("timebreak"),c=d||s-os>l,u=s-rs>l;if(!c&&r.data("user")==e)return r;R(o.last(),n);var h=P(e,n).insertAfter(d?r.next():r);return c&&h.addClass("needs-timestamp").putInto(containers.timeTreatmentNeedy),u&&h.addClass("needs-elapsed").putInto(containers.timeTreatmentNeedy),h}return P(e,n).prependTo($("#chat")).trigger("monologue-updated")}}function O(){var e=$(this).closest(".message").messageId(),t=$("#input").focus().val().replace(/^:([0-9]+)\s+/,"");r(":"+e+" "+t).focus()}function U(){$("#message-"+$(this).info("parent_id")).addClass("reply-parent"),$(".message.pid-"+$(this).messageId()).addClass("reply-child")}function q(){$("#message-"+$(this).info("parent_id")).removeClass("reply-parent"),$(".message.pid-"+$(this).messageId()).removeClass("reply-child")}function D(){var e=$("#message-"+$(this).closest(".message").info("parent_id"));return 1==e.length?(N(e,null,{"onAfter":m}),!1):void 0}function N(e,t,s){var n=$(e);n.addClass("highlight"),window.setTimeout(function(){n.removeClass("highlight")},t||2e3),ns(n,200,s)}function L(e){e.stopPropagation(),e.preventDefault();var s,n=$(this).closest(".message"),i=popUp(e.pageX,e.pageY,n),a=[],o=$("<div/>").appendTo(i),r=n.messageId(),l=t>0&&CHAT.RoomUsers.current().is_owner,d=$("<span/>").text("posted "+ToRelativeTimeMini(n.info("time"))).attr("title",localTimeSimple(n.info("time"))),c=n.closest(".monologue").data("user")==t;if(0==n.find(".deleted").length){o.html(' &ndash; <a href="'+PERMALINK(r)+'">permalink</a><br/>'),o.prepend(d),ws&&!n.closest(".user-container").hasClass("mine")&&($("<span/>").addClass("reply").html('<span class="newreply"> </span> reply to this message').click(O).click(i.close).appendTo(i),i.append("<br/>")),i.append("<br/>"),n.find(".meta .stars").hasClass("user-star")?(s="unstar",a.push("starred")):s="star",t>0&&!c&&($("<span/>").addClass("star").html('<span class="img"/> '+s+" as interesting").click(Tt).click(i.close).attr("title","Add a star to indicate an interesting message, for example to display in the room's highlights").appendTo(i),i.append("<br/>")),l&&(n.find(".meta .stars").hasClass("user-owner-star")?(s="unpin",a.push("pinned")):s="pin",$("<span/>").addClass("owner-star").html('<span class="img"/> '+s+" this message").click(St).click(i.close).attr("title","Pinning is like adding a star, but pinned items takes priority; this option is only available to the room owner.").appendTo(i),i.append("<br/>"));var u=!1;n.find(".meta .flags").hasClass("user-flag")&&(u=!0,a.push("flagged")),a.length>0&&o.html(o.html()+"You have "+a.join(" and ")+" this message.<br/>");var h=n.info("edits"),m=n.info("moved"),f=n.find(".meta .stars").hasClass("owner-star");if(h||m||f){var p="This message has been ";m&&(p+="moved from another room "+(h||f?"and ":"")),h&&(p+="edited "+(1==h?"once":2==h?"twice":h+" times")+(f?" and ":"")),f&&(p+="pinned"),o.append(p+" - "),o.append($("<a/>").attr("href","/messages/"+r+"/history").text("history"))}!u&&t>0&&(CHAT.RoomUsers.current().is_owner||!c)&&($("<span/>").addClass("flag").html('<span class="img"/> flag as spam/offensive').click(xt).click(i.close).attr("title","Flagging a message helps bring inappropriate content to the attention of moderators and other users, for example spam or abusive messages.").appendTo(i),i.append("<br/>")),i.append($("<br/>")),(CHAT.RoomUsers.current().is_moderator||c&&secondsSince(n.info("time"))<115)&&($("<span/>").addClass("edit").html("edit ").click(T).click(i.close).attr("title","click to edit").appendTo(i),i.append(" | "),delete_button=$("<span/>").addClass("delete").html("delete ").click(jt).click(i.close).attr("title","click to delete"),i.append(delete_button),i.append(" | ")),t>0&&$("<span/>").addClass("flag").html("flag for moderator").click(H).click(i.close).attr("title","Moderator flags are seen only by the site-moderators, and should be used to indicate serious issues with a message, and other administrative issues.").appendTo(i)}else o.html("<br/>This message has been deleted"),o.prepend(d),(c||l)&&o.append(" - ").append($("<a/>").attr("href","/messages/"+r+"/history").text("history"))}function H(e){var t=$(this).closest(".message"),s="<h2>Flag for moderator</h2><p>Please <b>do not use</b> this feature for anything other than informing moderators of <b>serious</b> issues that require their attention.</p><p>Please indicate why this requires moderator attention:</p>";promptUser(e,s,"",function(e){e&&e.length>0&&kt(t,"mod",{"info":e},function(e){"ok"==e?Jt("Thanks, we'll take a look at it."):Jt(e||GENERIC_ERROR)})},!0,null,function(e){return e.length>200?"Maximum length exceeded":""})}function F(e){if(!e||0==e.length||"<pre"==e.substring(0,4))return e;if(-1==e.search("<"))return autoLink(e);var t=$("<div/>").html(e);return t.find("*").add(t).contents().filter(function(){return 3==this.nodeType&&0==$(this).closest("a,code").length}).each(function(){var e=$(this).text();e&&-1!=e.search("/")&&$(this).replaceWith(autoLink(e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;")))}),t.html()}function B(){$("#main").toggleClass("message-admin-mode"),V()}function V(e,t){var s=$("#main"),n=s.hasClass("select-mode");ts&&ts(null),ts=e&&t?t:null,void 0==e&&(e=!n),$("#chat div.message.selected").removeClass("selected"),e||!n?(s.addClass("select-mode"),$.browser.msie&&$("#chat *").each(function(){this.unselectable="on"})):(!e||n)&&(s.removeClass("select-mode"),$.browser.msie&&$("#chat *").each(function(){delete this.unselectable}))}function z(){var e="",t=0;return $("#chat div.message.selected").each(function(s,n){e+=","+n.id.replace("message-",""),t++}),e.length>0&&(e=e.substr(1)),{"id":e,"count":t}}function G(){var e=z();e.count>0?window.confirm("Delete the "+e.count+" selected posts?")&&($.post("/admin/deletePosts/"+s.id,fkey({"id":e.id})),B()):window.alert("You have not selected any posts to delete.")}function W(e){$("#roomsearchresult button").die(),e.preventDefault();var t=z();if(!t.count)return window.alert("You have not selected any posts to relocate."),!1;var n=popUp($(window).width()-50,e.pageY+20).css("width",750);$("<h2>Move posts</h2><p>This will move the selected posts to a different room. Enter the room name to <b>search</b> for the intended target room.</p>").appendTo(n);var i=$('<input type="text" name="roomname" />').appendTo(n),a=$("<img/>").attr("src",IMAGE("ajax-loader.gif")).appendTo(n).hide();if(CHAT.RoomUsers.current().is_moderator){$('<p>You can also automatically <b>create a new room</b> as the target room by entering the <b>new room\'s name</b> and clicking "create".</p>').insertBefore(i);var o=$("<div/>").css("color","red").insertBefore(i);$("<span>&nbsp;</span>").appendTo(n),$("<button class='button'>create</button>").appendTo(n).click(function(){var e=i.val();return""==e?(o.text("Please enter a name for the new room."),void 0):(confirm('Do you want to create a new room named "'+e+'", copy all user permissions from here to the new room, and move the selected messages there?')&&(a.show(),$.post("/admin/movePostsToNew/"+s.id,fkey({"ids":t.id,"newTitle":e}),function(e){return a.hide(),"ok"!=e?(o.text(e),void 0):(B(!1),$("#roomsearchresult button").die(),n.close(),void 0)},"json")),void 0)})}$('<div id="roomsearchresult" />').appendTo(n),$("#roomsearchresult button").live("click",function(){var e=$(this).closest(".room-mini").find("a:first").attr("href").replace(/^\/rooms\/(\d+)\/.*$/,"$1");$.post("/admin/movePosts/"+s.id,fkey({"ids":t.id,"to":e})),B(!1),$("#roomsearchresult button").die(),n.close()});var r=function(){a.show(),$("#roomsearchresult").load("/rooms/minilist",{"filter":i.val().toLowerCase(),"forWriting":!0},function(){a.hide(),$("#roomsearchresult .room-mini").each(function(){$("<button class='button'>choose</button>").prependTo($(".room-mini-header",this)).css({"float":"right","margin-top":0})})})};return i.keyup(function(e){13==e.which&&r(i.val())}).typeWatch({"callback":r,"wait":500,"captureLength":2}),!1}function Y(e,t){var s=e.messageId(),n=t.messageId();if(s>n){var i=s;s=n,n=i}return $("#chat div.message").filter(function(){var e=$(this).messageId();return e>=s&&n>=e})}function K(e){if($("#main").hasClass("select-mode")){e.preventDefault(),e.stopImmediatePropagation();var t=$(this).closest(".message");if(ts)return ts(t),void 0;if(e[Ms])t.toggleClass("selected");else if(e.shiftKey){var s=$("#chat div.message.selected"),n=s.first(),i=s.last(),a=Y(t,n),o=Y(t,i);a.length>=o.length?o.addClass("selected"):a.addClass("selected")}else $("#chat div.message.selected").removeClass("selected"),t.addClass("selected")}}function J(e){var n=$('<div class="message"/>').attr("id","message-"+e.message_id),i=$('<a class="action-link" title="click for message actions"><span class="img menu"> </span></a>').attr("href",PERMALINK(e.message_id)).appendTo(n);e.parent_id&&e.content&&e.show_parent&&$("<a/>").addClass("reply-info").attr("title","This is a reply to an earlier message").attr("href",PERMALINK(e.parent_id)).click(D).text(" ").appendTo(n),n.hover(U,q),e.moved&&$("<span/>").addClass("moved").attr("title","This message was moved from another room; see edit history").html("&larr;").appendTo(n);var a=$('<div class="content">'+F(v(e.content,e.user_id!=t))+"</div>").appendTo(n),o=$('<span class="stars vote-count-container'+(e.message_stars>0||e.message_owner_stars>0?" always":"")+(e.message_owner_stars>0?" owner-star":"")+'"><span class="img"/><span class="times">'+st(e.message_stars)+"</span></span>"),r=$('<span class="flags vote-count-container'+(e.message_flags>0?" always":"")+'"><span class="img"/><span class="times">'+st(e.message_flags)+"</span></span>"),l=$('<span class="meta"/>');l.append(r,"&nbsp;",o),t>0&&e.user_id!=t&&e.content&&(o.find(".img").addClass("vote").attr("title","star this message as useful / interesting for the transcript").click(Tt),e.message_flagged?r.find(".img").attr("title","you have flagged this message as spam, inappropriate, or offensive"):r.find(".img").addClass("vote").attr("title","flag this message as spam, inappropriate, or offensive").click(xt),l.append("&nbsp;"),l.append($('<span class="newreply"/>').click(O).attr("title","link my next chat message as a reply to this"))),e.message_starred&&o.addClass("user-star"),e.message_owner_starred&&o.addClass("user-owner-star"),e.message_flagged&&r.addClass("user-flag");var d=$('<span class="flash"/>');(Ds&&e.message_flags>0||e.message_flagged)&&d.addClass("flag-indicator"),d.append(o.clone(!0)),e.message_edits>0&&e.content&&i.addClass("edits"),n.append(l,d),e.parent_id&&n.addClass("pid-"+e.parent_id),n.data("info",{"time":e.time_stamp,"edits":e.message_edits,"moved":e.moved,"parent_id":e.parent_id});var c=a.find(".partial");if(1==c.length&&!c.parent().hasClass("quote")){var u=$("<a/>").addClass("more-data").text("(see full text)").attr("href","/messages/"+s.id+"/"+e.message_id);u.click(function(e){if(0==e.button&&!e.ctrlKey){var t=$("<span/>").html("loading&hellip;");t.insertAfter($(this).hide()),$.ajax({"type":"GET","url":$(this).attr("href"),"success":function(e){if("pre"!=c.get(0).tagName.toLowerCase()){var s="<div class='full'>"+e.toString().replace(/\r\n?|\n/g," <br> ")+"</div>";c.replaceWith(F(v(s)))}else c.removeClass("partial").addClass("full").html(e.replace(/^    /gm,""));t.add(u).remove()}}),e.preventDefault()}}),a.append(" ",u)}return ss&&ss(n,e.message_id),n}function X(e){var t=A(e.user_id,e.message_id,e.time_stamp,e.user_name,!(e.event_type==is.MessagePosted||e.event_type==is.MessageMovedIn||e.event_type==is.UserMentioned||e.event_type==is.MessageReply));if(t){t.putInto(containers.needyMonologues).putInto(containers.timeTreatmentNeedy),shouldShowUser(e.user_id)||showHideMonologue(t,!0);var s=J(e).addClass("neworedit"),n=t.find("#message-"+e.message_id);if(n.length>0)$.each(["time","starred","flagged"],function(e,t){s.info(t,n.info(t))}),$.each(["editing"],function(e,t){n.hasClass(t)&&s.addClass(t)}),s.data("source",n.data("source")),n.replaceWith(s);else{var i=t.find("div.message").filter(function(){return $(this).messageId()<e.message_id});0==i.length?s.prependTo(t.find("div.messages")):s.insertAfter(i.last())}if(e.content&&e.content.match(/^[-=]{3,}$/)){var a=s.prev(".message");a.length>0&&R(a,e.user_name)}$.preload("#message-"+e.message_id+" img.user-image",{"placeholder":bs,"notFound":Cs})}}function Q(e,t){if(0!=e.length){var s=e;e.hasClass(".timestamp")&&(s=e.closest(".monologue")),t||(t=s.find("div.message:first").info("time"));var n=s.find("div.timestamp");0==n.length&&(n=$("<div/>").addClass("timestamp").prependTo(s.find("div.messages"))),n.text(localTimeSimple(t))}}function Z(e,t){var s=div("system-message-container").append(div("system-message-spacer").html("&nbsp;"),div("system-message").html(e)).append(E());return t&&s.addClass(t),s}function et(){containers.timeTreatmentNeedy.withAll(function(){if(!($(this).find("div.timestamp").length>0)){var e=$(this).find("div.message:first").info("time");if(e){var t=$(this).prevAll(".monologue:has(.timestamp)").eq(0),s=e-(t.find("div.message:first").info("time")||0),n=$(this).prevUntil(".monologue:has(.timestamp)");if((s>as||n.length>=ls||$(this).hasClass("needs-timestamp"))&&(Q($(this),e),$(this).removeClass("needs-timestamp")),$(this).hasClass("needs-elapsed")){var i=e-$(this).prevAll(".monologue").eq(0).find("div.message:last").info("time");i&&Z(timeSpanString(i,!0)+" later&hellip;").insertBefore($(this)),$(this).removeClass("needs-elapsed")}}}}),containers.timeTreatmentNeedy.spill()}function tt(e,t){var s=secondsSince($("div.monologue:last div.message:last").info("time")),n=$("#silence-note:not(.removing)"),i=t?0:600;if(!e&&s>3600){var a="The last message was posted "+timeSpanString(s,!0)+" ago.";n.length?n.find(".system-message").html(a):n=Z(a).attr("id","silence-note").hide().appendTo("#chat").slideDown(i)}else n.addClass("removing").slideUp(i,function(){$(this).remove()})}function st(e){return e>1?e:""}function nt(e,t){if(null!=e){var s=$("#message-"+e.message_id),n=s.find(".stars");n.find(".times").html(st(e.message_stars)),e.message_owner_stars>0?n.addClass("owner-star"):n.removeClass("owner-star"),e.message_stars>0||e.message_owner_stars>0?n.addClass("always"):n.removeClass("always").removeClass("user-star")}t&&Wt.updateStars()}function it(e,s){if(null!=e){var n=$("#message-"+e.message_id),i=n.find(".flags");i.find(".times").html(st(e.message_flags));var a=e.user_id==t;e.message_flags>0?(i.addClass("always"),(Ds||a)&&n.find(".flash").addClass("flag-indicator"),a&&i.addClass("user-flag").find(".img").unbind("click").removeClass("vote").attr("title","you have flagged this message as spam, inappropriate, or offensive")):(i.removeClass("always"),i.removeClass("user-flag"),Ds&&n.find(".flash").removeClass("flag-indicator"))}s&&Wt.updateAdminCounters(hs)}function at(e,s){switch(e.event_type){case is.UserLeft:e.user_id==t&&Wt.leaveOtherRoom(e.room_id);break;case is.MessagePosted:case is.MessageEdited:$s.report_speaking(),shouldShowUser(e.user_id)&&(Wt.otherRoomActivity(e.room_id,e.room_name,e.user_name,e.content,e.time_stamp,e.message_id),e.user_id!=t?Kt.queue(3,e.room_id):Wt.dismissOtherRoomMention(e.room_id));break;case is.MessageDeleted:Wt.otherRoomActivity(e.room_id,e.room_name,e.user_name,null,e.time_stamp,e.message_id);break;case is.UserMentioned:case is.MessageReply:if(e.target_user_id==t)if(Kt.queue(1,e.room_id),Wt.otherRoomMention(e.room_id,e.message_id))s||ot(e);else{var n='You have been <a href="'+PERMALINK(e.message_id)+'">mentioned</a> in '+$("<span />").text(e.room_name).html()+", a room you're not currently in.";Jt(n)}break;case is.MessageFlagged:Wt.updateAdminCounters(hs);break;case is.UserEntered:e.user_id==t&&Wt.otherRoomActivity(e.room_id,e.room_name,e.user_name,e.content,e.time_stamp);break;case is.UserNameOrAvatarChanged:e.target_user_id===t?(_s=!0,window.location.reload()):CHAT.RoomUsers.forceUpdateIfNecessary(e.target_user_id)}}function ot(e){Os[e.message_id]=e}function rt(){for(var e in Os)lt(Os[e]);Os={}}function lt(t){if(Xt.desktop&&e.desktopNotify&&t.content&&t.content.length){var s="New event";switch(t.event_type){case is.UserMentioned:s="You were mentioned by "+t.user_name;break;case is.MessageReply:s="You received a reply from "+t.user_name}var n=$("<span/>").html(t.content).text();t.room_name&&t.room_name.length>0&&(n=n+" ("+t.room_name+")");var i,a=null;t.user_id&&(i=CHAT.RoomUsers.getIfAvailable(t.user_id)),i&&(a=gravatarUrl(t.user_id,i.email_hash,48));var o={"title":s,"text":n,"icon":a,"timeout":15e3};t.room_id?es.desktopNotification(t.room_id,o):Xt.desktop(o)}}function dt(e,n,i){if(!_s){if($s.report_happening(),e.room_id&&e.room_id!=s.id&&e.event_type!=is.ModeratorFlag&&e.event_type!=is.Invitation&&e.event_type!=is.GlobalNotification)return at(e,i);switch(e.event_type){case is.MessagePosted:e.user_id>0&&CHAT.RoomUsers.get(e.user_id).done(function(t){t.talk(e.time_stamp)});case is.MessageMovedIn:case is.MessageEdited:case is.MessageDeleted:X(e),e.user_id>0&&CHAT.RoomUsers.get(e.user_id).done(function(t){t.activity(e.time_stamp)}),ms||(e.message_flags>0&&it(null,!0),e.message_stars>0&&nt(null,!0)),$s.report_speaking();break;case is.MessageMovedOut:var o=$("#message-"+e.message_id),r=o.closest(".monologue");o.remove(),r.find("div.timestamp").remove(),r.putInto(containers.needyMonologues).putInto(containers.timeTreatmentNeedy);break;case is.DebugMessage:n||debugMessage(e.content);break;case is.UserEntered:CHAT.RoomUsers.get(e.user_id).done(function(e){e.enter()}),e.user_id==t&&(Wt.isLeaving=void 0);break;case is.UserLeft:e.user_id!=t||n?CHAT.RoomUsers.get(e.user_id).done(function(e){e.leave()}):(Wt.isLeaving=!0,_s=!0,0==$("#leave").length?window.location.href="/":$("#leave").click());break;case is.MessageStarred:nt(e,!0);break;case is.AccessLevelChanged:e.target_user_id>0&&CHAT.RoomUsers.trigger("access",e.target_user_id,e.content);case is.UserSuspended:case is.UserMerged:(e.target_user_id==t||null==e.target_user_id||e.event_type==is.UserMerged&&new RegExp("\\b"+t+"\\b").test(e.content))&&(_s=!0,window.location.reload());break;case is.ModeratorFlag:it(null,!0);break;case is.MessageFlagged:it(e,!0);break;case is.RoomNameChanged:Wt.updateRoomMeta();break;case is.MessageReply:case is.UserMentioned:e.target_user_id==t&&shouldShowUser(e.user_id)&&(a&&X(e),Qt.add(e.message_id),Kt.queue(1,e.room_id),i||ot(e));break;case is.FileAdded:Wt.updateFiles();break;case is.UserSettingsChanged:$.getJSON("/users/ignorelist",function(e){f(e)});break;case is.GlobalNotification:case is.UserNotification:if(n)break;e.content&&e.content.length>0&&(Kt.queue(1),Jt(e.content));break;case is.Invitation:Kt.queue(1),Jt(e.content);break;case is.TimeBreak:debugMessage("time break");break;case is.FeedTicker:(!e.user_id||shouldShowUser(e.user_id))&&Zt.add(e.content);break;case is.UserNameOrAvatarChanged:e.target_user_id===t?(_s=!0,window.location.reload()):CHAT.RoomUsers.forceUpdateIfNecessary(e.target_user_id);break;default:debugMessage("Unknown event type "+e.event_type+"; content: "+(e.content?e.content:"").substring(0,100)+"...")}}}function ct(){Is&&(Is=null,Rs=null,clearInterval(As),As=null,$("#input-table").fadeIn())}function ut(e){return Rs=now()+e,Is?(clearTimeout(Is),Is=setTimeout(ct,1e3*e),void 0):(Is=setTimeout(ct,1e3*e),$("#input-table").fadeOut(),As=setInterval(function(){var e=Math.round(-secondsSince(Rs));if(e){var t=$("<span/>").text(e).attr("title","Timeout");t.css({"position":"fixed","zIndex":10,"height":10,"bottom":0,"left":0,"opacity":1,"fontSize":1}).appendTo("#input-area").animate({"fontSize":200,"opacity":0,"height":220},5e3,function(){t.remove()})}},3e3),void 0)}function ht(e,n){if(e){if(e.reset)return _s=!0,window.location.reload(),void 0;if(e.exit)return window.location.href="/",void 0;if(!(e.since&&hs&&e.since<hs)){var i=(new Date).getTime();e.timeout?CHAT.RoomUsers.current().is_moderator||CHAT.RoomUsers.current().is_owner||ut(e.timeout):ct();var a=hs;if(e.time&&(!hs||e.time>hs?hs=e.time:hs&&e.time<hs&&debugMessage("replay: "+hs+" (client) vs "+e.time+" (server)")),e.sync&&(SERVER_TIME_OFFSET=e.sync-(new Date).getTime()/1e3),ms)return mt(e),debugMessage("server: "+(e.ms?e.ms+"ms":"n/a")+"; client: "+((new Date).getTime()-i)+"ms; request (inc server): "+(i-n)+"ms"),void 0;var o=0;e.events&&($.each(e.events,function(e,n){n.id>a&&n.event_type==is.MessagePosted&&n.user_id!=t&&n.room_id==s.id&&shouldShowUser(n.user_id)&&o++}),o>0&&Kt.queue(2,s.id),o>0&&!fs&&(ps+=o,b()),$.each(e.events,function(t,s){s.id>a&&dt(s,!1,e.icc)})),I(),e.events&&e.events.length>0&&(Wt.relayout(),setTimeout(function(){$("#chat .neworedit").removeClass("neworedit")},2e3)),tt()}}}function mt(e){var t=$("#chat");e.events&&e.events.length&&$s.report_speaking(e.events[e.events.length-1].time_stamp),$s.report_speaking(Wt.lastOtherRoomMessageTime(),!0),ft(e).appendTo(t),$.preload(".message img.user-image",{"placeholder":null,"notFound":Cs}),tt(!1,!0);var s=10,n=t.find("img.user-image").filter(function(){return!!$(this).attr("src")}),a=function(){0==s||0==n.filter(function(){return!this.complete}).length?(t.show(),containers.needyMonologues.withAllButTakeYourTime(function(){M($(this),!0)}),containers.needyMonologues.spill(),CHAT.RoomUsers.initializeLate(ws),ns("#bottom",0),vs=!0,ys=500,i?($("#loading").remove(),$("#topbuttons").show()):($("#input").focus(),$("#loading").fadeOut(function(){$(this).remove()}))):(s--,window.setTimeout(a,200))};a(),ms=!1,Wt.relayout()}function ft(e){var t,s,n,i,a,o=$([]),r=0,l=!1;return e.events?($.each(e.events,function(e,d){if(d.event_type==is.TimeBreak)l=!0;else{var c=d.user_id,u=!c||c!=t,h=d.time_stamp-s,m=l||h>os||u&&r%(ls+1)==0;l&&(o=o.add(Z("","timebreak"))),(u||m||d.content&&d.content.match(/^[-=]{3,}$/))&&(m=m||d.time_stamp-a>as,h>rs&&(o=o.add(Z(timeSpanString(h,!0)+" later&hellip;"))),n=P(c,d.user_name),o=o.add(n),c&&!shouldShowUser(c)&&(showHideMonologue(n,!0),n.hide()),m&&(Q(n,d.time_stamp),a=d.time_stamp,r=0),i=n.find("div.messages"),t=d.user_id,r++,n.putInto(containers.needyMonologues)),J(d).appendTo(i),s=d.time_stamp,l=!1}}),o):void 0}function pt(){var e="/chats/"+s.id+"/events";body=fkey({"since":hs,"mode":"Messages","msgCount":ds}),a&&(body.highlights=!0);var t=(new Date).getTime();return $.post(e,body,function(e){ht(e,t)}).promise()}function gt(e){return function(t){if(!t.id||$("#message-"+t.id).length>0){var s=e.closest(".monologue");return e.remove(),M(s),void 0}e.addClass("posted").removeClass("pending").attr("id","message-"+t.id),e.info("time",t.time)}}function vt(e,t){var s=e.data("source");return function(n,i){var a=i;"error"==i&&(a="error"==n.getResponseHeader("chat")?n.responseText:"An unknown error has occurred");var o=$("<i></i>").text(" - "+a+" - "),l=$("<a href='#'>retry</a>").click(function(t){o.remove(),_t(e),t.preventDefault()}),d=$("<a href='#'>edit</a>").click(function(e){o.remove(),r(s),t(),e.preventDefault()}),c=$("<a href='#'>cancel</a>").click(function(e){o.remove(),t(),e.preventDefault()});e.find("img.progressbar").remove(),o.append(l,"<span> / </span>",d,"<span> / </span>",c).appendTo(e)}}function yt(e){return"ok"==e?!0:(Jt(e),!1)}function _t(e){var t,n,a;-1!=e.attr("id").search(/^pending-message-/)?(t="/chats/"+s.id+"/messages/new",n=gt(e),a=function(){var t=e.closest(".monologue");e.remove(),M(t)}):(t="/messages/"+e.messageId(),a=function(){e.data("source",null).removeClass("pending"),e.html(e.data("previous_content")).data("previous_content",null)},n=function(t){e.removeClass("pending"),yt(t)?e.addClass("posted"):a()}),i||$("#input").focus(),$.ajax({"type":"POST","url":t,"data":fkey({"text":e.data("source")}),"success":n,"dataType":"json","error":vt(e,a)})}function wt(){var e=$("#input").val()||"",t=!1,s=!1,n=e.match(/[\n\r]/);return e&&0!=e.length&&0!=$.trim(e).length?e.length>500&&!n?s=!0:t=!0:e="",t||0==e.length?$("#sayit-button").removeAttr("disabled").removeClass("disabled"):$("#sayit-button").attr("disabled","disabled").addClass("disabled"),0==e.length?$("#upload-file").removeAttr("disabled").removeClass("disabled"):$("#upload-file").attr("disabled","disabled").addClass("disabled"),Us.tooLong(s),n?$("#codify-button").fadeIn():$("#codify-button").fadeOut(),t?e:null}function $t(e){i||Eggs.Current(e)}function bt(){var e=wt();if(e){if(r(""),wt(),"//test"==e)return runTests(),void 0;if("//cash"==e)return findCacheLeaks(),void 0;var s=j();if(s.length>0){if(s.hasClass("pending"))return r(e),wt(),Jt("This message cannot be edited before it has been received by the server. Please try again."),void 0;s.addClass("pending").data("source",e),s.data("previous_content",s.html()),s.html(g(e))}else{var n,i=$("#chat > div.monologue:last div.message:last");if(i.hasClass("pending"))n=i.closest(".monologue");else{var a;a=0==i.length?0:i.messageId(),n=A(t,a+gs+1e3,now(),CHAT.RoomUsers.current().name)}s=$("<div/>").addClass("message pending").attr("id","pending-message-"+gs),s.html(g(e)).appendTo(n.find(".messages")),s.data("source",e),ns(s,200),gs++,tt(!0),$t(e)}x(),_t(s),k(),Vt.dataExpected(),Qt.clear()}}function Ct(e,t,s){s&&$(s).toggleClass("user-"+t),"flag"!=t||Ds||e.find(".flash").toggleClass("flag-indicator");var n={"star":"starred","flag":"flagged"}[t];e.info(n,!e.info(n))}function kt(e,t,s,n){var i=$(e);i.hasClass("message")||(i=i.closest(".message"));var a=n;if("star"==t||"flag"==t){var o=i.find("."+t+"s");Ct(i,t,o),a=function(e){"ok"!=e&&(Ct(i,t,o),Jt(e||GENERIC_ERROR))}}var r=i.messageId();messageActionById(r,t,s,a,Jt)}function Tt(){$(this).closest(".message").find(".popup").hide(),kt(this,"star")}function St(){$(this).closest(".message").find(".popup").hide(),kt(this,"owner-star")}function xt(){$(this).closest(".message").find(".popup").hide(),confirmFlag(CHAT.RoomUsers.current().is_moderator)&&kt(this,"flag")}function jt(){$(this).hide(),kt(this,"delete",null,yt)}function Et(e){var t=e.event_type;return t===is.MessageFlagged||t===is.ModeratorFlag}function Pt(e,t){if(e){var s=Mt();if(e.reset)return _s=!0,window.location.reload(),void 0;var n=e[s],i={};Kt.setIcc(t),null!=n&&(ht({"time":n.t,"events":n.e,"timeout":n.timeout,"sync":e.sync,"icc":t,"ms":n.ms,"reset":n.reset,"exit":n.exit,"since":n.t&&n.d?n.t-n.d:void 0}),n.e&&Bt(n.e).filter(Et).map("event_id").forEach(function(e){i[e]=1})),Bt(e).filter(function(e){return e[0]!==s}).map("1").filter("e").map("e").forEach(function(e){Bt(e).filter(function(e){return!i[e.event_id]}).forEach(function(e){dt(e,!0,t),Et(e)&&(i[e.event_id]=1)})}),Kt.play(),rt()}}function Mt(){return(a?"h":"r")+s.id}function It(e){if(e.content.command)switch(e.content.command){case"dismiss notification":Xt.dismissSingleNotification(e.content.notification,!1);break;case"clear mention":Wt.dismissOtherRoomMention(e.content.roomid,e.content.messageid),e.content.roomid!==s.id||e.content.messageid||Qt.clear(!0);break;case"leave all":window.location.href="/"}}function Rt(){var e=$("#input").val(),t=e.split(/[\n\r]/g),s=!1,n=!1;$.each(t,function(e,t){t.match(/^ {4,}/)?s=!0:n=!0}),s&&!n?$.each(t,function(e,s){t[e]=s.substring(4)}):$.each(t,function(e,s){t[e]="    "+s}),e=t.join("\n"),r(e)}function At(e){if(!e&&!qs)return!1;var t=j();if(0==t.length)return e?qt():!1;if(!qs)return!1;var s=t.closest(".monologue");if(!s.hasClass("mine"))return!1;var n=$("#input"),i=n.val();if(i!=t.data("source"))return!1;if(n.caret().start<i.length)return!1;var a=e?t.prev(".message"):t.next(".message");return a.length||(a=e?s.prevAll(".monologue.mine").first().find(".message:last"):s.nextAll(".monologue.mine").first().find(".message:first")),a.length?!CHAT.RoomUsers.current().is_moderator&&secondsSince(a.info("time"))>118?void 0:(x(),S(a),!0):!1}function Ot(){return At(!0)}function Ut(){return At(!1)
}function qt(){var e=$("#input").val(),t=$(".monologue.mine").last().find(".message").last();if(0==t.length||t.find("> .content > .deleted").length)return!1;var s=CHAT.RoomUsers.current().is_moderator||secondsSince(t.info("time"))<118;return e&&0!=$.trim(e).length||!t||!s?!1:(S(t),qs=!0,!0)}function Dt(){var e=$(".monologue.mine").last().find(".message").last(),t=CHAT.RoomUsers.current().is_moderator||secondsSince(e.info("time"))<120;e.length>0&&t?confirm("Delete your last message?")&&kt(e,"delete",null,function(e){yt(e)}):Jt("Last message can't be deleted.")}function Nt(e){var n=$("#input");tabCompleter(n,t,e,s.id),n.bind("keydown",function(e){var t=!1;if(229!=e.which){switch(qs=qs&&(38==e.which||40==e.which),e.which){case 13:e.shiftKey||i||(bt(),t=!0);break;case 27:n.val()||Qt.clear(),x(),t=!0;break;case 38:t=Ot();break;case 40:t=Ut();break;case 75:e.ctrlKey&&(Rt(),t=!0)}t&&e.preventDefault()}}).bind("paste keyup",wt),wt(),i||$(document).bind("keypress",function(e){if(!(e.ctrlKey||e.altKey||e.metaKey)){var t;e.which&&13!=e.which&&32!=e.which&&"input"!=(t=e.target.nodeName.toLowerCase())&&"textarea"!=t&&0==$(e.target).closest(".popup").length&&(t=String.fromCharCode(e.keyCode||e.which))&&(n.focus(),$.browser.mozilla&&r(n.val()+t))}})}function Lt(){$("#getmore").click(_);var e=function(){return CHAT.RoomUsers.current().is_moderator};Wt=Mobile(s,messageActionById,function(){return CHAT.RoomUsers.current().is_owner},i,{"notify":Jt},e,B,V),f(n),Kt={},Yt={},Qt=MobileReplyQueue(function(e){ss=e}),Zt={},Yt.broadcast=Yt.receive=Kt.play=Kt.queue=Kt.setIcc=Zt.add=function(){},Jt=Notifier(null,!0).notify,Xt={"notify":Jt,"dismissSingleNotification":function(){},"desktop":null},Yt.id="n/a",$("#sayit-button").click(function(){bt(),$("#cancel-editing-button").hide(),$("#gotomenu-main").show()}),Nt(e),$("#edit-last").click(function(e){qt()?($("#gotomenu-main").hide(),$(".mobile-menu").slideUp(200),$("#input").prop("disabled",!1).focus()):alert("Last message cannot be edited."),e.preventDefault()}),$("#delete-last").click(function(){$(".mobile-menu").slideUp(200),$("#input").prop("disabled",!1),Dt()}),$("#cancel-editing-button").click(function(){x(),$("#gotomenu-main").show()}),$.ajaxSetup({"error":function(e,t){var s;try{s=e.statusText}catch(n){s="unavailable"}debugMessage("AJAX request failed. Server response: "+s+". Error: "+t)},"cache":!1,"timeout":2e4})}function Ht(e){e&&(e=e.toString(),e&&e.length&&(r(e),bt()))}function Ft(){popupDismisser(),Yt=InterClientCommunicator(),Yt.receive(It),Xt=Notifier(Yt),Jt=Xt.notify,es=CrossTab(s.id),es.initSound(e.sound),es.initDesktopNotificatons(Xt.desktop),Kt=SoundManager(es),Qt=d(),Zt=FeedTicker(),$("#sayit-button").click(bt),$("#cancel-editing-button").click(x),$("#codify-button").click(Rt),$("#getmore").click(_);var a=$("#upload-file");if(a.length>0){var o=initFileUpload();a.click(function(){o.showDialog(Ht)})}$("#getmore-mine").click(y),$("#adm-delete").click(G),$("#adm-move").click(W),$("#sel-cancel").click(B);var r=function(){return CHAT.RoomUsers.current().is_moderator};if(Wt=Sidebar(s,messageActionById,function(){return CHAT.RoomUsers.current().is_owner},i,{"notify":Jt,"icc":Yt},r,B,V,e.may_bookmark),$(".action-link").live("click",L),$(".message .content").live("click",K),f(n),$("#active-user").data("user",t),u(),Nt(r),$.ajaxSetup({"error":function(e,t){var s;try{s=e.statusText}catch(n){s="unavailable"}debugMessage("AJAX request failed. Server response: "+s+". Error: "+t)},"cache":!1,"timeout":1e4}),$(".user-container .signature, .user-container > .username, .user-container .avatar").live("click",UserUi(t,s.id,Jt,s.host).showUserPopupMenu),$(window).focus(function(){fs=!0,ps=0,b(),Gt=$("#chat > div.monologue:last div.message:last")}),$(window).blur(function(){fs=!1;var e=$("#chat > div.monologue:last div.message:last");Gt&&e.get(0)==Gt.get(0)||(zt=e,$("#chat div.catchup-marker").each(function(){for(var e=3;e>0;e--)$(this).hasClass("catchup-marker-"+e)&&($(this).removeClass("catchup-marker-"+e),3>e?$(this).addClass("catchup-marker-"+(e+1)):$(this).removeClass("catchup-marker"))}),zt.closest(".monologue").addClass("catchup-marker catchup-marker-1"))}),$.browser.msie&&$(window).resize(function(){$("#input-area").css({"bottom":1}),$("#input-area").css({"bottom":0})}),t>0&&Xt.desktop){var l=$('<div class="sidebar-widget"/>').appendTo("#sidebar #widgets"),c=$("<a/>").attr("href","#");Xt.desktop()||(e.desktopNotify=!1);var h=function(){c.text((e.desktopNotify?"dis":"en")+"able desktop notification")};h(),c.click(function(){return e.desktopNotify?$.post("/users/desktopnotify",fkey({"value":!1}),function(){e.desktopNotify=!1,h()}):Xt.desktop({"callback":function(){Xt.desktop()?$.post("/users/desktopnotify",fkey({"value":!0}),function(){e.desktopNotify=!0,h()}):Jt('Desktop notification is blocked by your browser; <a href="/help/desktop-notifications">help me with this</a>')}}),!1}).appendTo(l)}}var Bt=window.Generator;CHAT.CURRENT_ROOM_ID=s.id,CHAT.CURRENT_USER_ID=t,CHAT.IS_MOBILE=i;var Vt,zt,Gt,Wt,Yt,Kt,Jt,Xt,Qt,Zt,es,ts,ss,ns,is={"MessagePosted":1,"MessageEdited":2,"UserEntered":3,"UserLeft":4,"RoomNameChanged":5,"MessageStarred":6,"DebugMessage":7,"UserMentioned":8,"MessageFlagged":9,"MessageDeleted":10,"FileAdded":11,"ModeratorFlag":12,"UserSettingsChanged":13,"GlobalNotification":14,"AccessLevelChanged":15,"UserNotification":16,"Invitation":17,"MessageReply":18,"MessageMovedOut":19,"MessageMovedIn":20,"TimeBreak":21,"FeedTicker":22,"UserSuspended":29,"UserMerged":30,"UserNameOrAvatarChanged":34},as=900,os=600,rs=3600,ls=i?0:5,ds=i?25:100,cs=ds,us=i?0:19,hs=0,ms=!0,fs=!0,ps=0,gs=0,vs=!0,ys=0,_s=!1,ws=0!=$("#input").length,$s=Throttler(),bs=IMAGE("ajax-loader.gif"),Cs=IMAGE("ImageNotFound.png"),ks=i?function(){return l()-(window.pageYOffset+(window.innerHeight||screen.height))}:function(){return l()-($(window).scrollTop()+$(window).height())};!function(){var e=0;ns=function(t,s,n){n||"object"!=typeof s||(n=s,s=null),n=n||{},n.axis=h();var i=n.onAfter;n.onAfter=i?function(){setTimeout(function(){e--},0),i.apply(this,arguments)}:function(){setTimeout(function(){e--},0)},e++,null===s?$.scrollTo(t,n):$.scrollTo(t,s,n)},$(window).scroll(function(){var t;if(vs||(m(),t=!0),!e){var s=$(document).height();if(Ss!==s)return Ss=s,void 0;t||m(),$(window).trigger("manualScroll")}}),window.setInterval(function(){Ss=$(document).height(),!e&&vs&&ks()>1&&ns($("#bottom"),i?0:ys)},1e3)}();var Ts,Ss=$(document).height(),xs="[.\\w]+",js=new RegExp("^https?://(?:(?:www\\.)?(?:amazon|javari|endless)\\.\\w+\\S*(?:/dp/|/gp/product/|/ASIN/)|(?:www\\.)?amzn\\.com/(?:[\\d\\w]{3,})|area51.stackexchange.com/proposals/\\d+|"+xs+"/rooms/(\\d+)/conversation/[\\w-]|careers.stackoverflow.com/jobs/\\d+|gist\\.github\\.com/\\d+|\\S+\\.(?:jpe?g|png|gif|bmp|svg)$|(?:bugs\\.)?(?:edge\\.)?launchpad\\.net/(?:[^/]*/\\+bug|bugs)/(\\d+)|"+xs+"/(?:transcript|chats)/(?:message/\\d+|\\d+\\?m=)|"+xs+"/rooms/\\d+(?:/[^/]*)?$|"+xs+"/(?:q|a|questions|users)/\\d+(?:$|[?#/])|(?:www\\.)?twitter\\.com/(?:#!/)?[\\w_]+|identi\\.ca/notice/\\d+|trello\\.com/c(?:ard)?/|twitpic\\.com/\\w+|manpages\\.ubuntu\\.com/manpages/.+\\.html|[a-z-]{2,15}\\.wikipedia\\.org/wiki/\\S+|(?:www\\.)?(xkcd|xckd)\\.(?:com|org)/\\d+|(?:www\\.)?youtu(?:\\.be|be\\.com)/.+|blog\\.(?:serverfault|stackoverflow|stackexchange|superuser)\\.com/(?:post/|\\d{4})|[a-z0-9]+.blogoverflow.com/([0-9]{4})/([0-9]{1,2})/([^/]+?)/?|blog.[a-z0-9]+.stackexchange.com/([0-9]{4})/([0-9]{1,2})/([^/]+?)/?)","i"),Es=/\[\S+\](?!\()/,Ps=/^mac/i.test(navigator.platform),Ms=Ps?"metaKey":"ctrlKey";Ps&&$("#message-control-modifier-key").text("Command");var Is,Rs,As,Os={},Us=function(){var e=!1,t=!1,s=null,n=function(){var n="";t?n="This message is now too old to be edited. ":"number"==typeof s&&(n="You have less than "+s+" seconds left for editing. "),e&&(n+="This message is too long."),n.length?$("#inputerror").text(n).fadeIn():$("#inputerror").fadeOut()};return{"clear":function(){e=!1,t=!1,s=null,n()},"tooLong":function(t){e=t,n()},"secondsLeft":function(e){return null===e?(t=!1,s=null,n(),void 0):(e=0|e,e>0?(s=e,t=!1):t=!0,n(),void 0)}}}(),qs=!0,Ds=$("#flag-count").length>0;$(window).bind($.browser.opera?"unload":"beforeunload",function(){return c()||Wt.isLeaving?void 0:"This will lose your unsent message; continue?"}).bind("unload",function(){Vt.windowClosing(),Xt.desktop&&Xt.desktop.removeAll()}),$("#chat").hide(),$("#mini-help").click(function(e){e.preventDefault(),e.stopPropagation();var t=$("<div/>"),s=$("<a/>").html("More&hellip;").attr("href",$(this).attr("href"));popUp(e.pageX,e.pageY).addClass("mini-help").append(t).append(s).css("bottom",null).css("right",null),t.load("/faq #mini-help")}),e.egg?Eggs.load(e.egg):delete Eggs.load,i?Lt():Ft(),setTimeout(function(){if(o)for(var e in o)if(o.hasOwnProperty(e)){var t=o[e];e=parseInt(e,10),t==s.id?Qt.add(e):Wt.otherRoomMention(t,e)}delete o},0);var Ns={"onData":Pt,"onProblem":function(){Jt("There seems to be a problem connecting to the server. Please check your internet connection and reload this page.","server-connect")},"onProblemResolved":function(){var e=$("body > div.notification .notification-message.server-connect");e.length>0&&Xt.dismissSingleNotification(e.text(),!1)},"getPollingDelay":function(){return 1e3*$s.get_rate()},"useWebsocket":e.ws,"roomId":s.id,"roomKey":Mt()};a||(Ns.icc=Yt),pt().done(function(){Ns.lastKnownId=hs,Vt=TheThingThatGetsDataFromTheServer(Ns)}),nt(null,!0),it(null,!0),Wt.updateFiles();var Ls=moderatorTools(Jt);return{"sidebar":Wt,"initFlagSupport":Ls.initFlagSupport}}function now(){return(new Date).getTime()/1e3+SERVER_TIME_OFFSET}function secondsSince(e){return now()-e}function localTimeSimple(e){var t=new Date(1e3*e),s=t.getMinutes(),n=(new Date).setHours(0,0,0,0)/1e3,i=t.getHours()+":"+(10>s?"0":"")+s;return n-e>0&&(i=86400>n-e?"yst "+i:518400>n-e?weekday_name[t.getDay()]+" "+i:month_name[t.getMonth()]+" "+t.getDate()+", "+i),i}function plural(e,t,s){return s?e+" "+t+(1!=e?"s":""):e+t.substr(0,1)}function timeSpanString(e,t,s,n){if(n=n||"",60>e)return plural(Math.round(e),"second",t)+n;if(3600>e)return plural(Math.round(e/60),"minute",t)+n;if(86400>e)return plural(Math.round(e/3600),"hour",t)+n;var i=Math.round(e/86400);if(2>=i||!s)return plural(i,"day",t)+n;var a=s.getMinutes(),o=month_name[s.getMonth()].toLowerCase()+" "+s.getDate()+" at "+s.getHours()+":"+(10>a?"0":"")+a;return i>330&&(o=o.replace(" at "," '"+(""+s.getFullYear()).substr(2,2)+" at ")),o}function ToRelativeTimeMini(e,t){var s=secondsSince(e),n=null;return t&&(n=new Date(1e3*e)),0>=s?"just now":timeSpanString(s,!1,n," ago")}function Throttler(){function e(e,t){e=e||now(),(!t||e>r)&&(r=e)}function t(t,s){t=t||now(),(!s||t>l)&&(l=t),e(t,s)}function s(){var e=Math.max(0,secondsSince(r)),t=Math.max(0,secondsSince(l));if(e>=a||t>=o)return i;var s=e/a,d=t/o,c=1-(1-s)*(1-d);return n+(i-n)*c}var n=2,i=15,a=1200,o=1800,r=now(),l=now();return{"get_rate":s,"report_happening":e,"report_speaking":t}}function debugMessage(e){$("<div class='debug-message'/>").text(e).prependTo($("#debug-messages")),$("#debug-message-container > h2").text("Debug ("+$(".debug-message").length+")"),$("#debug-messages:hidden").next().css({"color":"red"})}function UserUi(e,t,s){function n(e,t){$.ajax({"type":"POST","url":"/users/invite","data":fkey({"UserId":e,"RoomId":t}),"success":function(e){s&&s(e)},"dataType":"text","error":function(e,t){s&&s("error"==t?409==e.status?e.responseText:"An error occurred performing this action":t)}})}function i(e){var t=/^invite-(\d+)-(\d+)/.exec($(this).closest("li").attr("id")),s=parseInt(t[1]),i=parseInt(t[2]);e.preventDefault(),n(s,i),$(this).closest(".popup").remove()}function a(n){if(0==n.button&&!n.ctrlKey){n.stopPropagation(),n.preventDefault();var a=$(this).closest(".user-container").data("user"),o=CHAT.RoomUsers.getIfAvailable(a),r=CHAT.RoomUsers.current(),l=(o||{"name":""}).name,d=popUp(n.pageX,n.pageY).addClass("user-popup");if(!a)return d.append("<p>no user data available</p>"),void 0;var c=$("<a/>"),u=$("<img/>").attr("src",IMAGE("ajax-loader.gif")),h=$("<h4/>").addClass("username");h.text(l),c.appendTo(d),u.appendTo(c),h.appendTo(d);var m="/users/thumbs/"+a;$.getJSON(m,{"showUsage":!0},function(n){if(null!=n){CHAT.RoomUsers.update(a,{"name":n.name,"is_moderator":n.is_moderator,"email_hash":n.email_hash,"reputation":n.reputation},!1,!0),h.text(n.name).attr("title",repNumber(n.reputation)),n.is_moderator&&h.append("<span> &#9830;</span>"),h.addClass("username"),n.is_moderator&&h.addClass("moderator"),n.email_hash?u.attr("src",gravatarUrl(a,n.email_hash,48)).addClass("user-gravatar48"):u.remove(),n.site&&$("<img/>").attr("width",16).attr("height",16).attr("src",n.site.icon).addClass("small-site-logo").attr("alt",n.site.caption).attr("title",n.site.caption).appendTo(d),d.append("<br style='clear:both;'/>"),n.user_message&&n.user_message.length>0&&$("<p/>").text(n.user_message).appendTo(d),n.usage&&n.usage.length>0&&d.append(n.usage);var l=[];if(n.last_seen&&a>0&&l.push("seen <b>"+ToRelativeTimeMini(n.last_seen)+"</b>"),n.last_post&&l.push("talked <b>"+ToRelativeTimeMini(n.last_post)+"</b>"),l.length&&d.append("<div class='last-dates'>"+l.join(", ")+"</div>"),n.issues){var m=n.issues>1?"s":"";d.append($("<div/>").append($("<a/>").text(n.issues+" annotation"+m+"/suspension"+m).attr("href","/admin/annotations/"+a).css("font-weight","bold")))}var f="/users/"+n.id+"/"+urlFriendly(n.name);if(d.append($("<div/>").append($("<a/>").text("user profile").attr("href",f))),c.attr("href",f),n.profileUrl&&n.profileUrl.length>0&&d.append($("<div/>").append($("<a/>").text("user profile on "+n.host).attr("href",n.profileUrl))),n.rooms&&n.rooms.length){d.append("<h5>Rooms</h5>");var p=$("<ul/>").addClass("no-bullets");$.each(n.rooms,function(e,t){p.append($("<li/>").append($("<a/>").text(t.name).attr("href","/rooms/"+t.id+"/"+urlFriendly(t.name)).attr("target","_self").attr("title",t.activity+" posts total"+(t.last_post?"; last post "+ToRelativeTimeMini(t.last_post):""))))}),d.append(p)}if(n.id!=e){if(d.append("<h5>Actions</h5>"),n.invite_targets&&n.invite_targets.length){var g=$("<div/>").appendTo(d),v=($("<a/>").html("invite this user&hellip;").appendTo(g).attr("href","#").click(function(e){$(this).next().slideToggle(),e.preventDefault()}),$("<ul/>").addClass("no-bullets").appendTo(g).hide());$.each(n.invite_targets,function(e,s){var n=s.name;s.id==t&&(n="<b>"+n+"</b>"),v.append($("<li/>").attr("id","invite-"+a+"-"+s.id).append($("<a/>").html("&hellip;to "+n).attr("href","#").click(i)))})}a>0&&o&&!o.is_moderator&&r&&r.is_owner&&n.is_registered&&d.append($("<div/>").append($("<a/>").text((o.is_owner?"remove":"add")+" as room-owner").attr("href","#").click(function(){return $.post("/rooms/setuseraccess/"+t,fkey({"aclUserId":a,"userAccess":o.is_owner?"read-write":"owner"}),function(e){e&&e.length>0?s(e):(o.is_owner=o.is_owner?!1:!0,$(".user-container.user-"+a+" .username").toggleClass("owner"))}),d.remove(),!1}))),n.may_pairoff&&d.append($("<div/>").append($("<a/>").text("start a new room with this user").attr("href","#").click(function(e){e.preventDefault(),promptUser(e,"<p>To create a new room and automatically invite this user, please enter a name for the new room.</p><p>Please note that the room will be public, and anybody can join your conversation.</p><p>You will automatically enter the new room upon creation.</p>","Room for "+r.name+" and "+n.name,function(e){$.post("/rooms/pairoff",fkey({"withUserId":n.id,"name":e}),function(e){e&&/^\d+$/.test(e)&&(window.location.href="/rooms/"+e)})})}))),d.append($("<div/>").append($("<a/>").text(shouldShowUser(n.id)?"hide posts":"show posts").attr("href","#").click(function(){return showHideForUser(n.id,shouldShowUser(n.id)),d.remove(),!1}))),e>0&&d.append($("<div/>").append($("<a/>").text(shouldShowUser(n.id)?"ignore this user (everywhere)":"don't ignore this user").attr("href","#").click(function(){return $.post("/users/ignorelist/"+(shouldShowUser(n.id)?"add":"remove"),fkey({"id":n.id})),showHideForUser(n.id,shouldShowUser(n.id),!1,!0),d.remove(),!1}))),n.id>0&&!n.is_moderator&&r.is_owner&&d.append($("<div/>").append($("<a/>").text("kick-mute this user").attr("href","#").click(function(e){e.preventDefault(),window.confirm("Do you want to kick "+n.name+" out of this room? A high number of kicks may be reported to moderators.")&&($.post("/rooms/kickmute/"+t,fkey({"userId":n.id})).done(function(e){e&&e.message&&s(e.message)}).fail(function(e,t){var n="error"==t?409==e.status?e.responseText:"An error occurred while trying to kick this user.":t;s(n)}),d.close())})))}}})}}return{"showUserPopupMenu":a}}function showHideForUser(e,t,s,n){if(e){e=e.toString();var i=hiddenUsers[e];if(s||!(i&&t||!i&&!t)){hiddenUsers[e]=t,$(".monologue.user-"+e).each(function(){showHideMonologue(this,t,n)});var a=$("#present-user-"+e);t?a.addClass("ignored"):a.removeClass("ignored")}}}function showHideMonologue(e,t,s){var n=$(e).andSelf();t?n.hide(s?500:0):n.show(s?500:0)}function shouldShowUser(e){var t=e&&hiddenUsers[e.toString()];return t?!1:!0}function promptUser(e,t,s,n,i,a,o){var r=popUp(e.pageX,e.pageY);$("<div/>").html(t).appendTo(r);var l,d;d=o?function(e){var t=o(e)||"";return r.find(".error").remove(),t.length?($("<div/>").text(t).addClass("error").appendTo(r),r.find(".button").addClass("disabled"),!1):(r.find(".button").removeClass("disabled"),!0)}:function(){return!0},l=i?$("<textarea/>").keypress(function(){d(l.val())}):$("<input/>").attr("type","text").keypress(function(e){var t=l.val(),s=d(t);s&&13==e.which&&(n(t),r.close())}),l.val(s||"").appendTo(r),a&&a(l),$("<p><span class='button'>OK</span></p>").appendTo(r).click(function(){var e=l.val();d(e)&&(n(e),r.close())}),s&&l.caret(0,s.length),d(s||""),r.show()}function runTests(){test_functions={"chatContainsOnlyMonologuesAndSystemMessages":function(){var e=!0;return $("#chat").children().each(function(){$(this).hasClass("monologue")||$(this).hasClass("system-message-container")||($(this).addClass("failed-test"),e=!1)}),e},"userContainerDataAndClassMatch":function(){var e=!0;return $(".user-container").each(function(){$(this).hasClass("user-"+$(this).data("user"))||($(this).addClass("failed-test"),e=!1)}),e},"eachCollapsibleHasOneMoreLink":function(){var e=!0;return $(".collapsible").each(function(){1!=$(this).closest(".sidebar-widget").find(".more").length&&($(this).addClass("failed-test"),e=!1)}),e},"eachMessageHasIdAndTime":function(){var e=!0;return $(".message").each(function(){/^message-\d+$/.test($(this).attr("id"))&&void 0!=$(this).info("time")||($(this).addClass("failed-test"),e=!1)}),e},"monotoneMessageTimeAndId":function(){var e=!0,t=0,s=0;return $(".message").not(".pending").each(function(){var n=$(this).info("time"),i=$(this).attr("id").replace("message-","");(1*t>1*n||1*s>=1*i)&&($(this).addClass("failed-test"),e=!1),t=n,s=i}),e},"enoughTimeStamps":function(){var e=!0,t=0;return $(".message").not(".pending").each(function(){var s=$(this).info("time");s-t>600&&1!=$(this).closest(".monologue").find(".timestamp").length&&($(this).addClass("failed-test"),e=!1),t=s}),e}},$.each(test_functions,function(e,t){debugMessage(e+": "+(t()?"success":"failure"))})}function findCacheLeaks(){var e=total=handlers=0;for(var t in $.cache){total++,"events"in $.cache[t]&&handlers++;var s=$("["+$.expando+"="+t+"]");0==s.length&&t!=document[$.expando]&&$.cache[t]!=$(window).data()&&(e++,console.log(t),console.log($.cache[t]))}debugMessage(e+" out of "+total+" cache entries are for elements that aren't in the dom, "+handlers+" have event handlers")}function initTranscript(e,t,s,n,i,a){function o(){var e=$(this).closest(".message"),t=e.attr("id").replace("message-",""),s=$("<div/>").insertAfter(e.find(".content")),n=$("<img/>").attr("src",IMAGE("ajax-loader.gif")).appendTo(s);$.get("/message/"+t+"?plain=true",function(e){n.hide();var i=$("<textarea/>").css({"width":"80%","height":50,"float":"left"}).val(e).appendTo(s);$("<button/>").addClass("button").css({"float":"left","marginLeft":5}).text("save").appendTo(s).click(function(){var e=i.val();n.show(),$.ajax({"type":"POST","url":"/messages/"+t,"data":fkey({"text":e}),"success":function(){var e=PERMALINK(t);location.href.search(e)>=0?window.location.reload(!0):window.location.href=e},"error":function(){p("Editing the message has failed."),n.hide()}})}),$("<button/>").addClass("button").css({"float":"left","marginLeft":5}).text("cancel").appendTo(s).click(function(){s.remove()}),$("<div/>").addClass("clear-both").appendTo(s)})}function r(){var e=$(this).closest(".message").attr("id").replace("message-","");try{localStorage.setItem("chat:draft:"+i,":"+e+" ")}catch(t){return alert("Your browser needs to support localStorage in order to reply from the transcript."),void 0}var s=$("#join-room").attr("href");location.href=s}function l(t){t.stopPropagation(),t.preventDefault();var i=$(this).closest(".message"),l=i.closest("#admin-flags");l=null!=l&&l.length>0;var f,p=popUp(t.pageX,t.pageY,i,l),v=[],y=$("<div/>").appendTo(p),_=i.attr("id").replace("message-","");if(y.html('<a href="'+PERMALINK(_)+'">permalink</a> | <a href="/messages/'+_+'/history">history</a><br/>'),!i.find(".deleted").length){var w=$(this).closest(".monologue").hasClass("mine");a&&g&&!w&&($("<span/>").addClass("reply").html('<span class="newreply"> </span> reply to this message').attr("title","enter the room and reply to this message").appendTo(p).click(r),p.append("<br/>")),i.hasClass("user-star")?(f="unstar",v.push("starred")):f="star",n&&!w&&$("<span/>").addClass("star").html('<span class="sprite sprite-icon-star"> </span>'+f+" as interesting").click(h).click(p.close).attr("title","Add a star to indicate an interesting message, for example to display in the room's highlights").appendTo(p),i.hasClass("user-star")?(f="unpin",v.push("pinned")):f="pin",e&&(p.append("<br/>"),$("<span/>").addClass("star").html('<span class="sprite sprite-ownerstar-on"> </span>'+f+" this message").click(u).click(p.close).attr("title","Pinning is like adding a star, but pinned items takes priority; this option is only available to the room owner.").appendTo(p));var b=i.hasClass("user-flag");b&&v.push("flagged"),v.length>0&&y.html(y.html()+"You have "+v.join(" and ")+" this message.<br/>"),b||!n||w||(p.append("<br/>"),$("<span/>").addClass("flag").html('<span class="sprite sprite-icon-flag"> </span> flag as spam/offensive').click(m).click(p.close).attr("title","Flagging a message helps bring inappropriate content to the attention of moderators and other users, for example spam or abusive messages.").appendTo(p)),s&&(p.append("<br/><br/>"),$("<span/>").addClass("edit").text("edit").click(o).click(p.close).attr("title","click to edit").appendTo(p),i.find(".flag-indicator").length>0&&(p.append(" | "),$("<span/>").addClass("edit").text("cancel flags").click(d).click(p.close).attr("title","Cancel the flags against this message").appendTo(p)),p.append(" | "),$("<span/>").addClass("edit").text("delete").click(c).click(p.close).attr("title","Delete this message").appendTo(p)),p.append("<br/><br><small>(changes will not show until you reload)</small>")}}function d(){var e=$(this).closest(".message"),t=e.attr("id").replace("message-","");confirm("Cancel the flags for this message?")&&$.post("/messages/"+t+"/unflag",fkey(),function(){e.find(".flag-indicator").remove()})}function c(){var e=$(this).closest(".message"),t=e.attr("id").replace("message-","");confirm("Delete this message?")&&$.post("/messages/"+t+"/delete",fkey(),function(){var t=e.closest(".monologue-row");t&&t.length||(t=e.closest(".monologue")),e.remove(),0==t.find(".message").length&&t.remove()})}function u(){var e=$(this).closest(".message");messageActionById(e.attr("id").replace("message-",""),e.hasClass("owner-star")?"unowner-star":"owner-star",null,function(){e.hasClass("owner-star")?e.removeClass("owner-star"):e.addClass("owner-star")},p)}function h(){var e=$(this).closest(".message");messageActionById(e.attr("id").replace("message-",""),e.hasClass("user-star")?"unstar":"star",null,function(){e.hasClass("user-star")?e.removeClass("user-star"):e.addClass("user-star")},p)}function m(){if(confirmFlag(s)){var e=$(this).closest(".message");messageActionById(e.attr("id").replace("message-",""),"flag",null,function(){e.addClass("user-flag")},p)}}function f(e,t){var s=$("#main"),n=s.hasClass("select-mode");b&&b(null),b=e&&t?t:null,void 0==e&&(e=!n),$("#transcript div.message.selected").removeClass("selected"),e||!n?(s.addClass("select-mode"),$.browser.msie&&$("#transcript *").each(function(){this.unselectable="on"})):(!e||n)&&(s.removeClass("select-mode"),$.browser.msie&&$("#transcript *").each(function(){delete this.unselectable}))}var p=Notifier().notify,g=!1;try{localStorage.getItem("test"),g=!0}catch(v){}if(window.location.hash&&window.location.hash.length>1)$(window.location.hash).addClass("highlight");else{var y=$(".highlight");y.length>0&&$.scrollTo(y,{"offset":-100})}$.preload(".message img.user-image",{"placeholder":IMAGE("ajax-loader.gif"),"notFound":IMAGE("ImageNotFound.png")}),$(".action-link").click(l).find(".img").addClass("menu"),$(".message:has(a.reply-info)").live("hover",function(e){var t=$(this).find("a.reply-info").attr("href").replace(/^.*#/,"");"mouseenter"==e.type?$("#message-"+t).addClass("reply-parent"):$("#message-"+t).removeClass("reply-parent")}),$(".message > .content").each(function(){var e=$(this).html(),t=handleQuoteMessage(e);e!==t&&$(this).html(t)}),$(".message > .content > .partial").each(function(){var e=$(this),t=$("<a/>").addClass("more-data").text("(see full text)").attr("href","/messages/"+i+"/"+e.closest(".message").attr("id").replace("message-",""));t.click(function(s){if(0==s.button&&!s.ctrlKey){var n=$("<span/>").html("loading&hellip;");n.insertAfter($(this).hide()),$.ajax({"type":"GET","url":$(this).attr("href"),"success":function(s){if(e.removeClass("partial").addClass("full"),e.is("pre"))e.html(s.replace(/^    /gm,""));else{var i="<div class='full'>"+s.toString().replace(/^:\d+ /,"").replace(/\r\n?|\n/g," <br> ")+"</div>";e.replaceWith(handleQuoteMessage(i))}n.add(t).remove()}}),s.preventDefault()}}),e.closest(".content").append(" ",t)}),$(".signature .username a").each(function(){$(this).attr("title",$(this).text())}),initSearchBox();var _=$("#sidebar .room-mini .room-current-user-count");if(_.length>0){var w=_.text();w&&w.length>0&&$("#sidebar #join-room").text("join "+("1"==w?"1 user":w+" users")+" in this room now")}var b;if($(".message .content").live("click",function(e){if($("#main").hasClass("select-mode")){e.preventDefault(),e.stopImmediatePropagation();var t=$(this).closest(".message");b&&b(t)}}),$("#bookmark-button").length){var C=ConversationSelector(i,f,p,$("#transcript"),!0);$("#bookmark-button").click(function(e){e.preventDefault(),C.Dialog()})}return{"notify":p}}function Mobile(e,t,s,n,i){function a(e,t){var s=e.parent().find(".menupager");void 0==t&&(t=parseInt(s.find(".menupager-page").text())-1||0);var n=e.find("li"),i=Math.ceil(n.length/5);t=Math.max(0,Math.min(i-1,t)),n.hide(),n.slice(5*t,5*(t+1)).show(),s.setVisible(i>1),s.find(".menupager-prev").setVisible(t>0),s.find(".menupager-next").setVisible(i-1>t),s.find(".menupager-pagecount").text(i),s.find(".menupager-page").text(t+1)}function o(){return(g.isLeaving||confirm("Do you want to leave this room?"))&&$.post($(this).attr("href"),fkey({"quiet":!0}),function(){window.location="/"}),!1}function r(){if($(this).hasClass("quickleave")){var e=$(this).closest("li"),t=e.find("h3").text();if(!confirm("Do you want to leave "+t+"?"))return}var s=e.attr("id").replace("room-","");$.post("/chats/leave/"+s,fkey({"quiet":!0})),h(s)}function l(e,t,s,n,i,o){var r=$("#room-"+e);if(0==r.length){r=$("<li/>").attr("id","room-"+e),t=t||"(unknown)";var l=$("<tr/>").appendTo($("<table/>").appendTo(r)),d=$("<td/>").appendTo(l);$("<a class='button quickswitch'/>").appendTo(d).attr("href","/rooms/"+e+"/"+urlFriendly(t)).text("go"),$("<span class='quickleave button'/>").appendTo(d).text("leave");var c=$("<div/>").append($("<h3/>").text(t)).appendTo($("<td/>").appendTo(l));c.append($("<span/>").text(s?s+", ":"")).append($("<span/>").addClass("time-since-activity").text(ToRelativeTimeMini(i))),r.append(div("room-info").append(div("last-message").append(span("user-name"),": ",span("text"),div("time data"))))}var u=r.data("message_id")||0;o&&o>=u&&(arguments.length>2&&(r.find(".room-info > .last-message > .user-name").text(s),r.find(".room-info > .last-message > .text").text($("<span>"+(n||"")+"</span>").text()),r.find(".room-info > .last-message > .time").text(i),r.find("div:first > span:first").text(s?s+", ":""),r.find(".time-since-activity").text(ToRelativeTimeMini(i))),r.data("message_id",o)),r.prependTo("#my-rooms"),a($("#my-rooms"))}function d(){var e=$("#my-rooms > li:first .time.data");return e.length?parseInt(e.text()):1}function c(e){return $("#room-"+e).length?($("#room-"+e+", #gotomenu-otherrooms, #gotomenu-main").addClass("mention"),!0):!1}function u(e){$("#room-"+e).removeClass("mention"),0==$("#my-rooms > li.mention").length&&$("#gotomenu-otherrooms, #gotomenu-main").removeClass("mention")}function h(e){$("#room-"+e).remove(),a($("#my-rooms"))}function m(){$("#starred-posts ul").load("/chats/stars/"+e.id+"?count=3")}var f=(i.notify,$("#menu-container > div.mobile-menu"));$(".gotomenu").live("click",function(){var e=$(this).attr("id").replace(/(?:\d+-)?goto/,"single");"gotomenu-main"==$(this).attr("id")&&f.filter(":visible").length>0&&(e="none");var t=$("#"+e);switch(f.not(t).slideUp(200),e){case"singlemenu-people":a($("#present-users"),0);break;case"singlemenu-otherrooms":a($("#my-rooms"),0),$("#my-rooms li").each(function(){var e=$(this);e.find(".time-since-activity").text(ToRelativeTimeMini(e.find(".room-info > .last-message > .time").text()))})}t.slideDown(200),t.length>0?$("#input").attr("disabled","disabled"):$("#input").prop("disabled",!1),$(this).removeClass("mention")}),$(".menupager-prev, .menupager-next").live("click",function(){var e=$(this).closest(".menupager"),t=e.parent().find("ul"),s=parseInt(e.find(".menupager-page").text())-1;a(t,$(this).hasClass("menupager-prev")?s-1:s+1)}),$("#my-rooms span.quickleave").live("click",r),$("#leave").click(o);var p=function(){};Mobile.page=a;var g={"relayout":p,"leaveOtherRoom":h,"otherRoomActivity":l,"otherRoomMention":c,"updateStars":m,"updateFiles":p,"updateRoomMeta":p,"updateAdminCounters":p,"dismissOtherRoomMention":u,"lastOtherRoomMessageTime":d};return g}function MobileReplyQueue(e){function t(e){uniquePush(e),$("#message-"+e).addClass("new-reply")}function s(){return i.length}function n(){}var i=[];return uniquePush=function(e){$.inArray(e,i)<0&&i.push(e)},e(function(e,t){$.inArray(t,i)>=0&&e.addClass("new-reply")}),$(document).on("click",".message.new-reply",function(){$(this).removeClass("new-reply"),$.post("/messages/ack",fkey({"id":$(this).messageId()}))}),{"add":t,"len":s,"clear":n}}function ConversationSelector(e,t,s,n,i){function a(){try{window.localStorage.setItem(g,stringify({"roomId":e,"texts":f,"ids":p,"time":(new Date).getTime()}))}catch(t){return!1}return!0}function o(){var t;try{t=$.parseJSON(window.localStorage.getItem(g))}catch(s){return!1}return t&&t.roomId==e?(new Date).getTime()-t.time>6e5?!1:(f=t.texts,p=t.ids,!0):!1}function r(){f=[],p=[];try{window.localStorage.setItem(g,null)}catch(e){}}function l(){m.fadeOut(200,function(){$(this).remove()})}function d(){p.length<2?(n.find("div.message.selected").removeClass("selected"),1==p.length&&$("#message-"+p[0]).addClass("selected")):n.find("div.message").each(function(){var e=$(this),t=e.attr("id").replace("message-","");t<p[0]||t>p[1]?e.removeClass("selected"):e.addClass("selected")})}function c(e){if(null==e)return l(),void 0;if(!e.find(".deleted").length){var t=parseInt(e.attr("id").replace("message-","")),s=e.find(".content").text();if(p.length<2)p.push(t),f.push(s);else{var n=Math.abs(p[0]-t)<Math.abs(p[1]-t)?0:1;p[n]=t,f[n]=s}p[0]==p[1]?(f.pop(),p.pop()):p[0]>p[1]&&(p.push(p.shift()),f.push(f.shift())),d(),h(),a()
}}function u(){function n(){g.show(),u.hide(),$.ajax({"type":"POST","url":"/conversation/new","data":fkey({"roomId":e,"firstMessageId":p[0],"lastMessageId":p[1],"title":l.val()}),"success":function(e){e.ok?(s(e.message),r(),t(!1)):u.text(e).css("color","red"),g.hide(),u.show()},"error":function(e){var t=GENERIC_ERROR;e.responseText.length<50&&(t=e.responseText),u.text(t).css("color","red"),g.hide(),u.show()},"dataType":"json"})}t(!0,c),$(".popup:not(.mini-help)").fadeOut(200,function(){$(this).remove()}),m=$('<div id="conversation-sel"/>').css({"width":300,"right":200,"top":200}).appendTo("body"),m.append("<h2>Bookmark a conversation</h2><p>A conversation is a chronological thread of chat messages that you can select, give a title to, and share.</p><p>Please <b>click the two messages</b> that define the <b>start</b> and the <b>end</b> of the conversation.</p>"),first=$("<div/>").css({"fontWeight":"bold","marginLeft":10}),last=$("<div/>").css({"fontWeight":"bold","marginLeft":10}),m.append($("<p>First message:</p>").append(first).hide(),$("<p>Last message:</p>").append(last).hide());{var i=$('<div><p>Give the conversation a title:</p><input type="text" /></div>').hide().appendTo(m),a=$('<button class="button"/>').text("bookmark").hide().appendTo(i),l=i.find("input").css("width",250),u=$("<div/>").appendTo(m).hide(),g=$("<img/>").attr("src",IMAGE("ajax-loader.gif")).hide().appendTo(m);$('<button class="button"/>').text("cancel").appendTo(m).click(function(){r(),t(!1)})}$("<span>&nbsp;</span>").appendTo(m);{var v=$('<button class="button"/>').text("clear").css("display","none").appendTo(m).click(function(){r(),h(),d()});$("<div class='btn-close'>X</div>").prependTo(m).click(function(){t(!1)})}l.bind("change keyup click",function(e){var t=$(this).val().length>0;a.setVisible(t),"keyup"==e.type&&13==e.which&&t&&n()}),a.click(n),h=function(){f[0]?(first.text(f[0].substr(0,50)),first.closest("p").show()):(first.text(""),first.closest("p").hide()),f[1]?(last.text(f[1].substr(0,50)),last.closest("p").show()):(last.text(""),last.closest("p").hide()),i.setVisible(2==p.length),v.css("display",p.length>0?"inline":"none")},o(),d(),h()}var h,m,f=[],p=[],g="chat:conversationSelection";return i&&o()&&u(),{"Dialog":u}}function ConversationViewer(){$("#participants li").click(function(){$(this).toggleClass("selected");var e=$("#participants li.selected").length;if(e>0&&e<$("#participants li").length){var t=["div.system-message-container"],s=[];$("#participants li").each(function(){var e="div.monologue."+$(this).attr("id").replace("participating-","");$(this).hasClass("selected")?s.push(e):t.push(e)}),$(s.join(","),"#conversation").slideDown(),$(t.join(","),"#conversation").slideUp(),$("#conversation div.timestamp").fadeOut()}else $("div.monologue, div.system-message-container","#conversation").slideDown(),$("#conversation div.timestamp").fadeIn()})}function initFileUpload(){var e={};e.removeEvent=function(e,t,s){e.detachEvent?e.detachEvent("on"+t,s):e.removeEventListener(t,s,!1)},e.addEvent=function(e,t,s){e.attachEvent?e.attachEvent("on"+t,s):e.addEventListener(t,s,!1)};var t=top.document;return e.getPageSize=function(){var e,s,n,i;self.innerHeight&&self.scrollMaxY?(e=t.body.scrollWidth,s=self.innerHeight+self.scrollMaxY):t.body.scrollHeight>t.body.offsetHeight?(e=t.body.scrollWidth,s=t.body.scrollHeight):(e=t.body.offsetWidth,s=t.body.offsetHeight),self.innerHeight?(n=self.innerWidth,i=self.innerHeight):t.documentElement&&t.documentElement.clientHeight?(n=t.documentElement.clientWidth,i=t.documentElement.clientHeight):t.body&&(n=t.body.clientWidth,i=t.body.clientHeight);var a=Math.max(e,n),o=Math.max(s,i);return[a,o,n,i]},e.isIE_5or6=/msie 6/.test(top.navigator.userAgent.toLowerCase())||/msie 5/.test(top.navigator.userAgent.toLowerCase()),e.isIE=/msie/.test(top.navigator.userAgent.toLowerCase()),e.createBackground=function(){var s=t.createElement("div");return s.className="wmd-prompt-background",style=s.style,style.position="fixed",style.top="0",style.zIndex="1000",e.isIE?style.filter="alpha(opacity=50)":style.opacity="0.5",e.isIE?(style.left=t.documentElement.scrollLeft,style.width=t.documentElement.clientWidth,style.height=t.documentElement.clientHeight):(style.left="0",style.width="100%",style.height="100%"),t.body.appendChild(s),s},e.getHeight=function(e){return e.offsetHeight||e.scrollHeight},e.getWidth=function(e){return e.offsetWidth||e.scrollWidth},e.getPageSize=function(){var e,s,n,i;self.innerHeight&&self.scrollMaxY?(e=t.body.scrollWidth,s=self.innerHeight+self.scrollMaxY):t.body.scrollHeight>t.body.offsetHeight?(e=t.body.scrollWidth,s=t.body.scrollHeight):(e=t.body.offsetWidth,s=t.body.offsetHeight),self.innerHeight?(n=self.innerWidth,i=self.innerHeight):t.documentElement&&t.documentElement.clientHeight?(n=t.documentElement.clientWidth,i=t.documentElement.clientHeight):t.body&&(n=t.body.clientWidth,i=t.body.clientHeight);var a=Math.max(e,n),o=Math.max(s,i);return[a,o,n,i]},e.uploadDialog=function(s){var n,i,a="upload-iframe-"+(new Date).getTime()+"-"+(1e5*Math.random()|0),o=function(e){var t=e.charCode||e.keyCode;27===t&&r(null)};n=$("<div style='top: 50%; left: 50%; display: block; padding: 10px; position: fixed; width:400px; z-index:1001' class='wmd-prompt-dialog'><div style='position: absolute; right: 20px; bottom: 5px; font-size: 10px;'>image hosting by <a title='imgur: the simple image sharer' href='http://imgur.com'>imgur.com</a></div><p><b>Insert an image</b></p><p style='padding-top: 10px;'><a href='#' class='wmd-mini-button selected' id='upload-image-button'>from my computer</a><a href='#' class='wmd-mini-button' id='upload-url-button'>from the web</a></p><iframe id='"+a+"' style='display:none;' src='about:blank' name='"+a+"'/><form action='/upload/image' method='post' enctype='multipart/form-data'><div style='position: relative' id='upload-file-input'>  <input type='file' name='filename' id='filename-input' value='browse' style='border:0; font-size:18px; position:relative; text-align:right; -moz-opacity:0; filter:alpha(opacity: 0); opacity: 0; z-index: 2;'>  <img src='//i.imgur.com/GKc7H.png' height='15px' width='15px' style='position: absolute; left: 38px; top: 6px;'>  <div style='position: absolute; top:0px; left:0px; z-index: 1;'>    <input type='input' name='shadow-filename' value='' id='shadow-filename' style='width: 180px; margin-left:64px;'>    <input class='button' type='button' name='choose-file' id='choose-file' value='browse&hellip;' style='width: 7em; margin-left: 5px;'>  </div></div><div id='upload-url-input' style='display:none;'>    <input type='input' name='upload-url' value='' style='width: 250px;'></div><p id='upload-message' style='padding-top: 4px; margin:0; line-height: 16px;'></p><div class='ac_loading' id='image-upload-progress' style='background-color: transparent; display:none;'>Uploading&hellip;</div><input class='button' type='submit' value='upload' style='width: 7em; margin: 10px;'><input class='button' type='button' value='cancel' id='close-dialog-button' style='width: 7em; margin: 10px 10px 20px;'></form></div>"),e.isIE_5or6&&(n[0].style.position="absolute",n[0].style.top=t.documentElement.scrollTop+200+"px",n[0].style.left="50%"),i=e.createBackground();var r=function(a){return e.removeEvent(t.body,"keydown",o),n.remove(),$(i).remove(),s&&s(void 0==a?null:a),!1};top.setTimeout(function(){$(t.body).append(n),$("#close-dialog-button").click(function(){r()});var s=$("#upload-image-button"),i=$("#upload-url-button"),l=$("#upload-url-input"),d=l.parent(),c=$("#upload-file-input");l.remove().show();var u=function(){$("#upload-message").text("click browse to choose an image from your computer")};u(),s.click(function(){return i.removeClass("selected"),s.addClass("selected"),u(),l.remove(),d.prepend(c),h(),!1}),i.click(function(){return s.removeClass("selected"),i.addClass("selected"),$("#upload-message").text("paste the URL of your image above"),d.prepend(l),c.remove(),!1});var h=function(){$("#filename-input").click(function(){this.blur()}),$("#filename-input").change(function(){$("#shadow-filename").val(this.value)})};h();$("#"+a)[0];n.find("form").submit(function(){return $("#upload-message").hide(),$("#image-upload-progress").show(),this.target=a,window.closeDialog=r,window.displayUploadError=function(e){$("#image-upload-progress").hide(),$("#upload-message").show().text(e)},!0}),n[0].style.marginTop=-(e.getHeight(n[0])/2)+"px",n[0].style.marginLeft=-(e.getWidth(n[0])/2)+"px",e.addEvent(t.body,"keydown",o)},0)},{"showDialog":e.uploadDialog}}window.CHAT={"RoomUsers":{}},function(e){"use strict";e(["jquery"],function(e){function t(t){return e.isFunction(t)||"object"==typeof t?t:{"top":t,"left":t}}var s=e.scrollTo=function(t,s,n){return e(window).scrollTo(t,s,n)};return s.defaults={"axis":"xy","duration":parseFloat(e.fn.jquery)>=1.3?0:1,"limit":!0},s.window=function(){return e(window)._scrollable()},e.fn._scrollable=function(){return this.map(function(){var t=this,s=!t.nodeName||-1!=e.inArray(t.nodeName.toLowerCase(),["iframe","#document","html","body"]);if(!s)return t;var n=(t.contentWindow||t).document||t.ownerDocument||t;return/webkit/i.test(navigator.userAgent)||"BackCompat"==n.compatMode?n.body:n.documentElement})},e.fn.scrollTo=function(n,i,a){return"object"==typeof i&&(a=i,i=0),"function"==typeof a&&(a={"onAfter":a}),"max"==n&&(n=9e9),a=e.extend({},s.defaults,a),i=i||a.duration,a.queue=a.queue&&a.axis.length>1,a.queue&&(i/=2),a.offset=t(a.offset),a.over=t(a.over),this._scrollable().each(function(){function o(e){d.animate(u,i,a.easing,e&&function(){e.call(this,c,a)})}if(null!=n){var r,l=this,d=e(l),c=n,u={},h=d.is("html,body");switch(typeof c){case"number":case"string":if(/^([+-]=?)?\d+(\.\d+)?(px|%)?$/.test(c)){c=t(c);break}if(c=h?e(c):e(c,this),!c.length)return;case"object":(c.is||c.style)&&(r=(c=e(c)).offset())}var m=e.isFunction(a.offset)&&a.offset(l,c)||a.offset;e.each(a.axis.split(""),function(e,t){var n="x"==t?"Left":"Top",i=n.toLowerCase(),f="scroll"+n,p=l[f],g=s.max(l,t);if(r)u[f]=r[i]+(h?0:p-d.offset()[i]),a.margin&&(u[f]-=parseInt(c.css("margin"+n))||0,u[f]-=parseInt(c.css("border"+n+"Width"))||0),u[f]+=m[i]||0,a.over[i]&&(u[f]+=c["x"==t?"width":"height"]()*a.over[i]);else{var v=c[i];u[f]=v.slice&&"%"==v.slice(-1)?parseFloat(v)/100*g:v}a.limit&&/^\d+$/.test(u[f])&&(u[f]=u[f]<=0?0:Math.min(u[f],g)),!e&&a.queue&&(p!=u[f]&&o(a.onAfterFirst),delete u[f])}),o(a.onAfter)}}).end()},s.max=function(t,s){var n="x"==s?"Width":"Height",i="scroll"+n;if(!e(t).is("html,body"))return t[i]-e(t)[n.toLowerCase()]();var a="client"+n,o=t.ownerDocument.documentElement,r=t.ownerDocument.body;return Math.max(o[i],r[i])-Math.min(o[a],r[a])},s})}("function"==typeof define&&define.amd?define:function(e,t){"undefined"!=typeof module&&module.exports?module.exports=t(require("jquery")):t(jQuery)}),jQuery.cookie=function(e,t,s){if("undefined"==typeof t){var n=null;if(document.cookie&&""!=document.cookie)for(var i=document.cookie.split(";"),a=0;a<i.length;a++){var o=jQuery.trim(i[a]);if(o.substring(0,e.length+1)==e+"="){n=decodeURIComponent(o.substring(e.length+1));break}}return n}s=s||{},null===t&&(t="",s.expires=-1);var r="";if(s.expires&&("number"==typeof s.expires||s.expires.toUTCString)){var l;"number"==typeof s.expires?(l=new Date,l.setTime(l.getTime()+24*s.expires*60*60*1e3)):l=s.expires,r="; expires="+l.toUTCString()}var d=s.path?"; path="+s.path:"",c=s.domain?"; domain="+s.domain:"",u=s.secure?"; secure":"";document.cookie=[e,"=",encodeURIComponent(t),r,d,c,u].join("")},function(e){var t=e.preload=function(s,n){function i(i){l.element=this,l.found="load"==i.type,l.image=this.src,l.index=this.index;var r=l.original=s[this.index];l[l.found?"loaded":"failed"]++,l.done++,n.enforceCache&&t.cache.push(e("<img/>").attr("src",l.image)[0]),n.placeholder&&r.src&&(r.src=l.found?l.image:n.notFound||r.src),n.onComplete&&n.onComplete(l),l.done<l.total?a(0,this):(d&&d.unbind&&d.unbind("load").unbind("error").unbind("abort"),d=null,o())}function a(i,o,d){return o.attachEvent&&l.next&&l.next%t.gap==0&&!d?(setTimeout(function(){a(i,o,!0)},0),!1):l.next==l.total?!1:(o.index=l.next,o.src=r[l.next++],n.onRequest&&(l.index=o.index,l.element=o,l.image=o.src,l.original=s[l.next-1],n.onRequest(l)),o.complete&&e(o).trigger("load"),void 0)}function o(){n.onFinish&&n.onFinish(l)}s.split&&(s=e(s)),n=e.extend({},t.defaults,n);var r=e.map(s,function(e){if(e){if(e.split)return n.base+e+n.ext;var t=e.src||e.href;return"string"==typeof n.placeholder&&e.src&&(e.src=n.placeholder),t&&n.find&&(t=t.replace(n.find,n.replace)),t||null}}),l={"loaded":0,"failed":0,"next":0,"done":0,"total":r.length};if(!l.total)return o();var d=e(Array(n.threshold+1).join("<img/>")).load(i).error(i).bind("abort",i).each(a)};t.gap=14,t.cache=[],t.defaults={"threshold":2,"base":"","ext":"","replace":""},e.fn.preload=function(e){return t(this,e),this},function(){var t=(e.fn.preload,e.preload);e.fn.preload=function(){try{return t.apply(this,arguments)}catch(e){return this}},e.preload=function(){try{t.apply(this,arguments)}catch(e){}}}()}(jQuery),function(e){e.fn.typeWatch=function(t){function s(t,s){var n=e(t.el).val();(n.length>i.captureLength&&n.toUpperCase()!=t.text||s&&n.length>i.captureLength)&&(t.text=n.toUpperCase(),t.cb(n))}function n(t){if("TEXT"==t.type.toUpperCase()||"TEXTAREA"==t.nodeName.toUpperCase()){var n={"timer":null,"text":e(t).val().toUpperCase(),"cb":i.callback,"el":t,"wait":i.wait};i.highlight&&e(t).focus(function(){this.select()});var a=function(e){var t=n.wait,i=!1;13==e.keyCode&&"TEXT"==this.type.toUpperCase()&&(t=1,i=!0);var a=function(){s(n,i)};clearTimeout(n.timer),n.timer=setTimeout(a,t)};e(t).keydown(a)}}var i=e.extend({"wait":750,"callback":function(){},"highlight":!0,"captureLength":2},t);return this.each(function(){n(this)})}}(jQuery),function(e){var t;t=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var s=e.length,n=0;s>n;n++)if(n in e&&e[n]===t)return n;return-1};var s={},n=function(e){return this instanceof n?(this.forEach="function"==typeof e?r(e):e.constructor===Array?l(e):d(e),void 0):new n(e)},i=function(e){return e instanceof n?e:new n(e)},a=function(){throw s},o=function(e){this.message=e,this.name="IterationError"};o.prototype=Error.prototype;var r=function(e){return function(t,n){var r=!1,l=0,d=function(e){if(r)throw new o("yield after end of iteration");var s=t.call(n,e,l,a);return l++,s},c=function(e){i(e).forEach(function(e){d(e)})};try{e(d,c,a)}catch(u){if(u!==s)throw u}finally{r=!0}}},l=function(e){return r(function(t){for(var s=e.length,n=0;s>n;n++)n in e&&t(e[n])})},d=function(e){return r(function(t){for(var s in e)e.hasOwnProperty(s)&&t([s,e[s]])})},c=function(e){return"string"==typeof e?function(t){return t[e]}:e};n.prototype={"toArray":function(){var e=[];return this.forEach(function(t){e.push(t)}),e},"filter":function(e,t){var s=this;return e=c(e),new n(function(n){s.forEach(function(s){e.call(t,s)&&n(s)})})},"take":function(e){var t=this;return new n(function(s){t.forEach(function(t,n,i){n>=e&&i(),s(t)})})},"skip":function(e){var t=this;return new n(function(s){t.forEach(function(t,n){n>=e&&s(t)})})},"map":function(e,t){var s=this;return e=c(e),new n(function(n){s.forEach(function(s){n(e.call(t,s))})})},"zipWithArray":function(e,t){"undefined"==typeof t&&(t=function(e,t){return[e,t]});var s=this;return new n(function(n){var i=e.length,a=0;s.forEach(function(s,o,r){for(;!(o+a in e)&&i>o+a;)a++;o+a>=i&&r(),n(t(s,e[o+a]))})})},"reduce":function(e,t){var s,n;return arguments.length<2?s=!0:(s=!1,n=t),this.forEach(function(t){s?(n=t,s=!1):n=e(n,t)}),n},"and":function(e){var t=this;return new n(function(s,n){n(t),n(e)})},"takeWhile":function(e){var t=this;return e=c(e),new n(function(s){t.forEach(function(t,n,i){e(t)?s(t):i()})})},"skipWhile":function(e){var t=this;return e=c(e),new n(function(s){var n=!0;t.forEach(function(t){n=n&&e(t),n||s(t)})})},"all":function(e){var t=!0;return e=c(e),this.forEach(function(s,n,i){(e?e(s):s)||(t=!1,i())}),t},"any":function(e){var t=!1;return e=c(e),this.forEach(function(s,n,i){(e?e(s):s)&&(t=!0,i())}),t},"first":function(){var e;return this.forEach(function(t,s,n){e=t,n()}),e},"groupBy":function(e){var s=this;return e=c(e),new n(function(i,a){var o=[],r=[];s.forEach(function(s){var n=e(s),i=t(o,n);-1===i?(o.push(n),r.push([s])):r[i].push(s)}),a(new n(o).zipWithArray(r,function(e,t){var s=new n(t);return s.key=e,s}))})},"evaluated":function(){return new n(this.toArray())},"except":function(e){return this.filter(function(t){return t!==e})},"sortBy":function(e){var t=this;return e=c(e),new n(function(s){var i=t.toArray(),a=h(0,i.length).toArray();a.sort(function(t,s){var n=e(i[t]),a=e(i[s]);if(typeof n==typeof a){if(n===a)return s>t?-1:1;if(a>n)return-1;if(n>a)return 1}throw new TypeError("cannot compare "+n+" and "+a)}),new n(a).forEach(function(e){s(i[e])})})},"count":function(){var e=0;return this.forEach(function(){e++}),e}};var u=function(e,t){var s=e;return"undefined"==typeof t&&(t=1),new n(function(e){for(;;)e(s),s+=t})},h=function(e,t){return u(e,1).take(t)},m=e.Generator;e.Generator=n,n.BreakIteration=s,n.Count=u,n.Range=h,n.IterationError=o,n.noConflict=function(){return e.Generator=m,n}}(this);var moderatorTools=function(e){var t={},s=function(){$(".quick-unmod").live("click",function(){var e,t,s=$(this).closest("tr");s.length?(e=s.attr("id").replace("fl-",""),s.prev().hasClass("monologue-row")&&(0==s.next().length||s.next().hasClass("monologue-row"))&&(t=s.prev())):(s=$(this).closest("li"),e=s.data("flag_id"),1==s.closest("ul").find("li").length&&(t=s.closest(".flagged-message")));var n="",i="";s.find("input[name=noise]").prop("checked")&&(n="?noise=true",i=" and notify the flagger that moderator flags should only be used for serious issues"),confirm("Dismiss this flag"+i+"?")&&$.post("/flags/"+e+"/clear"+n,fkey(),function(){s.remove(),t&&t.remove()})})};return t.initFlagSupport=function(t,n,i){$(".reflag,.counterflag,.mehflag").live("click",function(s){s.preventDefault();var n,i,a=$(this),o=a.closest("tr");o.length?(i=o.prev("tr").attr("id").replace("msg-",""),n=a.closest("td")):(o=a.closest(".flagged-message"),i=o.data("message_id"),n=a.parent());var r=a.hasClass("reflag")?"flag":a.hasClass("counterflag")?"counter-flag":"meh-flag";if(!t||"meh-flag"==r||confirm("Please note that since you're a moderator, your vote is binding. Continue?")){var l=$("<img/>").attr("src",IMAGE("progress-dots.gif")).appendTo(n),d=function(t){if("ok"==t)o.fadeOut(function(){$(this).remove()});else{var s=t||GENERIC_ERROR;e&&s&&e(s),l.remove()}},c=function(t){l.remove(),e&&e(t)};messageActionById(i,r,null,d,c)}}),BindFlagListPopup("#flag-count, .global-flags:not(.mod-flag)","/admin/flagged?json=true&show=new","/admin/flagged?show=all",e,i),BindFlagListPopup("#modflag-count, .global-flags.mod-flag","/admin/flagged-moderator?json=true","/admin/flagged-moderator",e),t&&s()},t};GENERIC_ERROR="An error occurred performing this action",$(function(){var e=function(e){$.post("/mobile/"+e).done(function(){window.location.reload(!0)})};window.CHAT.switchMobile=e,$(".mobile-on").click(function(){return e("on"),!1}),$(".mobile-off").click(function(){return e("off"),!1})}),function(e,t){e.fn.jPlayer=function(s){var n="string"==typeof s,i=Array.prototype.slice.call(arguments,1),a=this,s=!n&&i.length?e.extend.apply(null,[!0,s].concat(i)):s;return n&&"_"===s.charAt(0)?a:(n?this.each(function(){var n=e.data(this,"jPlayer"),o=n&&e.isFunction(n[s])?n[s].apply(n,i):n;return o!==n&&o!==t?(a=o,!1):void 0}):this.each(function(){var t=e.data(this,"jPlayer");t?t.option(s||{}):e.data(this,"jPlayer",new e.jPlayer(s,this))}),a)},e.jPlayer=function(t,s){if(arguments.length){this.element=e(s),this.options=e.extend(!0,{},this.options,t);var n=this;this.element.bind("remove.jPlayer",function(){n.destroy()}),this._init()}},e.jPlayer.emulateMethods="load play pause",e.jPlayer.emulateStatus="src readyState networkState currentTime duration paused ended playbackRate",e.jPlayer.emulateOptions="muted volume",e.jPlayer.reservedEvent="ready flashreset resize repeat error warning",e.jPlayer.event={"ready":"jPlayer_ready","flashreset":"jPlayer_flashreset","resize":"jPlayer_resize","repeat":"jPlayer_repeat","click":"jPlayer_click","error":"jPlayer_error","warning":"jPlayer_warning","loadstart":"jPlayer_loadstart","progress":"jPlayer_progress","suspend":"jPlayer_suspend","abort":"jPlayer_abort","emptied":"jPlayer_emptied","stalled":"jPlayer_stalled","play":"jPlayer_play","pause":"jPlayer_pause","loadedmetadata":"jPlayer_loadedmetadata","loadeddata":"jPlayer_loadeddata","waiting":"jPlayer_waiting","playing":"jPlayer_playing","canplay":"jPlayer_canplay","canplaythrough":"jPlayer_canplaythrough","seeking":"jPlayer_seeking","seeked":"jPlayer_seeked","timeupdate":"jPlayer_timeupdate","ended":"jPlayer_ended","ratechange":"jPlayer_ratechange","durationchange":"jPlayer_durationchange","volumechange":"jPlayer_volumechange"},e.jPlayer.htmlEvent="loadstart,abort,emptied,stalled,loadedmetadata,loadeddata,canplay,canplaythrough,ratechange".split(","),e.jPlayer.pause=function(){e.each(e.jPlayer.prototype.instances,function(e,t){t.data("jPlayer").status.srcSet&&t.jPlayer("pause")})},e.jPlayer.timeFormat={"showHour":!1,"showMin":!0,"showSec":!0,"padHour":!1,"padMin":!0,"padSec":!0,"sepHour":":","sepMin":":","sepSec":""},e.jPlayer.convertTime=function(t){var s=new Date(1e3*t),n=s.getUTCHours(),t=s.getUTCMinutes(),s=s.getUTCSeconds(),n=e.jPlayer.timeFormat.padHour&&10>n?"0"+n:n,t=e.jPlayer.timeFormat.padMin&&10>t?"0"+t:t,s=e.jPlayer.timeFormat.padSec&&10>s?"0"+s:s;return(e.jPlayer.timeFormat.showHour?n+e.jPlayer.timeFormat.sepHour:"")+(e.jPlayer.timeFormat.showMin?t+e.jPlayer.timeFormat.sepMin:"")+(e.jPlayer.timeFormat.showSec?s+e.jPlayer.timeFormat.sepSec:"")},e.jPlayer.uaBrowser=function(e){var e=e.toLowerCase(),t=/(opera)(?:.*version)?[ \/]([\w.]+)/,s=/(msie) ([\w.]+)/,n=/(mozilla)(?:.*? rv:([\w.]+))?/,e=/(webkit)[ \/]([\w.]+)/.exec(e)||t.exec(e)||s.exec(e)||e.indexOf("compatible")<0&&n.exec(e)||[];return{"browser":e[1]||"","version":e[2]||"0"}},e.jPlayer.uaPlatform=function(e){var t=e.toLowerCase(),s=/(android)/,n=/(mobile)/,e=/(ipad|iphone|ipod|android|blackberry|playbook|windows ce|webos)/.exec(t)||[],t=/(ipad|playbook)/.exec(t)||!n.exec(t)&&s.exec(t)||[];return e[1]&&(e[1]=e[1].replace(/\s/g,"_")),{"platform":e[1]||"","tablet":t[1]||""}},e.jPlayer.browser={},e.jPlayer.platform={};var s=e.jPlayer.uaBrowser(navigator.userAgent);s.browser&&(e.jPlayer.browser[s.browser]=!0,e.jPlayer.browser.version=s.version),s=e.jPlayer.uaPlatform(navigator.userAgent),s.platform&&(e.jPlayer.platform[s.platform]=!0,e.jPlayer.platform.mobile=!s.tablet,e.jPlayer.platform.tablet=!!s.tablet),e.jPlayer.prototype={"count":0,"version":{"script":"2.1.0","needFlash":"2.1.0","flash":"unknown"},"options":{"swfPath":"js","solution":"html, flash","supplied":"mp3","preload":"metadata","volume":.8,"muted":!1,"wmode":"opaque","backgroundColor":"#000000","cssSelectorAncestor":"#jp_container_1","cssSelector":{"videoPlay":".jp-video-play","play":".jp-play","pause":".jp-pause","stop":".jp-stop","seekBar":".jp-seek-bar","playBar":".jp-play-bar","mute":".jp-mute","unmute":".jp-unmute","volumeBar":".jp-volume-bar","volumeBarValue":".jp-volume-bar-value","volumeMax":".jp-volume-max","currentTime":".jp-current-time","duration":".jp-duration","fullScreen":".jp-full-screen","restoreScreen":".jp-restore-screen","repeat":".jp-repeat","repeatOff":".jp-repeat-off","gui":".jp-gui","noSolution":".jp-no-solution"},"fullScreen":!1,"autohide":{"restored":!1,"full":!0,"fadeIn":200,"fadeOut":600,"hold":1e3},"loop":!1,"repeat":function(t){t.jPlayer.options.loop?e(this).unbind(".jPlayerRepeat").bind(e.jPlayer.event.ended+".jPlayer.jPlayerRepeat",function(){e(this).jPlayer("play")}):e(this).unbind(".jPlayerRepeat")},"nativeVideoControls":{},"noFullScreen":{"msie":/msie [0-6]/,"ipad":/ipad.*?os [0-4]/,"iphone":/iphone/,"ipod":/ipod/,"android_pad":/android [0-3](?!.*?mobile)/,"android_phone":/android.*?mobile/,"blackberry":/blackberry/,"windows_ce":/windows ce/,"webos":/webos/},"noVolume":{"ipad":/ipad/,"iphone":/iphone/,"ipod":/ipod/,"android_pad":/android(?!.*?mobile)/,"android_phone":/android.*?mobile/,"blackberry":/blackberry/,"windows_ce":/windows ce/,"webos":/webos/,"playbook":/playbook/},"verticalVolume":!1,"idPrefix":"jp","noConflict":"jQuery","emulateHtml":!1,"errorAlerts":!1,"warningAlerts":!1},"optionsAudio":{"size":{"width":"0px","height":"0px","cssClass":""},"sizeFull":{"width":"0px","height":"0px","cssClass":""}},"optionsVideo":{"size":{"width":"480px","height":"270px","cssClass":"jp-video-270p"},"sizeFull":{"width":"100%","height":"100%","cssClass":"jp-video-full"}},"instances":{},"status":{"src":"","media":{},"paused":!0,"format":{},"formatType":"","waitForPlay":!0,"waitForLoad":!0,"srcSet":!1,"video":!1,"seekPercent":0,"currentPercentRelative":0,"currentPercentAbsolute":0,"currentTime":0,"duration":0,"readyState":0,"networkState":0,"playbackRate":1,"ended":0},"internal":{"ready":!1},"solution":{"html":!0,"flash":!0},"format":{"mp3":{"codec":'audio/mpeg; codecs="mp3"',"flashCanPlay":!0,"media":"audio"},"m4a":{"codec":'audio/mp4; codecs="mp4a.40.2"',"flashCanPlay":!0,"media":"audio"},"oga":{"codec":'audio/ogg; codecs="vorbis"',"flashCanPlay":!1,"media":"audio"},"wav":{"codec":'audio/wav; codecs="1"',"flashCanPlay":!1,"media":"audio"},"webma":{"codec":'audio/webm; codecs="vorbis"',"flashCanPlay":!1,"media":"audio"},"fla":{"codec":"audio/x-flv","flashCanPlay":!0,"media":"audio"},"m4v":{"codec":'video/mp4; codecs="avc1.42E01E, mp4a.40.2"',"flashCanPlay":!0,"media":"video"},"ogv":{"codec":'video/ogg; codecs="theora, vorbis"',"flashCanPlay":!1,"media":"video"},"webmv":{"codec":'video/webm; codecs="vorbis, vp8"',"flashCanPlay":!1,"media":"video"},"flv":{"codec":"video/x-flv","flashCanPlay":!0,"media":"video"}},"_init":function(){var s=this;if(this.element.empty(),this.status=e.extend({},this.status),this.internal=e.extend({},this.internal),this.internal.domNode=this.element.get(0),this.formats=[],this.solutions=[],this.require={},this.htmlElement={},this.html={},this.html.audio={},this.html.video={},this.flash={},this.css={},this.css.cs={},this.css.jq={},this.ancestorJq=[],this.options.volume=this._limitValue(this.options.volume,0,1),e.each(this.options.supplied.toLowerCase().split(","),function(t,n){var i=n.replace(/^\s+|\s+$/g,"");if(s.format[i]){var a=!1;e.each(s.formats,function(e,t){return i===t?(a=!0,!1):void 0}),a||s.formats.push(i)}}),e.each(this.options.solution.toLowerCase().split(","),function(t,n){var i=n.replace(/^\s+|\s+$/g,"");if(s.solution[i]){var a=!1;e.each(s.solutions,function(e,t){return i===t?(a=!0,!1):void 0}),a||s.solutions.push(i)}}),this.internal.instance="jp_"+this.count,this.instances[this.internal.instance]=this.element,this.element.attr("id")||this.element.attr("id",this.options.idPrefix+"_jplayer_"+this.count),this.internal.self=e.extend({},{"id":this.element.attr("id"),"jq":this.element}),this.internal.audio=e.extend({},{"id":this.options.idPrefix+"_audio_"+this.count,"jq":t}),this.internal.video=e.extend({},{"id":this.options.idPrefix+"_video_"+this.count,"jq":t}),this.internal.flash=e.extend({},{"id":this.options.idPrefix+"_flash_"+this.count,"jq":t,"swf":this.options.swfPath+(".swf"!==this.options.swfPath.toLowerCase().slice(-4)?(this.options.swfPath&&"/"!==this.options.swfPath.slice(-1)?"/":"")+"Jplayer.swf":"")}),this.internal.poster=e.extend({},{"id":this.options.idPrefix+"_poster_"+this.count,"jq":t}),e.each(e.jPlayer.event,function(e,n){s.options[e]!==t&&(s.element.bind(n+".jPlayer",s.options[e]),s.options[e]=t)}),this.require.audio=!1,this.require.video=!1,e.each(this.formats,function(e,t){s.require[s.format[t].media]=!0}),this.options=this.require.video?e.extend(!0,{},this.optionsVideo,this.options):e.extend(!0,{},this.optionsAudio,this.options),this._setSize(),this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls),this.status.noFullScreen=this._uaBlocklist(this.options.noFullScreen),this.status.noVolume=this._uaBlocklist(this.options.noVolume),this._restrictNativeVideoControls(),this.htmlElement.poster=document.createElement("img"),this.htmlElement.poster.id=this.internal.poster.id,this.htmlElement.poster.onload=function(){(!s.status.video||s.status.waitForPlay)&&s.internal.poster.jq.show()},this.element.append(this.htmlElement.poster),this.internal.poster.jq=e("#"+this.internal.poster.id),this.internal.poster.jq.css({"width":this.status.width,"height":this.status.height}),this.internal.poster.jq.hide(),this.internal.poster.jq.bind("click.jPlayer",function(){s._trigger(e.jPlayer.event.click)}),this.html.audio.available=!1,this.require.audio&&(this.htmlElement.audio=document.createElement("audio"),this.htmlElement.audio.id=this.internal.audio.id,this.html.audio.available=!!this.htmlElement.audio.canPlayType&&this._testCanPlayType(this.htmlElement.audio)),this.html.video.available=!1,this.require.video&&(this.htmlElement.video=document.createElement("video"),this.htmlElement.video.id=this.internal.video.id,this.html.video.available=!!this.htmlElement.video.canPlayType&&this._testCanPlayType(this.htmlElement.video)),this.flash.available=this._checkForFlash(10),this.html.canPlay={},this.flash.canPlay={},e.each(this.formats,function(e,t){s.html.canPlay[t]=s.html[s.format[t].media].available&&""!==s.htmlElement[s.format[t].media].canPlayType(s.format[t].codec),s.flash.canPlay[t]=s.format[t].flashCanPlay&&s.flash.available}),this.html.desired=!1,this.flash.desired=!1,e.each(this.solutions,function(t,n){if(0===t)s[n].desired=!0;else{var i=!1,a=!1;e.each(s.formats,function(e,t){s[s.solutions[0]].canPlay[t]&&("video"===s.format[t].media?a=!0:i=!0)}),s[n].desired=s.require.audio&&!i||s.require.video&&!a}}),this.html.support={},this.flash.support={},e.each(this.formats,function(e,t){s.html.support[t]=s.html.canPlay[t]&&s.html.desired,s.flash.support[t]=s.flash.canPlay[t]&&s.flash.desired}),this.html.used=!1,this.flash.used=!1,e.each(this.solutions,function(t,n){e.each(s.formats,function(e,t){return s[n].support[t]?(s[n].used=!0,!1):void 0})}),this._resetActive(),this._resetGate(),this._cssSelectorAncestor(this.options.cssSelectorAncestor),this.html.used||this.flash.used?this.css.jq.noSolution.length&&this.css.jq.noSolution.hide():(this._error({"type":e.jPlayer.error.NO_SOLUTION,"context":"{solution:'"+this.options.solution+"', supplied:'"+this.options.supplied+"'}","message":e.jPlayer.errorMsg.NO_SOLUTION,"hint":e.jPlayer.errorHint.NO_SOLUTION}),this.css.jq.noSolution.length&&this.css.jq.noSolution.show()),this.flash.used){var n,i="jQuery="+encodeURI(this.options.noConflict)+"&id="+encodeURI(this.internal.self.id)+"&vol="+this.options.volume+"&muted="+this.options.muted;if(e.browser.msie&&Number(e.browser.version)<=8){i=['<param name="movie" value="'+this.internal.flash.swf+'" />','<param name="FlashVars" value="'+i+'" />','<param name="allowScriptAccess" value="always" />','<param name="bgcolor" value="'+this.options.backgroundColor+'" />','<param name="wmode" value="'+this.options.wmode+'" />'],n=document.createElement('<object id="'+this.internal.flash.id+'" classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" width="0" height="0"></object>');for(var a=0;a<i.length;a++)n.appendChild(document.createElement(i[a]))}else a=function(e,t,s){var n=document.createElement("param");n.setAttribute("name",t),n.setAttribute("value",s),e.appendChild(n)},n=document.createElement("object"),n.setAttribute("id",this.internal.flash.id),n.setAttribute("data",this.internal.flash.swf),n.setAttribute("type","application/x-shockwave-flash"),n.setAttribute("width","1"),n.setAttribute("height","1"),a(n,"flashvars",i),a(n,"allowscriptaccess","always"),a(n,"bgcolor",this.options.backgroundColor),a(n,"wmode",this.options.wmode);this.element.append(n),this.internal.flash.jq=e(n)}this.html.used&&(this.html.audio.available&&(this._addHtmlEventListeners(this.htmlElement.audio,this.html.audio),this.element.append(this.htmlElement.audio),this.internal.audio.jq=e("#"+this.internal.audio.id)),this.html.video.available&&(this._addHtmlEventListeners(this.htmlElement.video,this.html.video),this.element.append(this.htmlElement.video),this.internal.video.jq=e("#"+this.internal.video.id),this.status.nativeVideoControls?this.internal.video.jq.css({"width":this.status.width,"height":this.status.height}):this.internal.video.jq.css({"width":"0px","height":"0px"}),this.internal.video.jq.bind("click.jPlayer",function(){s._trigger(e.jPlayer.event.click)
}))),this.options.emulateHtml&&this._emulateHtmlBridge(),this.html.used&&!this.flash.used&&setTimeout(function(){s.internal.ready=!0,s.version.flash="n/a",s._trigger(e.jPlayer.event.repeat),s._trigger(e.jPlayer.event.ready)},100),this._updateNativeVideoControls(),this._updateInterface(),this._updateButtons(!1),this._updateAutohide(),this._updateVolume(this.options.volume),this._updateMute(this.options.muted),this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide(),e.jPlayer.prototype.count++},"destroy":function(){this.clearMedia(),this._removeUiClass(),this.css.jq.currentTime.length&&this.css.jq.currentTime.text(""),this.css.jq.duration.length&&this.css.jq.duration.text(""),e.each(this.css.jq,function(e,t){t.length&&t.unbind(".jPlayer")}),this.internal.poster.jq.unbind(".jPlayer"),this.internal.video.jq&&this.internal.video.jq.unbind(".jPlayer"),this.options.emulateHtml&&this._destroyHtmlBridge(),this.element.removeData("jPlayer"),this.element.unbind(".jPlayer"),this.element.empty(),delete this.instances[this.internal.instance]},"enable":function(){},"disable":function(){},"_testCanPlayType":function(e){try{return e.canPlayType(this.format.mp3.codec),!0}catch(t){return!1}},"_uaBlocklist":function(t){var s=navigator.userAgent.toLowerCase(),n=!1;return e.each(t,function(e,t){return t&&t.test(s)?(n=!0,!1):void 0}),n},"_restrictNativeVideoControls":function(){this.require.audio&&this.status.nativeVideoControls&&(this.status.nativeVideoControls=!1,this.status.noFullScreen=!0)},"_updateNativeVideoControls":function(){this.html.video.available&&this.html.used&&(this.htmlElement.video.controls=this.status.nativeVideoControls,this._updateAutohide(),this.status.nativeVideoControls&&this.require.video?(this.internal.poster.jq.hide(),this.internal.video.jq.css({"width":this.status.width,"height":this.status.height})):this.status.waitForPlay&&this.status.video&&(this.internal.poster.jq.show(),this.internal.video.jq.css({"width":"0px","height":"0px"})))},"_addHtmlEventListeners":function(t,s){var n=this;t.preload=this.options.preload,t.muted=this.options.muted,t.volume=this.options.volume,t.addEventListener("progress",function(){s.gate&&(n._getHtmlStatus(t),n._updateInterface(),n._trigger(e.jPlayer.event.progress))},!1),t.addEventListener("timeupdate",function(){s.gate&&(n._getHtmlStatus(t),n._updateInterface(),n._trigger(e.jPlayer.event.timeupdate))},!1),t.addEventListener("durationchange",function(){s.gate&&(n.status.duration=this.duration,n._getHtmlStatus(t),n._updateInterface(),n._trigger(e.jPlayer.event.durationchange))},!1),t.addEventListener("play",function(){s.gate&&(n._updateButtons(!0),n._html_checkWaitForPlay(),n._trigger(e.jPlayer.event.play))},!1),t.addEventListener("playing",function(){s.gate&&(n._updateButtons(!0),n._seeked(),n._trigger(e.jPlayer.event.playing))},!1),t.addEventListener("pause",function(){s.gate&&(n._updateButtons(!1),n._trigger(e.jPlayer.event.pause))},!1),t.addEventListener("waiting",function(){s.gate&&(n._seeking(),n._trigger(e.jPlayer.event.waiting))},!1),t.addEventListener("seeking",function(){s.gate&&(n._seeking(),n._trigger(e.jPlayer.event.seeking))},!1),t.addEventListener("seeked",function(){s.gate&&(n._seeked(),n._trigger(e.jPlayer.event.seeked))},!1),t.addEventListener("volumechange",function(){s.gate&&(n.options.volume=t.volume,n.options.muted=t.muted,n._updateMute(),n._updateVolume(),n._trigger(e.jPlayer.event.volumechange))},!1),t.addEventListener("suspend",function(){s.gate&&(n._seeked(),n._trigger(e.jPlayer.event.suspend))},!1),t.addEventListener("ended",function(){s.gate&&(e.jPlayer.browser.webkit||(n.htmlElement.media.currentTime=0),n.htmlElement.media.pause(),n._updateButtons(!1),n._getHtmlStatus(t,!0),n._updateInterface(),n._trigger(e.jPlayer.event.ended))},!1),t.addEventListener("error",function(){s.gate&&(n._updateButtons(!1),n._seeked(),n.status.srcSet)&&(clearTimeout(n.internal.htmlDlyCmdId),n.status.waitForLoad=!0,n.status.waitForPlay=!0,n.status.video&&!n.status.nativeVideoControls&&n.internal.video.jq.css({"width":"0px","height":"0px"}),n._validString(n.status.media.poster)&&!n.status.nativeVideoControls&&n.internal.poster.jq.show(),n.css.jq.videoPlay.length&&n.css.jq.videoPlay.show(),n._error({"type":e.jPlayer.error.URL,"context":n.status.src,"message":e.jPlayer.errorMsg.URL,"hint":e.jPlayer.errorHint.URL}))},!1),e.each(e.jPlayer.htmlEvent,function(i,a){t.addEventListener(this,function(){s.gate&&n._trigger(e.jPlayer.event[a])},!1)})},"_getHtmlStatus":function(e,t){var s=0,n=0,i=0,a=0;e.duration&&(this.status.duration=e.duration),s=e.currentTime,n=this.status.duration>0?100*s/this.status.duration:0,"object"==typeof e.seekable&&e.seekable.length>0?(i=this.status.duration>0?100*e.seekable.end(e.seekable.length-1)/this.status.duration:100,a=100*e.currentTime/e.seekable.end(e.seekable.length-1)):(i=100,a=n),t&&(n=a=s=0),this.status.seekPercent=i,this.status.currentPercentRelative=a,this.status.currentPercentAbsolute=n,this.status.currentTime=s,this.status.readyState=e.readyState,this.status.networkState=e.networkState,this.status.playbackRate=e.playbackRate,this.status.ended=e.ended},"_resetStatus":function(){this.status=e.extend({},this.status,e.jPlayer.prototype.status)},"_trigger":function(t,s,n){t=e.Event(t),t.jPlayer={},t.jPlayer.version=e.extend({},this.version),t.jPlayer.options=e.extend(!0,{},this.options),t.jPlayer.status=e.extend(!0,{},this.status),t.jPlayer.html=e.extend(!0,{},this.html),t.jPlayer.flash=e.extend(!0,{},this.flash),s&&(t.jPlayer.error=e.extend({},s)),n&&(t.jPlayer.warning=e.extend({},n)),this.element.trigger(t)},"jPlayerFlashEvent":function(t,s){if(t===e.jPlayer.event.ready)if(this.internal.ready){if(this.flash.gate){if(this.status.srcSet){var n=this.status.currentTime,i=this.status.paused;this.setMedia(this.status.media),n>0&&(i?this.pause(n):this.play(n))}this._trigger(e.jPlayer.event.flashreset)}}else this.internal.ready=!0,this.internal.flash.jq.css({"width":"0px","height":"0px"}),this.version.flash=s.version,this.version.needFlash!==this.version.flash&&this._error({"type":e.jPlayer.error.VERSION,"context":this.version.flash,"message":e.jPlayer.errorMsg.VERSION+this.version.flash,"hint":e.jPlayer.errorHint.VERSION}),this._trigger(e.jPlayer.event.repeat),this._trigger(t);if(this.flash.gate)switch(t){case e.jPlayer.event.progress:this._getFlashStatus(s),this._updateInterface(),this._trigger(t);break;case e.jPlayer.event.timeupdate:this._getFlashStatus(s),this._updateInterface(),this._trigger(t);break;case e.jPlayer.event.play:this._seeked(),this._updateButtons(!0),this._trigger(t);break;case e.jPlayer.event.pause:this._updateButtons(!1),this._trigger(t);break;case e.jPlayer.event.ended:this._updateButtons(!1),this._trigger(t);break;case e.jPlayer.event.click:this._trigger(t);break;case e.jPlayer.event.error:this.status.waitForLoad=!0,this.status.waitForPlay=!0,this.status.video&&this.internal.flash.jq.css({"width":"0px","height":"0px"}),this._validString(this.status.media.poster)&&this.internal.poster.jq.show(),this.css.jq.videoPlay.length&&this.status.video&&this.css.jq.videoPlay.show(),this.status.video?this._flash_setVideo(this.status.media):this._flash_setAudio(this.status.media),this._updateButtons(!1),this._error({"type":e.jPlayer.error.URL,"context":s.src,"message":e.jPlayer.errorMsg.URL,"hint":e.jPlayer.errorHint.URL});break;case e.jPlayer.event.seeking:this._seeking(),this._trigger(t);break;case e.jPlayer.event.seeked:this._seeked(),this._trigger(t);break;case e.jPlayer.event.ready:break;default:this._trigger(t)}return!1},"_getFlashStatus":function(e){this.status.seekPercent=e.seekPercent,this.status.currentPercentRelative=e.currentPercentRelative,this.status.currentPercentAbsolute=e.currentPercentAbsolute,this.status.currentTime=e.currentTime,this.status.duration=e.duration,this.status.readyState=4,this.status.networkState=0,this.status.playbackRate=1,this.status.ended=!1},"_updateButtons":function(e){e!==t&&(this.status.paused=!e,this.css.jq.play.length&&this.css.jq.pause.length&&(e?(this.css.jq.play.hide(),this.css.jq.pause.show()):(this.css.jq.play.show(),this.css.jq.pause.hide()))),this.css.jq.restoreScreen.length&&this.css.jq.fullScreen.length&&(this.status.noFullScreen?(this.css.jq.fullScreen.hide(),this.css.jq.restoreScreen.hide()):this.options.fullScreen?(this.css.jq.fullScreen.hide(),this.css.jq.restoreScreen.show()):(this.css.jq.fullScreen.show(),this.css.jq.restoreScreen.hide())),this.css.jq.repeat.length&&this.css.jq.repeatOff.length&&(this.options.loop?(this.css.jq.repeat.hide(),this.css.jq.repeatOff.show()):(this.css.jq.repeat.show(),this.css.jq.repeatOff.hide()))},"_updateInterface":function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.width(this.status.seekPercent+"%"),this.css.jq.playBar.length&&this.css.jq.playBar.width(this.status.currentPercentRelative+"%"),this.css.jq.currentTime.length&&this.css.jq.currentTime.text(e.jPlayer.convertTime(this.status.currentTime)),this.css.jq.duration.length&&this.css.jq.duration.text(e.jPlayer.convertTime(this.status.duration))},"_seeking":function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.addClass("jp-seeking-bg")},"_seeked":function(){this.css.jq.seekBar.length&&this.css.jq.seekBar.removeClass("jp-seeking-bg")},"_resetGate":function(){this.html.audio.gate=!1,this.html.video.gate=!1,this.flash.gate=!1},"_resetActive":function(){this.html.active=!1,this.flash.active=!1},"setMedia":function(t){var s=this,n=!1,i=this.status.media.poster!==t.poster;this._resetMedia(),this._resetGate(),this._resetActive(),e.each(this.formats,function(i,a){var o="video"===s.format[a].media;return e.each(s.solutions,function(e,i){if(s[i].support[a]&&s._validString(t[a])){var r="html"===i;return o?(r?(s.html.video.gate=!0,s._html_setVideo(t),s.html.active=!0):(s.flash.gate=!0,s._flash_setVideo(t),s.flash.active=!0),s.css.jq.videoPlay.length&&s.css.jq.videoPlay.show(),s.status.video=!0):(r?(s.html.audio.gate=!0,s._html_setAudio(t),s.html.active=!0):(s.flash.gate=!0,s._flash_setAudio(t),s.flash.active=!0),s.css.jq.videoPlay.length&&s.css.jq.videoPlay.hide(),s.status.video=!1),n=!0,!1}}),n?!1:void 0}),n?(this.status.nativeVideoControls&&this.html.video.gate||!this._validString(t.poster)||(i?this.htmlElement.poster.src=t.poster:this.internal.poster.jq.show()),this.status.srcSet=!0,this.status.media=e.extend({},t),this._updateButtons(!1),this._updateInterface()):this._error({"type":e.jPlayer.error.NO_SUPPORT,"context":"{supplied:'"+this.options.supplied+"'}","message":e.jPlayer.errorMsg.NO_SUPPORT,"hint":e.jPlayer.errorHint.NO_SUPPORT})},"_resetMedia":function(){this._resetStatus(),this._updateButtons(!1),this._updateInterface(),this._seeked(),this.internal.poster.jq.hide(),clearTimeout(this.internal.htmlDlyCmdId),this.html.active?this._html_resetMedia():this.flash.active&&this._flash_resetMedia()},"clearMedia":function(){this._resetMedia(),this.html.active?this._html_clearMedia():this.flash.active&&this._flash_clearMedia(),this._resetGate(),this._resetActive()},"load":function(){this.status.srcSet?this.html.active?this._html_load():this.flash.active&&this._flash_load():this._urlNotSetError("load")},"play":function(e){e="number"==typeof e?e:0/0,this.status.srcSet?this.html.active?this._html_play(e):this.flash.active&&this._flash_play(e):this._urlNotSetError("play")},"videoPlay":function(){this.play()},"pause":function(e){e="number"==typeof e?e:0/0,this.status.srcSet?this.html.active?this._html_pause(e):this.flash.active&&this._flash_pause(e):this._urlNotSetError("pause")},"pauseOthers":function(){var t=this;e.each(this.instances,function(e,s){t.element!==s&&s.data("jPlayer").status.srcSet&&s.jPlayer("pause")})},"stop":function(){this.status.srcSet?this.html.active?this._html_pause(0):this.flash.active&&this._flash_pause(0):this._urlNotSetError("stop")},"playHead":function(e){e=this._limitValue(e,0,100),this.status.srcSet?this.html.active?this._html_playHead(e):this.flash.active&&this._flash_playHead(e):this._urlNotSetError("playHead")},"_muted":function(t){this.options.muted=t,this.html.used&&this._html_mute(t),this.flash.used&&this._flash_mute(t),!this.html.video.gate&&!this.html.audio.gate&&(this._updateMute(t),this._updateVolume(this.options.volume),this._trigger(e.jPlayer.event.volumechange))},"mute":function(e){e=e===t?!0:!!e,this._muted(e)},"unmute":function(e){e=e===t?!0:!!e,this._muted(!e)},"_updateMute":function(e){e===t&&(e=this.options.muted),this.css.jq.mute.length&&this.css.jq.unmute.length&&(this.status.noVolume?(this.css.jq.mute.hide(),this.css.jq.unmute.hide()):e?(this.css.jq.mute.hide(),this.css.jq.unmute.show()):(this.css.jq.mute.show(),this.css.jq.unmute.hide()))},"volume":function(t){t=this._limitValue(t,0,1),this.options.volume=t,this.html.used&&this._html_volume(t),this.flash.used&&this._flash_volume(t),!this.html.video.gate&&!this.html.audio.gate&&(this._updateVolume(t),this._trigger(e.jPlayer.event.volumechange))},"volumeBar":function(e){if(this.css.jq.volumeBar.length){var t=this.css.jq.volumeBar.offset(),s=e.pageX-t.left,n=this.css.jq.volumeBar.width(),e=this.css.jq.volumeBar.height()-e.pageY+t.top,t=this.css.jq.volumeBar.height();this.options.verticalVolume?this.volume(e/t):this.volume(s/n)}this.options.muted&&this._muted(!1)},"volumeBarValue":function(e){this.volumeBar(e)},"_updateVolume":function(e){e===t&&(e=this.options.volume),e=this.options.muted?0:e,this.status.noVolume?(this.css.jq.volumeBar.length&&this.css.jq.volumeBar.hide(),this.css.jq.volumeBarValue.length&&this.css.jq.volumeBarValue.hide(),this.css.jq.volumeMax.length&&this.css.jq.volumeMax.hide()):(this.css.jq.volumeBar.length&&this.css.jq.volumeBar.show(),this.css.jq.volumeBarValue.length&&(this.css.jq.volumeBarValue.show(),this.css.jq.volumeBarValue[this.options.verticalVolume?"height":"width"](100*e+"%")),this.css.jq.volumeMax.length&&this.css.jq.volumeMax.show())},"volumeMax":function(){this.volume(1),this.options.muted&&this._muted(!1)},"_cssSelectorAncestor":function(t){var s=this;this.options.cssSelectorAncestor=t,this._removeUiClass(),this.ancestorJq=t?e(t):[],t&&1!==this.ancestorJq.length&&this._warning({"type":e.jPlayer.warning.CSS_SELECTOR_COUNT,"context":t,"message":e.jPlayer.warningMsg.CSS_SELECTOR_COUNT+this.ancestorJq.length+" found for cssSelectorAncestor.","hint":e.jPlayer.warningHint.CSS_SELECTOR_COUNT}),this._addUiClass(),e.each(this.options.cssSelector,function(e,t){s._cssSelector(e,t)})},"_cssSelector":function(t,s){var n=this;"string"==typeof s?e.jPlayer.prototype.options.cssSelector[t]?(this.css.jq[t]&&this.css.jq[t].length&&this.css.jq[t].unbind(".jPlayer"),this.options.cssSelector[t]=s,this.css.cs[t]=this.options.cssSelectorAncestor+" "+s,this.css.jq[t]=s?e(this.css.cs[t]):[],this.css.jq[t].length&&this.css.jq[t].bind("click.jPlayer",function(s){return n[t](s),e(this).blur(),!1}),s&&1!==this.css.jq[t].length&&this._warning({"type":e.jPlayer.warning.CSS_SELECTOR_COUNT,"context":this.css.cs[t],"message":e.jPlayer.warningMsg.CSS_SELECTOR_COUNT+this.css.jq[t].length+" found for "+t+" method.","hint":e.jPlayer.warningHint.CSS_SELECTOR_COUNT})):this._warning({"type":e.jPlayer.warning.CSS_SELECTOR_METHOD,"context":t,"message":e.jPlayer.warningMsg.CSS_SELECTOR_METHOD,"hint":e.jPlayer.warningHint.CSS_SELECTOR_METHOD}):this._warning({"type":e.jPlayer.warning.CSS_SELECTOR_STRING,"context":s,"message":e.jPlayer.warningMsg.CSS_SELECTOR_STRING,"hint":e.jPlayer.warningHint.CSS_SELECTOR_STRING})},"seekBar":function(e){if(this.css.jq.seekBar){var t=this.css.jq.seekBar.offset(),e=e.pageX-t.left,t=this.css.jq.seekBar.width();this.playHead(100*e/t)}},"playBar":function(e){this.seekBar(e)},"repeat":function(){this._loop(!0)},"repeatOff":function(){this._loop(!1)},"_loop":function(t){this.options.loop!==t&&(this.options.loop=t,this._updateButtons(),this._trigger(e.jPlayer.event.repeat))},"currentTime":function(){},"duration":function(){},"gui":function(){},"noSolution":function(){},"option":function(s,n){var i=s;if(0===arguments.length)return e.extend(!0,{},this.options);if("string"==typeof s){var a=s.split(".");if(n===t){for(var i=e.extend(!0,{},this.options),o=0;o<a.length;o++){if(i[a[o]]===t)return this._warning({"type":e.jPlayer.warning.OPTION_KEY,"context":s,"message":e.jPlayer.warningMsg.OPTION_KEY,"hint":e.jPlayer.warningHint.OPTION_KEY}),t;i=i[a[o]]}return i}for(var o=i={},r=0;r<a.length;r++)r<a.length-1?(o[a[r]]={},o=o[a[r]]):o[a[r]]=n}return this._setOptions(i),this},"_setOptions":function(t){var s=this;return e.each(t,function(e,t){s._setOption(e,t)}),this},"_setOption":function(t,s){var n=this;switch(t){case"volume":this.volume(s);break;case"muted":this._muted(s);break;case"cssSelectorAncestor":this._cssSelectorAncestor(s);break;case"cssSelector":e.each(s,function(e,t){n._cssSelector(e,t)});break;case"fullScreen":this.options[t]!==s&&(this._removeUiClass(),this.options[t]=s,this._refreshSize());break;case"size":!this.options.fullScreen&&this.options[t].cssClass!==s.cssClass&&this._removeUiClass(),this.options[t]=e.extend({},this.options[t],s),this._refreshSize();break;case"sizeFull":this.options.fullScreen&&this.options[t].cssClass!==s.cssClass&&this._removeUiClass(),this.options[t]=e.extend({},this.options[t],s),this._refreshSize();break;case"autohide":this.options[t]=e.extend({},this.options[t],s),this._updateAutohide();break;case"loop":this._loop(s);break;case"nativeVideoControls":this.options[t]=e.extend({},this.options[t],s),this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls),this._restrictNativeVideoControls(),this._updateNativeVideoControls();break;case"noFullScreen":this.options[t]=e.extend({},this.options[t],s),this.status.nativeVideoControls=this._uaBlocklist(this.options.nativeVideoControls),this.status.noFullScreen=this._uaBlocklist(this.options.noFullScreen),this._restrictNativeVideoControls(),this._updateButtons();break;case"noVolume":this.options[t]=e.extend({},this.options[t],s),this.status.noVolume=this._uaBlocklist(this.options.noVolume),this._updateVolume(),this._updateMute();break;case"emulateHtml":this.options[t]!==s&&((this.options[t]=s)?this._emulateHtmlBridge():this._destroyHtmlBridge())}return this},"_refreshSize":function(){this._setSize(),this._addUiClass(),this._updateSize(),this._updateButtons(),this._updateAutohide(),this._trigger(e.jPlayer.event.resize)},"_setSize":function(){this.options.fullScreen?(this.status.width=this.options.sizeFull.width,this.status.height=this.options.sizeFull.height,this.status.cssClass=this.options.sizeFull.cssClass):(this.status.width=this.options.size.width,this.status.height=this.options.size.height,this.status.cssClass=this.options.size.cssClass),this.element.css({"width":this.status.width,"height":this.status.height})},"_addUiClass":function(){this.ancestorJq.length&&this.ancestorJq.addClass(this.status.cssClass)},"_removeUiClass":function(){this.ancestorJq.length&&this.ancestorJq.removeClass(this.status.cssClass)},"_updateSize":function(){this.internal.poster.jq.css({"width":this.status.width,"height":this.status.height}),!this.status.waitForPlay&&this.html.active&&this.status.video||this.html.video.available&&this.html.used&&this.status.nativeVideoControls?this.internal.video.jq.css({"width":this.status.width,"height":this.status.height}):!this.status.waitForPlay&&this.flash.active&&this.status.video&&this.internal.flash.jq.css({"width":this.status.width,"height":this.status.height})},"_updateAutohide":function(){var e=this,t=function(){e.css.jq.gui.fadeIn(e.options.autohide.fadeIn,function(){clearTimeout(e.internal.autohideId),e.internal.autohideId=setTimeout(function(){e.css.jq.gui.fadeOut(e.options.autohide.fadeOut)},e.options.autohide.hold)})};this.css.jq.gui.length&&(this.css.jq.gui.stop(!0,!0),clearTimeout(this.internal.autohideId),this.element.unbind(".jPlayerAutohide"),this.css.jq.gui.unbind(".jPlayerAutohide"),this.status.nativeVideoControls?this.css.jq.gui.hide():this.options.fullScreen&&this.options.autohide.full||!this.options.fullScreen&&this.options.autohide.restored?(this.element.bind("mousemove.jPlayer.jPlayerAutohide",t),this.css.jq.gui.bind("mousemove.jPlayer.jPlayerAutohide",t),this.css.jq.gui.hide()):this.css.jq.gui.show())},"fullScreen":function(){this._setOption("fullScreen",!0)},"restoreScreen":function(){this._setOption("fullScreen",!1)},"_html_initMedia":function(){this.htmlElement.media.src=this.status.src,"none"!==this.options.preload&&this._html_load(),this._trigger(e.jPlayer.event.timeupdate)},"_html_setAudio":function(t){var s=this;e.each(this.formats,function(e,n){return s.html.support[n]&&t[n]?(s.status.src=t[n],s.status.format[n]=!0,s.status.formatType=n,!1):void 0}),this.htmlElement.media=this.htmlElement.audio,this._html_initMedia()},"_html_setVideo":function(t){var s=this;e.each(this.formats,function(e,n){return s.html.support[n]&&t[n]?(s.status.src=t[n],s.status.format[n]=!0,s.status.formatType=n,!1):void 0}),this.status.nativeVideoControls&&(this.htmlElement.video.poster=this._validString(t.poster)?t.poster:""),this.htmlElement.media=this.htmlElement.video,this._html_initMedia()},"_html_resetMedia":function(){this.htmlElement.media&&(this.htmlElement.media.id===this.internal.video.id&&!this.status.nativeVideoControls&&this.internal.video.jq.css({"width":"0px","height":"0px"}),this.htmlElement.media.pause())},"_html_clearMedia":function(){this.htmlElement.media&&(this.htmlElement.media.src="",this.htmlElement.media.load())},"_html_load":function(){this.status.waitForLoad&&(this.status.waitForLoad=!1,this.htmlElement.media.load()),clearTimeout(this.internal.htmlDlyCmdId)},"_html_play":function(e){var t=this;if(this._html_load(),this.htmlElement.media.play(),!isNaN(e))try{this.htmlElement.media.currentTime=e}catch(s){return this.internal.htmlDlyCmdId=setTimeout(function(){t.play(e)},100),void 0}this._html_checkWaitForPlay()},"_html_pause":function(e){var t=this;if(e>0?this._html_load():clearTimeout(this.internal.htmlDlyCmdId),this.htmlElement.media.pause(),!isNaN(e))try{this.htmlElement.media.currentTime=e}catch(s){return this.internal.htmlDlyCmdId=setTimeout(function(){t.pause(e)},100),void 0}e>0&&this._html_checkWaitForPlay()},"_html_playHead":function(e){var t=this;this._html_load();try{if("object"==typeof this.htmlElement.media.seekable&&this.htmlElement.media.seekable.length>0)this.htmlElement.media.currentTime=e*this.htmlElement.media.seekable.end(this.htmlElement.media.seekable.length-1)/100;else{if(!(this.htmlElement.media.duration>0)||isNaN(this.htmlElement.media.duration))throw"e";this.htmlElement.media.currentTime=e*this.htmlElement.media.duration/100}}catch(s){return this.internal.htmlDlyCmdId=setTimeout(function(){t.playHead(e)},100),void 0}this.status.waitForLoad||this._html_checkWaitForPlay()},"_html_checkWaitForPlay":function(){this.status.waitForPlay&&(this.status.waitForPlay=!1,this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide(),this.status.video&&(this.internal.poster.jq.hide(),this.internal.video.jq.css({"width":this.status.width,"height":this.status.height})))},"_html_volume":function(e){this.html.audio.available&&(this.htmlElement.audio.volume=e),this.html.video.available&&(this.htmlElement.video.volume=e)},"_html_mute":function(e){this.html.audio.available&&(this.htmlElement.audio.muted=e),this.html.video.available&&(this.htmlElement.video.muted=e)},"_flash_setAudio":function(t){var s=this;try{e.each(this.formats,function(e,n){if(s.flash.support[n]&&t[n]){switch(n){case"m4a":case"fla":s._getMovie().fl_setAudio_m4a(t[n]);break;case"mp3":s._getMovie().fl_setAudio_mp3(t[n])}return s.status.src=t[n],s.status.format[n]=!0,s.status.formatType=n,!1}}),"auto"===this.options.preload&&(this._flash_load(),this.status.waitForLoad=!1)}catch(n){this._flashError(n)}},"_flash_setVideo":function(t){var s=this;try{e.each(this.formats,function(e,n){if(s.flash.support[n]&&t[n]){switch(n){case"m4v":case"flv":s._getMovie().fl_setVideo_m4v(t[n])}return s.status.src=t[n],s.status.format[n]=!0,s.status.formatType=n,!1}}),"auto"===this.options.preload&&(this._flash_load(),this.status.waitForLoad=!1)}catch(n){this._flashError(n)}},"_flash_resetMedia":function(){this.internal.flash.jq.css({"width":"0px","height":"0px"}),this._flash_pause(0/0)},"_flash_clearMedia":function(){try{this._getMovie().fl_clearMedia()}catch(e){this._flashError(e)}},"_flash_load":function(){try{this._getMovie().fl_load()}catch(e){this._flashError(e)}this.status.waitForLoad=!1},"_flash_play":function(e){try{this._getMovie().fl_play(e)}catch(t){this._flashError(t)}this.status.waitForLoad=!1,this._flash_checkWaitForPlay()},"_flash_pause":function(e){try{this._getMovie().fl_pause(e)}catch(t){this._flashError(t)}e>0&&(this.status.waitForLoad=!1,this._flash_checkWaitForPlay())},"_flash_playHead":function(e){try{this._getMovie().fl_play_head(e)}catch(t){this._flashError(t)}this.status.waitForLoad||this._flash_checkWaitForPlay()},"_flash_checkWaitForPlay":function(){this.status.waitForPlay&&(this.status.waitForPlay=!1,this.css.jq.videoPlay.length&&this.css.jq.videoPlay.hide(),this.status.video&&(this.internal.poster.jq.hide(),this.internal.flash.jq.css({"width":this.status.width,"height":this.status.height})))},"_flash_volume":function(e){try{this._getMovie().fl_volume(e)}catch(t){this._flashError(t)}},"_flash_mute":function(e){try{this._getMovie().fl_mute(e)}catch(t){this._flashError(t)}},"_getMovie":function(){return document[this.internal.flash.id]},"_checkForFlash":function(e){var t,s=!1;if(window.ActiveXObject)try{new ActiveXObject("ShockwaveFlash.ShockwaveFlash."+e),s=!0}catch(n){}else navigator.plugins&&navigator.mimeTypes.length>0&&(t=navigator.plugins["Shockwave Flash"])&&navigator.plugins["Shockwave Flash"].description.replace(/.*\s(\d+\.\d+).*/,"$1")>=e&&(s=!0);return s},"_validString":function(e){return e&&"string"==typeof e},"_limitValue":function(e,t,s){return t>e?t:e>s?s:e},"_urlNotSetError":function(t){this._error({"type":e.jPlayer.error.URL_NOT_SET,"context":t,"message":e.jPlayer.errorMsg.URL_NOT_SET,"hint":e.jPlayer.errorHint.URL_NOT_SET})},"_flashError":function(t){var s;s=this.internal.ready?"FLASH_DISABLED":"FLASH",this._error({"type":e.jPlayer.error[s],"context":this.internal.flash.swf,"message":e.jPlayer.errorMsg[s]+t.message,"hint":e.jPlayer.errorHint[s]}),this.internal.flash.jq.css({"width":"1px","height":"1px"})},"_error":function(t){this._trigger(e.jPlayer.event.error,t),this.options.errorAlerts&&this._alert("Error!"+(t.message?"\n\n"+t.message:"")+(t.hint?"\n\n"+t.hint:"")+"\n\nContext: "+t.context)},"_warning":function(s){this._trigger(e.jPlayer.event.warning,t,s),this.options.warningAlerts&&this._alert("Warning!"+(s.message?"\n\n"+s.message:"")+(s.hint?"\n\n"+s.hint:"")+"\n\nContext: "+s.context)},"_alert":function(e){alert("jPlayer "+this.version.script+" : id='"+this.internal.self.id+"' : "+e)},"_emulateHtmlBridge":function(){var t=this;e.each(e.jPlayer.emulateMethods.split(/\s+/g),function(e,s){t.internal.domNode[s]=function(e){t[s](e)}}),e.each(e.jPlayer.event,function(s,n){var i=!0;e.each(e.jPlayer.reservedEvent.split(/\s+/g),function(e,t){return t===s?i=!1:void 0}),i&&t.element.bind(n+".jPlayer.jPlayerHtml",function(){t._emulateHtmlUpdate();var e=document.createEvent("Event");e.initEvent(s,!1,!0),t.internal.domNode.dispatchEvent(e)})})},"_emulateHtmlUpdate":function(){var t=this;e.each(e.jPlayer.emulateStatus.split(/\s+/g),function(e,s){t.internal.domNode[s]=t.status[s]}),e.each(e.jPlayer.emulateOptions.split(/\s+/g),function(e,s){t.internal.domNode[s]=t.options[s]})},"_destroyHtmlBridge":function(){var t=this;this.element.unbind(".jPlayerHtml"),e.each((e.jPlayer.emulateMethods+" "+e.jPlayer.emulateStatus+" "+e.jPlayer.emulateOptions).split(/\s+/g),function(e,s){delete t.internal.domNode[s]})}},e.jPlayer.error={"FLASH":"e_flash","FLASH_DISABLED":"e_flash_disabled","NO_SOLUTION":"e_no_solution","NO_SUPPORT":"e_no_support","URL":"e_url","URL_NOT_SET":"e_url_not_set","VERSION":"e_version"},e.jPlayer.errorMsg={"FLASH":"jPlayer's Flash fallback is not configured correctly, or a command was issued before the jPlayer Ready event. Details: ","FLASH_DISABLED":"jPlayer's Flash fallback has been disabled by the browser due to the CSS rules you have used. Details: ","NO_SOLUTION":"No solution can be found by jPlayer in this browser. Neither HTML nor Flash can be used.","NO_SUPPORT":"It is not possible to play any media format provided in setMedia() on this browser using your current options.","URL":"Media URL could not be loaded.","URL_NOT_SET":"Attempt to issue media playback commands, while no media url is set.","VERSION":"jPlayer "+e.jPlayer.prototype.version.script+" needs Jplayer.swf version "+e.jPlayer.prototype.version.needFlash+" but found "},e.jPlayer.errorHint={"FLASH":"Check your swfPath option and that Jplayer.swf is there.","FLASH_DISABLED":"Check that you have not display:none; the jPlayer entity or any ancestor.","NO_SOLUTION":"Review the jPlayer options: support and supplied.","NO_SUPPORT":"Video or audio formats defined in the supplied option are missing.","URL":"Check media URL is valid.","URL_NOT_SET":"Use setMedia() to set the media URL.","VERSION":"Update jPlayer files."},e.jPlayer.warning={"CSS_SELECTOR_COUNT":"e_css_selector_count","CSS_SELECTOR_METHOD":"e_css_selector_method","CSS_SELECTOR_STRING":"e_css_selector_string","OPTION_KEY":"e_option_key"},e.jPlayer.warningMsg={"CSS_SELECTOR_COUNT":"The number of css selectors found did not equal one: ","CSS_SELECTOR_METHOD":"The methodName given in jPlayer('cssSelector') is not a valid jPlayer method.","CSS_SELECTOR_STRING":"The methodCssSelector given in jPlayer('cssSelector') is not a String or is empty.","OPTION_KEY":"The option requested in jPlayer('option') is undefined."},e.jPlayer.warningHint={"CSS_SELECTOR_COUNT":"Check your css selector and the ancestor.","CSS_SELECTOR_METHOD":"Check your method name.","CSS_SELECTOR_STRING":"Check your css selector is a string.","OPTION_KEY":"Check your option name."}}(jQuery),function(e,t,s,n){var i=!("selectionStart"in e("<input type='text' />")[0]);e.fn.caret=function(e,a){var o,r,l=this[0];if("object"==typeof e&&"number"==typeof e.start&&"number"==typeof e.end)o=e.start,r=e.end;else if("number"==typeof e&&"number"==typeof a)o=e,r=a;else if("string"==typeof e)(o=l.value.indexOf(e))>-1?r=o+e[t]:o=null;else if("[object RegExp]"===Object.prototype.toString.call(e)){var d=e.exec(l.value);null!=d&&(o=d.index,r=o+d[0][t])}if("undefined"!=typeof o){if(i){var c=this[0].createTextRange();c.collapse(!0),c.moveStart("character",o),c.moveEnd("character",r-o),c.select()}else this[0].selectionStart=o,this[0].selectionEnd=r;return this[0].focus(),this}if(i){var u=document.selection;if("textarea"!=this[0].tagName.toLowerCase()){var h=this.val(),m=u[s]()[n]();m.moveEnd("character",h[t]);var f=""==m.text?h[t]:h.lastIndexOf(m.text);m=u[s]()[n](),m.moveStart("character",-h[t]);var p=m.text[t]}else{var m=u[s](),g=m[n]();g.moveToElementText(this[0]),g.setEndPoint("EndToEnd",m);var f=g.text[t]-m.text[t],p=f+m.text[t]}}else var f=l.selectionStart,p=l.selectionEnd;var v=l.value.substring(f,p);return{"start":f,"end":p,"text":v,"replace":function(e){return l.value.substring(0,f)+e+l.value.substring(p,l.value[t])}}}}(jQuery,"length","createRange","duplicate");var markdownMini=function(){var e=/(^|.(?=\*)|[\s,('"[{-])(?:\*\*|__)(?=\S)(.+?\S)(?:\*\*|__(?=[\s,?!.;:)\]}-]|$))/g,t=/(^|.(?=\*)|[\s,('">[{-])(?:\*|_)(?=\S)(.+?\S)(?:\*|_(?=[\s,?!.;:)<\]}-]|$))/g,s=/(^|[\s,('">[{-])---(?=\S)(.+?\S)---(?=[\s,?!.;:)<\]}-]|$)/g,n=/(^|\W|_)(`+)(?!\s)(.*?[^`])\2(?!`)/g,i=/(^|\s)\[([^\]]+)\]\(((?:https?|ftp):\/\/(?:\([^()\s]*\)|[^)\s])+?)(?:\s(?:"|&quot;)([^"]+?)(?:"|&quot;))?\)/g;return function(a){if(a=a.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),/[\n\r]/.test(a)){var o=!/^ {0,3}[^ ]/m.test(a);return o?"<pre>"+a.replace(/^    /gm,"")+"</pre>":"<div>"+a.replace(/\r\n?|\n/g,"<br/>")+"</div>"}return a=a.replace(/\\`/g,"&#96;"),a=a.replace(/\\\*/g,"&#42;"),a=a.replace(/\\_/g,"&#95;"),a=a.replace(/\\\[/g,"&#91;"),a=a.replace(/\\\]/g,"&#93;"),a=a.replace(/\\\(/g,"&#40;"),a=a.replace(/\\\)/g,"&#41;"),a=a.replace(n,"$1<code>$3</code>"),a=a.replace(e,"$1<b>$2</b>"),a=a.replace(t,"$1<i>$2</i>"),a=a.replace(s,"$1<strike>$2</strike>"),a=a.replace(i,'$1<a href="$3" title="$4">$2</a>')
}}(),autoLink=function(){function e(e,s){if(e=t(e),e.length<s)return e;for(var n=e.length-1;n>0;n--)if("/"==e[n]&&s>n)return e.substring(0,n)+"/&hellip;";return e.substring(0,s-1)+"&hellip;"}function t(e){return e.replace(a,"")}function s(t){return'<a href="'+t.replace(r,"")+'">'+e(t,30)+"</a>"}function n(e,t,n){if(")"!==n.charAt(n.length-1))return t+s(n);for(var i=n.match(/[()]/g),a=0,o=0;o<i.length;o++)"("===i[o]?0>=a?a=1:a++:a--;var r="";if(0>a){var l=new RegExp("\\){1,"+-a+"}$");n=n.replace(l,function(e){return r=e,""})}return t+s(n)+r}var i=/([^">;]|^)\b((?:https?|ftp):\/\/[A-Za-z0-9][-A-Za-z0-9+&@#\/%?=~_|\[\]\(\)!:,.;]*[-A-Za-z0-9+&@#\/%=~_|\[\])])/gi,a=/^(https?|ftp):\/\/(www\.)?|(\/$)/gi,o="&zwnj;&#8203;",r=new RegExp(o,"g"),l=new RegExp($("<span>"+o+"</span>").text(),"g");return function(e){return e.replace(l,o).replace(i,n)}}(),diacSubstitutions={"Ã Ã¥Ã¡Ã¢Ã¤Ã£Ã¥Ä…Éáµ„á¶›":"a","Ã¦Ç£Ç½á´‚áµ†":"ae","Ã§Ä‡ÄÄ‰":"c","Ä‘ÆÃ°Ã":"d","Ã¨Ã©ÃªÃ«Ä™Çá´ˆáµŒ":"e","â…Ž":"f","ÄŸÄáµ·":"g","Ä¥É¥Ê®á¶£":"h","Ã¬Ã­Ã®Ã¯Ä±á´‰áµŽ":"i","Äµ":"j","Êž":"k","Å‚":"l","É¯É°áµšá¶­á´Ÿ":"m","Ã±Å„":"n","Ã²Ã³Ã´ÃµÃ¶Ã¸Å‘":"o","Å“É¶á´”":"oe","Å™É¹ÉºÉ»Ê´Êµ":"r","Å›ÅŸÅ¡Å":"s","ÃŸ":"ss","Ê‡":"t","Ãž":"th","Ã¹ÃºÃ»Ã¼Å­Å¯":"u","ÊŒá¶º":"v","Ê":"w","Ã½Å¸Ã¿ÊŽ":"y","Å¼ÅºÅ¾":"z"},diacritics="";!function(){for(var e in diacSubstitutions)diacritics+=e}(),window.stringify=window.JSON?JSON.stringify:function(e){if("string"==typeof e)return'"'+e.replace(/\\/g,"\\\\").replace(/"/g,'\\"').replace(/\n/g,"\\n").replace(/\r/g,"\\r")+'"';if("number"==typeof e)return e.toString();if(null==e)return"null";if(void 0==e)return"undefined";if(void 0!=e.length)return"["+$.map(e,stringify).join(",")+"]";var t="{";for(var s in e)t=t+stringify(s)+":"+stringify(e[s])+",";return t.length>1&&(t=t.substr(0,t.length-1)),t+"}"},function(e){function t(t){function s(e){var t={"sender":m,"time":h(),"id":f,"message":e};return f++,t}function n(e){var s=JSON.stringify(e);try{localStorage.setItem(t,s)}catch(n){}g.length&&u(s)}function i(e){n(s(e))}function a(e,t){var i=s(e);i.recipient=t,n(i)}function o(e,t,i,a,o){var r=s(e);a&&(r.recipient=a),r.rsvp=!0,v[r.id]=[],setTimeout(function(){var e=v[r.id];delete v[r.id];for(var s=[],n=[],i=0;i<e.length;i++)(o||e[i].sender!==m)&&(s.push(e[i].message),n.push(e[i]));t(s,n)},i||100),n(r)}function r(e){return function(t){var i=s(t);i.recipient=e.sender,i.inResponseTo=e.id,n(i)}}function l(t,s){!p.length&&e.addEventListener&&e.addEventListener("storage",c),p.push(t),s&&g.push(t)}function d(e,t){if("recipient"in e){if(e.recipient!==m)return;if("inResponseTo"in e){var s=v[e.inResponseTo];if(!s)return;return s.push(e),void 0}}for(var n=0;n<t.length;n++)e.rsvp?t[n](e.message,e,r(e)):t[n](e.message,e)}function c(e){if(e.key===t&&e.newValue){var s=JSON.parse(e.newValue);s.sender!==m&&d(s,p)}}var u,h=Date.now||function(){return(new Date).getTime()},m=h()+"-"+Math.random(),f=0,p=[],g=[],v={};if(e.postMessage&&e.addEventListener){var y="messenger-self-"+m+"-",_=new RegExp("^"+y+"(.*)$");e.addEventListener("message",function(t){t.source===e&&t.data.replace(_,function(e,t){d(JSON.parse(t),g)})},!1),u=function(t){e.postMessage(y+t,"*")}}else u=function(e){setTimeout(function(){d(JSON.parse(e),g)},0)};return{"broadcast":i,"unicast":a,"onReceive":l,"request":o,"id":m}}var s={};e.Messenger=function(e,n){var i="m_"+e,a=s[i];return a||(s[i]=a=t(e)),{"broadcast":a.broadcast,"unicast":a.unicast,"onReceive":function(e){return a.onReceive(e,n)},"request":function(e,t,s,i){return a.request(e,t,s,i,n)},"id":a.id}}}(window),window.DelayedReaction=DelayedReaction;var users={},legalImgurSizes=[16,18,24,28,32,42,48,50,64,65,90,128],imgurProfileImage=/^http:\/\/i.stack.imgur.com\//;!function(){function e(e){return e in ROOM_USERS_BY_ID||(ROOM_USERS_BY_ID[e]=new n(e)),ROOM_USERS_BY_ID[e]}function t(e){var t=PENDING_SERVER_LOADS_BY_ID[e];return t||(PENDING_SERVER_LOADS_BY_ID[e]=t=$.Deferred(),IDS_TO_BE_LOADED_FROM_SERVER.push(e),c.trigger()),t.promise()}function s(){$.get("/rooms/pingable/"+CHAT.CURRENT_ROOM_ID).done(function(t){Generator(t).forEach(function(t){e(t[0]).updateFrom({"name":t[1],"last_seen":t[2],"last_post":t[3]},!0,!0)}),CHAT.RoomUsers.trigger("loadpingable",Generator(t).map("0"))})}function n(e,t){return this instanceof n?(this.id=e,t&&this.updateFrom(t),void 0):new n(e,t)}function i(e){var t=0,s=$([]);e.forEach(function(e){t++;var n=e.last_post||0,i=a(e.id,e.name,n);CHAT.RoomUsers.updateUserContainer(i),o(i,n),t>32&&i.hide(),s=s.add(i)}),$("#present-users").prepend(s).closest(".sidebar-widget").find(".more").setVisible(t>32).attr("title","show "+(t-32)+" more")}function a(e,t,s){var n=$('<li class="present-user"/>').attr("id","present-user-"+e).addClass("user-container user-"+e).data("user",e);shouldShowUser(e)||n.addClass("ignored");var i=$('<img class="user-gravatar32" width="32" height="32"/>').attr("alt",t).attr("title",t);if(CHAT.IS_MOBILE){var a=$('<a class="userlink"/>').appendTo(n);a.append(div("avatar").append(i)).append(div("username"))}else n.append(div("avatar").append(i));return n.append(span("data").append(span("last-activity-time").text(s))),n}function o(e,t){if(!CHAT.IS_MOBILE){var s=secondsSince(t),n=1-.85*Math.max(Math.min(s/3600,1),0);e.css({"opacity":n})}}function r(){CHAT.IS_MOBILE||$("#present-users").find(".present-user").each(function(){var e=$(this);o(e,e.find(".data > .last-activity-time").text())})}function l(){setInterval(function(){var e=now();d.all().filter(function(t){return e-(t.last_server_refresh||0)>u}).forEach(function(e){e.updateFromServer()})},h),setInterval(function(){d.allPresent().forEach(function(e){e.seen()})},m),CHAT.IS_MOBILE||setInterval(r,1e4)}var d=CHAT.RoomUsers;ROOM_USERS_BY_ID={},IDS_TO_BE_LOADED_FROM_SERVER=[],PENDING_SERVER_LOADS_BY_ID={};var c=DelayedReaction(function(){var e=IDS_TO_BE_LOADED_FROM_SERVER.join(","),t=IDS_TO_BE_LOADED_FROM_SERVER.splice(0);$.post("/user/info",{"ids":e,"roomId":CHAT.CURRENT_ROOM_ID},"json").done(function(e){var s={};Generator(e.users).forEach(function(e){s[e.id]=!0;var t=PENDING_SERVER_LOADS_BY_ID[e.id];delete PENDING_SERVER_LOADS_BY_ID[e.id],t.resolve(e)}),Generator(t).forEach(function(e){if(!s[e]){var t=PENDING_SERVER_LOADS_BY_ID[e];delete PENDING_SERVER_LOADS_BY_ID[e],t.reject(),$("#present-user-"+e).remove()}})}).fail(function(){Generator(t).forEach(function(e){var t=PENDING_SERVER_LOADS_BY_ID[e];delete PENDING_SERVER_LOADS_BY_ID[e],t.reject()})})},500,{"sliding":!0});d.get=function(t){var s=e(t);return s.complete?$.Deferred().resolve(s).promise():s.updateFromServer()},d.forceUpdate=function(t){e(t).updateFromServer()},d.forceUpdateIfNecessary=function(e){var t=ROOM_USERS_BY_ID[e];t&&(t.isVisibleOnPage()||t.isPingable())&&t.updateFromServer()},d.pingableUsersIncludeIncomplete=function(){return d.allIncludeIncomplete().filter(function(e){return e.isPingable()}).sortBy(function(e){return-(e.last_post||0)})},d.current=function(){return e(CHAT.CURRENT_USER_ID)},d.update=function(t,s,n,i){e(t).updateFrom(s,n,i)},d.all=function(){return d.allIncludeIncomplete().filter("complete")},d.allIncludeIncomplete=function(){return Generator(ROOM_USERS_BY_ID).map("1")},d.allPresent=function(){return d.all().filter(function(e){return e.isPresent()})},d.getIfAvailable=function(e,t){var s=ROOM_USERS_BY_ID[e];return s&&(t||s.complete)?s:void 0},n.prototype={"updateFrom":function(e,t,s){function n(t){var s=!1;return t in e&&(s=i[t]!==e[t],i[t]=e[t]),s}var i=this,a=!1;a=n("name")||a,a=n("email_hash")||a,a=n("reputation")||a,a=n("is_moderator")||a,a=n("is_owner")||a,n("last_post"),n("last_seen"),s||(this.complete=!0,this.last_server_refresh=now()),a&&!t&&d.updateAllUserContainersFor(this)},"updateFromServer":function(){var e=this;return t(this.id).pipe(function(t){return e.updateFrom(t),e}).promise()},"setIfBigger":function(e,t){var s=this[e];("number"!=typeof s||t>s)&&(this[e]=t)},"isPingable":function(){return this.id>0&&this.id!==CHAT.CURRENT_USER_ID&&(this.isPresent()||this.hasEverSpoken()&&secondsSince(this.last_seen||0)<604800)},"hasEverSpoken":function(){return!!this.last_post},"isPresent":function(){return this.is_present},"isVisibleOnPage":function(){return!!$(".user-container.user-"+this.id+":first").length},"leave":function(){this.is_present=!1,d.sidebarLeave(this.id)},"enter":function(){this.is_present=!0,this.seen(),d.sidebarActivity(this.id,this.name,!0,now(),this.email_hash)},"talk":function(e){this.setIfBigger("last_post",e||now())},"activity":function(e){d.sidebarActivity(this.id,this.name,!1,e||now(),this.email_hash)},"seen":function(){this.last_seen=now()}},d.updateUserContainer=function(e,t){var s="undefined"!=typeof t?t:e.data("user");return s&&0!=s.toString().length?d.get(s).done(function(t){var n=e.find(".username");n.each(function(){var e=$(this);0!=e.closest(".tiny-signature").length?e.html(lineBreakBeforeHyphen(t.name)):e.html(lineBreakAfterHyphen(t.name))});var i=!!t.is_moderator;n.toggleClass("moderator",i),n.toggleClass("owner",!!t.is_owner&&!i),e.find(".userlink,a.signature").attr("href","/users/"+t.id+"/"+urlFriendly(t.name)),e.find(".avatar > img").each(function(){$(this).attr("src",gravatarUrl(s,t.email_hash,$(this).attr("width"))).attr("alt",t.name).attr("title",t.name)}),s>0&&e.find(".flair").text(repNumber(t.reputation)).attr("title",t.reputation)}):$.Deferred().reject().promise()},d.updateAllUserContainersFor=function(e){$(".user-container.user-"+e.id).each(function(){d.updateUserContainer($(this))})},d.monologueSignature=function(e){var t=$("<a href='/users/"+e+"' />").addClass("signature user-"+e),s=$("<div/>").addClass("username").hide(),n=$("<div><img width='32' height='32'/><div>").addClass("avatar avatar-32 clear-both").hide(),i=$("<div/>").addClass("flair").hide(),a=$("<div/>").addClass("tiny-signature"),o=$("<div><img width='16' height='16'/></div>").addClass("avatar avatar-16"),r=$("<div/>").addClass("username");return a.append(o,r),t.append(a,n,s,i),0==e?(t.find("img").attr("src",IMAGE("anon.png")),t):(s.add(r).html("<i>loading&hellip;</i>"),d.updateUserContainer(t,e),t)},d.sidebarActivity=function(e,t,s,n){var i=$("#present-users");s=s&&i.find("li.present-user").length<=32,void 0==n&&(n=now());var r=$("#present-user-"+e);if(r.find(".data > .last-activity-time").text(n),(0==r.length||r.hasClass("leaving"))&&(r.remove(),r=a(e,t,n)),CHAT.RoomUsers.updateUserContainer(r),o(r,n),s&&!CHAT.IS_MOBILE&&shouldShowUser(e)){r.prependTo(i),r.css({"visibility":"hidden","width":0}),r.addClass("arriving"),r.animate({"width":32},3e3).css("overflow","");var l=div("user-container fly-in-user").data("user",e);l.css({"top":-100,"left":r.offset().left}).appendTo("#main"),l.append(r.find(".avatar").clone()),l.append(span("username").text(t||""));var d=!1,c=function(){d||(d=!0,l.animate({"top":[r.offset().top-$(window).scrollTop()-11,"swing"],"left":[r.offset().left-$(window).scrollLeft()-11,"linear"]},3e3,function(){r.css({"visibility":"visible"}),r.removeClass("arriving"),l.fadeOut(500,function(){l.remove()})}))};CHAT.RoomUsers.updateUserContainer(l).done(c),window.setTimeout(c,5e3)}else r.prependTo(i);r.show(),CHAT.IS_MOBILE?Mobile.page(i):i.updateCollapsible()},d.sidebarLeave=function(e){var t=function(){$(this).remove(),$("#present-users").updateCollapsible()},s=$("#present-user-"+e).addClass("leaving");if(s.length){if($("#present-users li.present-user").length>32)return s.remove(),$("#present-users").updateCollapsible(),void 0;if(shouldShowUser(e)){var n=s.find(".avatar").clone().css({"zIndex":3,"position":"fixed","top":s.offset().top-$(window).scrollTop(),"left":s.offset().left-$(window).scrollLeft()}).appendTo("body").hide().fadeIn(500,function(){s.css({"visibility":"hidden"})});n.animate({"left":["-=100px","linear"],"top":["+=200px","swing"],"opacity":0},3e3,t)}s.animate({"width":0},3e3,t).css("overflow","")}},d.createAvatarImage=function(e,t){var s,n=d.getIfAvailable(e);s=n?gravatarUrl(e,n.email_hash,t):IMAGE("anon.png");var i=$("<img />").attr("width",t).attr("height",t).attr("src",s);return n||d.get(e).done(function(s){i.attr("src",gravatarUrl(e,s.email_hash,t))}),i},ROOM_USERS_HANDLERS={},d.on=function(e,t){e="e_"+e;var s=ROOM_USERS_HANDLERS[e];s||(s=ROOM_USERS_HANDLERS[e]=$.Callbacks()),s.add(t)},d.trigger=function(e){e="e_"+e;var t=ROOM_USERS_HANDLERS[e];t&&t.fire.apply(t,Array.prototype.slice.call(arguments,1))};var u=3600,h=3e5,m=6e4;d.initPresent=function(t){i(Generator(t).map(function(t){var s=e(t.id);return s.updateFrom(t,!0),s.is_present=!0,s.seen(),s}))},d.initializeLate=function(e){l(),e&&s()}}(),$.fn.fastHide=function(e){e?this.slideUp(e):this.css("display","none")},$.fn.fastShow=function(e){e?this.slideDown(e):this.css("display",this.hasClass("present-user")?"inline-block":"block")},$.fn.updateCollapsible=function(e){var t,s=this.find("li").not(".more"),n=e||s.length>32?0:500,i=this.closest(".sidebar-widget"),a=i.find(".more");t=a.is("li")?function(e){a.attr("title",e)}:function(e){a.text(e)};var o=this.data("show_max"),r=!!this.data("autohide");void 0==o&&(o=5);var l=s.slice(0,o).add(s.filter(".always-visible"));s.length>o?(this.hasClass("expanded")?s.fastShow(n):(l.fastShow(n),s.filter(".always-visible").fastShow(n),s.not(l).fastHide(n)),this.hasClass("expanded")?t("only show top "+l.length):t("show "+(s.length-l.length)+" more"),a.show()):(a.hide(),s.fastShow(n)),r&&(s.length>0?i.fastShow(n):i.fastHide(n))},function(){function e(){h=now(),m&&(m=!1,setTimeout(c.onProblemResolved,0))}function t(){m=!0,setTimeout(c.onProblem,0)}function s(){function e(e){n&&clearTimeout(n),n=setTimeout(t,e),$("#timer").text("icc "+(0|e))}function t(){n=null,debugMessage("no data received via icc in time"),s.onClose()}var s={};if(!c.icc)return s;c.icc.receive(function(t){var n=t.content.command;if("poll"===n||"master closing"===n){if(!t.senderIsSenior)return debugMessage("sender icc is not senior; ignoring");if("master closing"===n)return debugMessage("master is closing"),e(1),void 0;var i=t.content.data;if(l in i){var a=t.content.since,r=t.content.until;if(a){if(a>o)return debugMessage("icc data is too new");if(o>r)return debugMessage("icc data is too old");o=r,e("socket"===t.content.source?4e4:2*d()),s.onData(i,a)}}}});var n;return s}function n(e){function t(e,t){if(d===this){var s=this===m?"poll":"socket";l in e&&"t"in e[l]&&(o=e[l].t),h.onData(e,t,s)}f===this&&(p=u)}function s(){d||(d=c?m:f||m,d.open())}function n(){d&&(d.close(),d=null)}function r(){d==m&&m.dataExpected()}var d,c,h,m=i(),f=e?a():null,p=u;return h={"open":s,"close":n,"dataExpected":r},f&&(f.onClose=function(e){d===this&&(e?(h.onClose(!0),d=null):(debugMessage("socket closed or unable to open; starting polling, will retry socket in "+p+"s"),d=m,m.open(),c=setTimeout(function(){return c=null,d!==m?(debugMessage("not retrying socket since not polling"),void 0):(d=f,m.close(),f.open(),void 0)},1e3*p),p*=2))},f.onData=t),m.onClose=function(e){d===this&&(h.onClose(e),d=null)},m.onData=t,h}function i(){function e(){r||(r=!0,s())}function t(e){r&&(r=!1,u&&(clearTimeout(u),u=null),h.onClose(e))}function s(){if(!c&&r){var e=fkey(),t=o;e[l]=t,c=$.ajax("/events",{"data":e,"timeout":1e4,"type":"POST"}).always(function(){c=null,setTimeout(function(){n()},0)}).done(function(e){i(e,o)}).fail(a)}}function n(e){if(r){u&&clearTimeout(u);var t;t="number"==typeof e?e:d(),u=setTimeout(function(){u=null,s()},t),$("#timer").text("poll "+(0|t))}}function i(e,t){m=0,r&&h.onData(e,t)}function a(){m++,m>=3&&t(!1)}var r,c,u,h={"open":e,"close":function(){t(!0)},"dataExpected":function(){n(2e3)}},m=0;return h}function a(){function e(){return u&&(u.readyState===f.OPEN||u.readyState===f.CONNECTING)}function t(){e()||n().done(d).fail(function(){c.onClose(!1)})}function s(t){e()&&(u.closingDeliberately=t,u.close(),u=null)}function n(){return $.post("/ws-auth",fkey({"roomid":r})).pipe(function(e){return{"url":e.url+"?l="+o,"since":o}})}function i(e){h&&clearTimeout(h),h=setTimeout(a,e),$("#timer").text("ws "+(0|e))}function a(){return h=null,e()?(debugMessage("no data received via socket in time"),s(!1),void 0):(debugMessage("no data received via socket in time, but ignoring because there's no active socket: "+(u?u.readyState:"none")),void 0)}function d(t){if(!e()){var s=t.url,n=t.since;u=new f(s),u.onopen=function(){debugMessage("socket successfully opened")},u.onclose=function(){u=null,c.onClose(this.closingDeliberately)},u.onmessage=function(e){if(e&&e.data){var t=$.parseJSON(e.data);c.onData(t,n),l in t&&"t"in t[l]&&(n=t[l].t),i(4e4)}},u.onerror=function(){return this.closingDeliberately?(debugMessage("ignoring error on deliberately closed socket"),void 0):(u=null,c.onClose(!1),void 0)},i(1e4)}}if(!f)return null;var c,u;c={"open":t,"close":function(){s(!0)}};var h;return c}var o,r,l,d,c,u=30;window.TheThingThatGetsDataFromTheServer=function(i){if(c)throw"already initialized";c=i,o=i.lastKnownId,r=i.roomId,l=i.roomKey,d=i.getPollingDelay;var a,u=n(i.useWebsocket),h=s();return h.onData=function(t,s){e(),a||debugMessage("got data from ICC; closing server connection"),a=!0,u.close(),i.onData(t,s)},h.onClose=function(){debugMessage("opening server connection"),a=!1,u.open()},u.onData=function(t,s,n){e(),t.since=s,c.icc&&c.icc.broadcast({"command":"poll","data":t,"since":s,"until":o,"source":n}),i.onData(t)},u.onClose=function(e){e||(t(),setTimeout(function(){u.open()},4e3))},c.icc&&c.icc.receive(function(e){"data expected"!==e.content.command||a||u.dataExpected()}),u.open(),{"windowClosing":function(){a||(i.icc.broadcast({"command":"master closing"}),u.close())},"dataExpected":function(){a?c.icc.broadcast({"command":"data expected"}):u.dataExpected()}}};var h=now();setInterval(function(){secondsSince(h)>120&&!m&&(debugMessage("connection problem was only noticed by life check"),t())},2e4);var m,f=window.WebSocket||window.MozWebSocket}();var hiddenUsers={},SERVER_TIME_OFFSET,TITLE_UPDATE_DELAY=200;$.fn.potentialHeight=function(){if(this.is(":visible"))return this.height();var e=$("<div/>").css({"height":0,"clear":"both","overflow":"hidden"}),t=this.wrap(e).show().height();return this.hide().unwrap(),e.removeData(),t},$.fn.putInto=function(e){return e.put(this),this},$.fn.setVisible=function(e){return e?this.show():this.hide(),this},$.fn.messageId=function(){return parseInt(this.attr("id").substr(8))},$.fn.info=function(e,t){var s=this.data("info");return 1==arguments.length?s?s[e]:void 0:(s?s[e]=t:(s={},s[e]=t,this.data("info",s)),this)};var containers={"needyMonologues":Container(),"timeTreatmentNeedy":Container()},Eggs={};Eggs.load=function(e){var t=$("script").filter(function(){return/master-chat[\w-]*?\.js/i.test(this.src)}).eq(0);if(1==t.length){var s=t.attr("src").replace(/master-chat[\w-]*?\.js/i,"eggs.js").replace(/v=\w+/,"v=3");loaded=function(){for(var t in Eggs)Eggs.hasOwnProperty(t)&&"Current"!=t&&(t==e?Eggs.Current=Eggs[t]:delete Eggs[t]);"Asteroids"!=e&&delete window.initAsteroids,Eggs.Current&&Eggs.Current.init&&Eggs.Current.init()},$.ajax({"url":s,"success":loaded,"dataType":"script","cache":!0})}},Eggs.Current=function(){};var month_name=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],weekday_name=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];$(function(){$("#debug-message-container > h2").click(function(){$("#debug-messages").slideToggle(),$(this).css({"color":"black"})}),$("#debug-messages").dblclick(function(){$(".debug-message").slideUp(function(){$(this).remove()}),$("#debug-message-container > h2").text("Debug (0)")})}),function(){function e(e,t,s){var i=e.length,a=$([]);if(!i)return a;var o=s?20:10;i>o&&(e=e.slice(0,o-1));var r=CHAT.IS_MOBILE?5:i>1?10:20;if($.each(e,function(e,s){var i=s.first(),o=i.name,l=$("<li/>").data("mention-text",i.mention),d=0;if(s.forEach(function(e){d++,d>r||(e.hash?l.append($("<img />").attr("width",18).attr("height",18).attr("src",gravatarUrl(e.id,e.hash,18))):l.append(CHAT.RoomUsers.createAvatarImage(e.id,18)))}),d>r&&(l.find("img:last").remove(),l.append($("<span class='extra-info'/>").text("(+"+(d-r+1)+") "))),l.append($("<span class='mention-name'/>").text(o)),n&&"id"in i){var c=n(i.id,i.name);"string"==typeof c&&c?l.append($("<span class='extra-info' />").text(c)):c&&"function"==typeof c.done&&c.done(function(e){e&&l.append($("<span class='extra-info' />").text(e))})}a=a.add(l),(""+i.normalized).toLowerCase()==t.toLowerCase()?l.addClass("chosen"):i.autoselect&&setTimeout(function(){l.click()},0)}),i>o){var l=s?"":" "+(i-o+1);a=a.add($("<li class='too-many' />").html("<span>(and"+l+" more matches)</span>"))}return a}function t(e,t){if(t&&t()&&"@"===e.charAt(0))return{"word":e,"mode":o};var s=e.match(/^(?:[^@\s!?();:+]+|$)/);return s?{"word":s[0],"mode":a}:null}function s(e){function t(){d.empty(),u.completionWord=null}function s(e){var s=u.mode;e!==s&&(s&&s.stop&&s.stop(),u.mode=e,e&&e.start&&e.start(),u.originalWord=null,t())}function n(){var e=u.originalWord||u.word;if(u.completionWord!==e){u.completionWord=e,l=null;var t=u.mode.getCompletionItems(e);d.empty(),"function"==typeof t.done?(l=t,t.done(function(e){l===t&&(d.append(e),l=null)}).fail(function(){l===t&&(l=null)})):d.append(t)}}function i(t){var n=c.caret().start;if(n!==c.caret().end)return s(null),void 0;var i=c.val();if(-1===i.indexOf("@"))return s(null),void 0;var a=i.substring(n).search(/[\s]/);-1==a&&(a=i.length-n);var o=n+a,r=i.lastIndexOf(" @",o-1);if(-1===r?r=i.indexOf("@"):r++,-1===r)return s(null),void 0;for(var l,d=null;;){if(l=i.substring(r+1,n+a),-1===l.indexOf(" ")&&(d=e(l),d&&r+d.word.length+1>=n))break;if(r=i.indexOf("@",r+1),-1===r||r>n)break}return d?(o+=d.word.length-l.length,n>o?(s(null),void 0):(s(d.mode),t||d.word!==u.word&&(u.originalWord=null),u.atPos=r,u.cursorPos=n,u.word=d.word,void 0)):(s(null),void 0)}function a(e){if(!e)return"string"==typeof u.originalWord&&o(u.originalWord),void 0;var t=u.mode.completionFor(e);u.originalWord=u.originalWord||u.word,e.addClass("chosen"),o(t),i(!0)}function o(e){if(i(),u.word===e)return c.focus(),void 0;var t=c.val();c.val(t.substring(0,u.atPos+1)+e+t.substring(u.atPos+u.word.length+1));var s=u.atPos+e.length+1;c.caret(s,s)}function r(){function e(){i(),u.mode&&n()}c.on($.browser.opera?"keypress":"keydown",function(e){var t;switch(e.which){case 9:if(t=d.find("> li:not(.too-many)"),!t.length)return;var s=t.filter(".chosen").removeClass("chosen"),n=e.shiftKey?s.prev():s.next().not(".too-many");n.length||(n=e.shiftKey?t.last():t.first()),a(n);break;case 27:if(u.mode&&e.stopImmediatePropagation(),t=d.find("> li:not(.too-many)"),!t.length)return;t.filter(".chosen").removeClass("chosen"),a(null);break;default:return}e.preventDefault()}),c.on("keyup click paste change",function(t){if(t.which)switch(t.which){case 9:case 16:case 17:case 18:case 220:return}"paste"===t.type?setTimeout(e,0):e()}),d.on("click","li:not(.too-many)",function(){$(this).parent().find("li.chosen").removeClass("chosen"),a($(this))})}var l,d=$("#tabcomplete"),c=($("#tabcomplete-container"),$("#input")),u={"mode":null,"atPos":0,"cursorPos":0,"word":"","originalWord":null,"completionWord":null};r()}window.tabCompleter=function(e,n,i){s(function(e){return t(e,i)})};var n;tabCompleter.onShowUser=function(e){n=e};var i,a={"completionFor":function(e){return e.data("mention-text")},"getCompletionItems":function(t){var s,n=!t.length;s=n?/^\W/:new RegExp("^"+normalizeUserName(t.toLowerCase().replace(/([[\].{}\\+*?^$()|])/g,"\\$1")));var i=(CHAT.RoomUsers.pingableUsersIncludeIncomplete(),Generator(function(e){CHAT.RoomUsers.pingableUsersIncludeIncomplete().forEach(function(t){var i=t.name,a=n?i:normalizeUserName(i);a.match(s)&&shouldShowUser(t.id)&&e({"name":i,"mention":i.replace(/ /g,""),"normalized":a,"id":t.id})})}).groupBy("normalized"));return e(i.toArray(),t)}},o={"completionFor":function(e){return e.data("mention-text")},"getCompletionItems":function(t){return $("#superping-error").text(""),t.length<2?$([]):(i=i||GoodGetter(6e4,400),$("#tabcomplete-container").addClass("superping-searching"),result=i("/users/superping-search?q="+encodeURIComponent(t.substr(1))).pipe(function(s){if($("#tabcomplete-container").removeClass("superping-searching"),s.error)return $("#superping-error").text(s.error),$([]);var n=Generator(s.users).groupBy("normalized").toArray();return n.length||$("#superping-error").text("No user found."),e(n,t,!0)}))},"start":function(){$("#tabcomplete-container").addClass("super-ping")},"stop":function(){$("#tabcomplete-container").removeClass("super-ping"),i&&i.cancel()}}}()