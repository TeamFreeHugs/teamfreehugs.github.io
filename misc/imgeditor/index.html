<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Image Editor</title>
<link rel="stylesheet" type="text/css"
	href="/styles/imgeditor.css"></link>
<link rel="stylesheet" type="text/css"
	href="/styles/menus.css"></link>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="http://teamfreehugs.github.io/js/FileSaver.js"></script>
<script
	src="http://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.5.0/fabric.min.js"></script>
<link rel="stylesheet"
	href="http://t4t5.github.io/sweetalert/dist/sweetalert.css"></link>
<script src="http://t4t5.github.io/sweetalert/dist/sweetalert.min.js"></script>
<script src="/js/min/jQuery.hotkeys.js"></script>
<script>
  var modified = false;
  
  var canvas;
  
  var fgcolor = "#00000";
  
  var bgcolor = "#FFFFFF";
  
  window.onbeforeunload = function() {
    if (modified) {
      return 'WARNING: You have unsaved changes in the drawing. Do you really want to exit?';
    }
  }
  function keyup(event) {
    if ($('#popup').css("display") == "block") {
      if (event.which == 27) {
        $('#popup').css("display", "none");
        $('#backdrop-div').css("display", "none");
      }
    }
  }

  var tool = "#paintMode";
  
  function getImgSize(imgSrc) {
    var newImg = new Image();
    newImg.src = imgSrc;
    curHeight = newImg.height;
    curWidth = newImg.width;
    return {
      w : curWidth,
      h : curHeight
    }
  }

  var current;
  var list = [];
  var state = [];
  var index = 0;
  var index2 = 0;
  var action = false;
  var refresh = true;
  
  function undo() {
    
    if (index <= 0) {
      index = 0;
      return;
    }
    
    if (refresh === true) {
      index--;
      refresh = false;
    }
    
    console.log('undo');
    
    index2 = index - 1;
    current = list[index2];
    current.setOptions(JSON.parse(state[index2]));
    
    index--;
    current.setCoords();
    canvas.renderAll();
    action = true;
  }

  function redo() {
    
    action = true;
    if (index >= state.length - 1) {
      return;
    }
    
    console.log('redo');
    
    index2 = index + 1;
    current = list[index2];
    current.setOptions(JSON.parse(state[index2]));
    
    index++;
    current.setCoords();
    canvas.renderAll();
  }

  function addUndoRedo() {
    canvas.on("object:added", function(e) {
      var object = e.target;
      console.log('object:modified');
      
      if (action === true) {
        state = [ state[index2] ];
        list = [ list[index2] ];
        
        action = false;
        console.log(state);
        index = 1;
      }
      object.saveState();
      
      console.log(object.originalState);
      state[index] = JSON.stringify(object.originalState);
      list[index] = object;
      index++;
      index2 = index - 1;
      
      refresh = true;
    });
    
    canvas.on("object:modified", function(e) {
      var object = e.target;
      console.log('object:modified');
      
      if (action === true) {
        state = [ state[index2] ];
        list = [ list[index2] ];
        
        action = false;
        console.log(state);
        index = 1;
      }
      
      object.saveState();
      
      state[index] = JSON.stringify(object.originalState);
      list[index] = object;
      index++;
      index2 = index - 1;
      
      console.log(state);
      refresh = true;
    });
  }

  function onload() {
    canvas = new fabric.Canvas('canvas', {
      isDrawingMode : true,
    });
    canvas.freeDrawingBrush.color = "red";
    canvas.freeDrawingBrush.width = 5;
    id = window.setInterval(function() {
      canvas.setHeight($(document).height() - 44);
      canvas.setWidth($(document).width() - 200);
    }, 1000);
    
    canvas.on("object:added", function(obj) {
      modified = true;
    })

    addUndoRedo();
    
    modeButtonIds = [ '#paintMode', '#pencilMode', '#eraserMode' ];
    
    $('#exitButton').click(function() {
      window.location = "..";
    });
    $('#saveButton').click(function() {
      $('#popup-body').empty();
      base64 = $('#canvas')[0].toDataURL();
      popup = $('#popup');
      popup.css("display", "block");
      $('#backdrop-div').css("display", "block");
      popupHead = $('#popup-header-text');
      popupHead.html('Save Dialog');
      popupBody = $('#popup-body');
      info = $(document.createElement('span'));
      base64Info = $(document.createElement('span'));
      base64Info.html('Base64 String: ');
      base64Info.attr('title', 'Why? I don\'t know.');
      info.html('How would you like to save it?');
      base64TF = $(document.createElement('textarea'));
      base64TF.val(base64);
      base64TF.css({
        scroll : "none",
        resize : "disabled",
        width : "250px",
        height : "100px"
      });
      downloadInfo = $(document.createElement('span'));
      downloadInfo.html('Or download the image:');
      downloadImage = $(document.createElement('img'));
      downloadImage.attr('src', base64);
      downloadImage.attr('width', $('#canvas')[0].offsetWidth / 10);
      downloadImage.attr('height', $('#canvas')[0].offsetHeight / 10);
      downloadImage.mousedown(function() {
        modified = false;
      })
      popupBody.append(info[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('hr'));
      popupBody.append(base64Info[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(base64TF[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(downloadInfo[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(downloadImage[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('br'));
    });
    
    $('#newLayerLoc')
        .click(
            function() {
              $('#popup-body').empty();
              popup = $('#popup');
              popup.css("display", "block");
              $('#backdrop-div').css("display", "block");
              popupHead = $('#popup-header-text');
              popupHead.html('Add Layer Dialog');
              popupBody = $('#popup-body');
              urlLink = $(document.createElement('input'));
              urlLink.attr('id', 'imgURL');
              urlLink.attr('type', 'text');
              urlLink.css({
                "margin-right" : "7px"
              });
              ok = $(document.createElement('button'));
              ok.html('Add Layer!');
              ok.attr('class', 'button');
              info = $(document.createElement('span'));
              info
                  .html('Add a layer to this image. <br>Link an image\' url in the box below');
              ok.click(function() {
                fabric.Image.fromURL(urlLink.val(), function(img) {
                  o = getImgSize(urlLink.val());
                  canvas.add(img);
                  canvas.renderAll();
                });
                $('#backdrop-div').click();
              });
              popupBody.append(info[0]);
              popupBody.append(urlLink[0]);
              popupBody.append(ok[0]);
            });
    
    $('#backdrop-div').click(function() {
      $('#popup').css("display", "none");
      $('#backdrop-div').css("display", "none");
    });
    $(document).keyup(keyup);
    
    //$(document).on('contextmenu', function() {
    //  return false;
    //});
    
    modeButtonIds.forEach(function(e) {
      $(e).click(function(event) {
        a = event;
        modeButtonIds.forEach(function(e2) {
          if (e2 == '#' + event.originalEvent.target.id) {
            $(e2).addClass('activeTool');
            tool = e2;
          } else {
            $(e2).removeClass('activeTool');
          }
        })
      })
    });
    
    $('#eraserMode').click(function() {
      
    });
    
    $('#canvas').css({
      left : "0px",
      top : "44px"
    });
    
    $('.upper-canvas').css({
      left : "0px",
      top : "44px"
    });
    
    $('.canvas-container').attr('style', '');
   
    
  }
</script>
<script>
  
</script>
</head>
<body onload="onload()">
	<div id="menubar" style="top: 0px; left: 0px; position: fixed;"
		class="menu-wrap">
		<ul class="horizontalList menu">
			<li><a href="#">File</a>
				<ul class="menu menuExpand">
					<li><a href="#">New Image(Hover for more options)</a>
						<ul class="menu menuExpand">
							<li><a href="#" id="newImgTemplate">New Image</a></li>
							<li><a href="#" id="newImgLoc">New Image From Location</a>
						</ul></li>
					<li><a href="#" id="saveButton">Save</a></li>
					<li><a href="#" id="deleteAllButton">Delete Image</a></li>
					<li><a href="#" id="exitButton">Exit</a></li>
				</ul></li>
			<li><a href="#">Layers</a>
				<ul class="menu menuExpand">
					<li><a href="#" id="newLayerLoc">Add Layer From Location</a></li>
				</ul></li>
		</ul>
	</div>
	<div id="canvas-div">
		<canvas id="canvas" class="canvas"></canvas>
	</div>
	<div id="toolbar-div" class="toolbar">
		<button class="toolbarButton activeTool"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/paintbrush.svg');"
			id="paintMode" title="Paintbrush"></button>
		<button class="toolbarButton"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/pencil.svg');"
			id="pencilMode" title="Pencil"></button>
		<button class="toolbarButton"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/eraser.svg');"
			id="eraserMode" title="Eraser"></button>
	</div>
	<div id="backdrop-div"
		style="width: 1000%; height: 1000%; z-index: 20000; background-color: #000000; opacity: 0.3; top: 0; left: 0; position: fixed; display: none"></div>
	<div id="popup" class="popup-box" style="display: none;">
		<div id="popup-header" class="popup-header">
			<h3 id="popup-header-text">Header</h3>
		</div>
		<div id="popup-body" class="popup-body">Text</div>
	</div>
</body>
</html>