<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Image Editor</title>
<link rel="stylesheet" type="text/css"
	href="file:///home/eyeballcode/Eclipse/Workspace/Eclipse/HTML/styles/imgeditor.css"></link>
<link rel="stylesheet" type="text/css"
	href="http://teamfreehugs.github.io/styles/menus.css"></link>
<script src="http://code.jquery.com/jquery-1.11.3.min.js"></script>
<script src="http://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<script src="http://teamfreehugs.github.io/js/FileSaver.js"></script>
<script>
  var modified = false;
  
  var currentMode = 0;
  
  var paint = false;
  
  var color = "#00000";
  
  var clickX = new Array();
  var clickY = new Array();
  var clickDrag = new Array();
  var paint = false;
  
  function addClick(x, y, dragging) {
    clickX.push(x);
    clickY.push(y);
    clickDrag.push(dragging);
  }

  window.onbeforeunload = function() {
    if (modified) {
      return 'WARNING: You have unsaved changes in the drawing. Do you really want to exit?';
    }
  }
  function keyup(event) {
    if ($('#popup').css("display") == "block") {
      if (event.which == 27) {
        $('#popup').css("display", "none");
        $('#backdrop-div').css("display", "none");
      }
    }
  }

  function redraw() {
    context = document.getElementById('canvas').getContext('2d');
    context.clearRect(0, 0, context.canvas.width, context.canvas.height);
    
    context.strokeStyle = color;
    context.lineJoin = "round";
    context.lineWidth = 1;
    
    for (var i = 0; i < clickX.length; i++) {
      context.beginPath();
      if (clickDrag[i] && i) {
        context.moveTo(clickX[i - 1], clickY[i - 1]);
      } else {
        context.moveTo(clickX[i] - 1, clickY[i]);
      }
      context.lineTo(clickX[i], clickY[i]);
      context.closePath();
      context.stroke();
    }
  }

  function getMousePos(canvas, evt) {
    var rect = canvas.getBoundingClientRect(), root = document.documentElement;
    
    var mouseX = evt.clientX - rect.left - root.scrollLeft;
    var mouseY = evt.clientY - rect.top - root.scrollTop;
    return {
      x : mouseX,
      y : mouseY
    };
  }


  var tool = "#paintMode";
  
  var modeButtonIds = [ '#paintMode', '#pencilMode', '#eraserMode' ];
  
  function onload() {
    $('#exitButton').click(function() {
      window.location = "..";
    });
    $('#saveButton').click(function() {
      $('#popup-body').empty();
      base64 = $('#canvas')[0].toDataURL();
      popup = $('#popup');
      popup.css("display", "block");
      $('#backdrop-div').css("display", "block");
      popupHead = $('#popup-header-text');
      popupHead.html('Save Dialog');
      popupBody = $('#popup-body');
      popupBody.html('');
      info = $(document.createElement('span'));
      base64Info = $(document.createElement('span'));
      base64Info.html('Base64 String: ');
      base64Info.attr('title', 'Why? I don\'t know.');
      info.html('How would you like to save it?');
      base64TF = $(document.createElement('textarea'));
      base64TF.val(base64);
      base64TF.css({
        scroll : "none",
        resize : "disabled",
        width : "250px",
        height : "100px"
      });
      downloadInfo = $(document.createElement('span'));
      downloadInfo.html('Or download the image:');
      downloadImage = $(document.createElement('img'));
      downloadImage.attr('src', base64);
      downloadImage.attr('width', $('#canvas')[0].offsetWidth / 10);
      downloadImage.attr('height', $('#canvas')[0].offsetHeight / 10);
      popupBody.append(info[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('hr'));
      popupBody.append(base64Info[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(base64TF[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(downloadInfo[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(downloadImage[0]);
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('br'));
      popupBody.append(document.createElement('br'));
    });
    
    $('#backdrop-div').click(function() {
      $('#popup').css("display", "none");
      $('#backdrop-div').css("display", "none");
    });
    $(document).keyup(keyup);
    
    $('#canvas').mousedown(function(e) {
      if (e.which == 1) {
        var mouseX = e.pageX - this.offsetLeft;
        var mouseY = e.pageY - this.offsetTop;
        modified = true;
        paint = true;
        addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop);
        redraw();
      }
    });
    
    $('#canvas').mousemove(function(e) {
      if (e.which == 1) {
        if (paint) {
          modified = true;
          addClick(e.pageX - this.offsetLeft, e.pageY - this.offsetTop, true);
          redraw();
        }
      }
    });
    $('#canvas').mouseup(function(e) {
      paint = false;
    });
    
    $('#canvas').mouseleave(function(e) {
      paint = false;
    });
    
    $(document).on('contextmenu', function() {
      return false;
    });
    
    modeButtonIds.forEach(function(e) {
      $(e).click(function(event) {
        a = event;
        modeButtonIds.forEach(function(e2) {
          if (e2 == '#' + event.originalEvent.target.id) {
            $(e2).addClass('activeTool');
            tool = e2;
          } else {
            $(e2).removeClass('activeTool');
          }
        })
      })
    });
    
  }
</script>
<script>
  
</script>
</head>
<body onload="onload()">
	<div id="menubar" style="top: 0px; left: 0px; position: fixed;"
		class="menu-wrap">
		<ul class="horizontalList menu">
			<li><a href="#">File</a>
				<ul class="menu menuExpand">
					<li><a href="#">New Image(Hover for more options)</a>
						<ul class="menu menuExpand">
							<li><a href="#" id="newImgTemplate">New Image</a></li>
							<li><a href="#" id="newImgLoc">New Image From Location</a>
						</ul></li>
					<li><a href="#" id="saveButton">Save</a></li>
					<li><a href="#" id="deleteAllButton">Delete Image</a></li>
					<li><a href="#" id="exitButton">Exit</a></li>
				</ul></li>
		</ul>
	</div>
	<div id="canvas-div">
		<canvas id="canvas" class="canvas"></canvas>
	</div>
	<div id="toolbar-div" class="toolbar">
		<button class="toolbarButton activeTool"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/paintbrush.svg');"
			id="paintMode" title="Paintbrush"></button>
		<button class="toolbarButton"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/pencil.svg');"
			id="pencilMode" title="Pencil"></button>
		<button class="toolbarButton"
			style="background-image: url('http://teamfreehugs.github.io/misc/imgeditor/images/toolbar/eraser.svg');"
			id="eraserMode" title="Eraser"></button>
	</div>
	<div id="backdrop-div"
		style="width: 1000%; height: 1000%; z-index: 20000; background-color: #000000; opacity: 0.3; top: 0; left: 0; position: fixed; display: none"></div>
	<div id="popup" class="popup-box" style="display: none;">
		<div id="popup-header" class="popup-header">
			<h3 id="popup-header-text">Header</h3>
		</div>
		<div id="popup-body" class="popup-body">Text</div>
	</div>
</body>
</html>